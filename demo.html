<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Vesper Demo 0.1</title>


<!-- loading stylesheets before javascript is meant to be quicker -->
<!-- https://developers.google.com/speed/docs/best-practices/rtt#PutStylesBeforeScripts -->
<link rel="stylesheet" href="allVis.css" type="text/css" />
<link rel="stylesheet" href="tree.css" type="text/css" />
<link rel="stylesheet" href="timeline.css" type="text/css" />
<link rel="stylesheet" href="helper.css" type="text/css" />
<link rel="stylesheet" href="../lib/leafletjs/leaflet.css" />
<link rel="stylesheet" href="../lib/leafletjs/plugins/MarkerCluster.css" />
<link rel="stylesheet" href="../lib/leafletjs/plugins/MarkerCluster.Default.css" />

<!-- D3's includes -->
<script type="text/javascript" src="../lib/d3/d3.v3.js"></script>

<!-- JQuery's includes -->
<script type="text/javascript" src="../lib/jquery/jquery-2.0.2.js"></script>
<script type="text/javascript" src="../lib/jquery-ui/jquery-ui.js"></script>

<!-- Underscore include -->
<script type="text/javascript" src="../lib/underscore/underscore.js"></script>

<!-- Modernizr include -->
<script type="text/javascript" src="../lib/modernizr/modernizr-latest.js"></script>

<!-- IndexedDBShim include -->
<!-- <script type="text/javascript" src="../lib/indexedDBShim/IndexedDBShim.js"></script> -->
<script type="text/javascript" src="../lib/jquery-indexeddb/jquery.indexeddb.js"></script>

<!-- Martin's includes -->
<script type="text/javascript" src="../lib/napier/napVisLib.js"></script>
<script type="text/javascript" src="../lib/napier/adaptedD3.js"></script>
<script type="text/javascript" src="../lib/napier/MVCCoord.js"></script>
<script type="text/javascript" src="vesper.js"></script>
<script type="text/javascript" src="dwcaParse.js"></script>
<script type="text/javascript" src="dwcaHelper.js"></script>
<script type="text/javascript" src="DWCAZipParse.js"></script>
<!--
<script type="text/javascript" src="partition_vis.js"></script>
<script type="text/javascript" src="sunburst_vis.js"></script>
-->
<script type="text/javascript" src="taxonomy_vis.js"></script>
<script type="text/javascript" src="occList.js"></script>
<script type="text/javascript" src="timeline.js"></script>
<script type="text/javascript" src="dwcaDataTable.js"></script>
<script type="text/javascript" src="sanity.js"></script>
<script type="text/javascript" src="../lib/jszip/jszip.js"></script>
<script type="text/javascript" src="../lib/jszip/jszip-inflate.js"></script>
<script type="text/javascript" src="../lib/jszip/jszip-load.js"></script>
<script type="text/vbscript" src="../lib/napier/iedataload.vbs"></script>

<script type="text/javascript" src="dwcaMapLeaflet.js"></script>
<script type='text/javascript' src="../lib/leafletjs/leaflet.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/leaflet.markercluster-src.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/heatcanvas-leaflet.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/heatcanvas.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/heatcanvas-worker.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/quadCanvas/QuadTree.js"></script>
<script type='text/javascript' src="../lib/leafletjs/plugins/quadCanvas/L.TileLayer.MaskCanvas.js"></script>


</head>

<body>

<H1>Vesper Demo</H1>

<div id="chooseFileDiv" class="choiceHolder">
</div>

<div id="loadStatDiv">
    <p id="notifyStatusID"></p>
</div>

<div id="selDiv" style="display: none;" class="selectionWrapper">
    <div id="basicSelectDiv" class="leftColumn">
        <span id="filenamePlaceholder" class="filenameLabel"></span>
        <br>
        <span id="filesizePlaceholder" class="filesizeLabel"></span>
        <hr>
        <div id="showOnZipLoadDiv">
            <div id="labelSelectDiv">
                <h4 class="notoppad">Item Label Field</h4>
            </div>
            <hr>
            <div id="dynamicSelectDiv"><h4 class="notoppad">Vis Options</h4></div>
            <hr>
            <span id="advRevealPlaceholder"></span>
            <!-- <button type="button" id="advRevealButton" class="load">Show Advanced Options</button> -->
            <div id="advancedSelectDiv" style="display:none;">
                <button type="button" id="allButton" class="selButtonStyle">Select All Fields</button>
                <button type="button" id="clearButton" class="selButtonStyle">Clear All Fields</button>
            </div>
            <hr>
            <button type="button" id="loadButton" class="load">Load</button>
        </div>
    </div>

    <div id="listDiv" class="fullWidthHolder" style="display:none;"></div>
</div>

<div id="buttonVisDiv" style="display: none;"></div>

<div id="allVisDiv" style="margin: 0 auto; width: 90%; position: relative; clear: both; overflow: hidden; display: none;">

</div>



<!--   <div style="width: 100%; clear: both;"></div> -->

 <script type="text/javascript">

 (function () {

        var visCount = 0;
         var files = [
            {name:"ENA", file:"../data/ena2.zip"} , {name:"GermanSL", file:"../data/germanSLfless.zip"} ,
            {name:"VAScan", file:"../data/dwca-vascan.zip"}, {name:"MT Specimens", file:"../data/dwca-mt-specimens.zip"},
            {name:"HIBG Specimens", file:"../data/dwca-hibg-specimens.zip"}
         ];
         var nameLabelField = {result: null};

         var visChoiceData = [
             {title:"Implicit Taxonomy", attList: VESPER.DWCAParser.neccLists.impTaxonomy, matchAll: true, image: "img/tree.png", height: "600px",
                newVisFunc: function (div) { return new Tree (div);},
                setupFunc: function (coreFieldIndex) {return {"identifyingField":coreFieldIndex["id"],"childField":VESPER.DWCAParser.TAXA, "nameField":coreFieldIndex[nameLabelField.result], "rankField":coreFieldIndex["taxonRank"]}}
              },
             {title:"Explicit Taxonomy", attList: VESPER.DWCAParser.neccLists.expTaxonomy, matchAll: true, image: "img/tree.png", height: "600px",
                 newVisFunc: function (div) { return new Tree (div);},
                 setupFunc: function (coreFieldIndex) {return {"identifyingField":coreFieldIndex["id"],"childField":VESPER.DWCAParser.TAXA, "nameField":coreFieldIndex[nameLabelField.result], "rankField":coreFieldIndex["taxonRank"]}}
             },
             {title:"Map", attList: VESPER.DWCAParser.neccLists.geo, matchAll: true, image: "img/world.png", height: "400px",
                 newVisFunc: function (div) { return new DWCAMapLeaflet (div);},
                 setupFunc: function (coreFieldIndex) {return {"identifyingField":coreFieldIndex["id"], "latitude":coreFieldIndex["decimalLatitude"], "longitude":coreFieldIndex["decimalLongitude"], "nameField":coreFieldIndex[nameLabelField.result]}}
             },
             {title:"Timeline", attList: VESPER.DWCAParser.neccLists.basicTimes, matchAll: true, image: "img/geo.png", height: "200px",
                 newVisFunc: function (div) { return new TimeLine (div);},
                 setupFunc: function (coreFieldIndex) { return {"identifyingField":coreFieldIndex["id"], "dateField":coreFieldIndex["eventDate"], "nameField":coreFieldIndex[nameLabelField.result]}}
             },
             {title:"Sanity Check", attList: VESPER.DWCAParser.neccLists.impTaxonomy, matchAll: false, image: "img/geo.png", height: "400px",
                 newVisFunc: function (div) { return new Sanity (div);},
                 setupFunc: function (coreFieldIndex) { return undefined; }
             }
         ];
         var visTiedToSpecificAttrs = visChoiceData.slice (0, 4);


         var curMetaData, curStruc;


         function setChoices (choiceData) {
             var choices = d3.select("#chooseFileDiv").selectAll("span").data (choiceData);
             choices.enter()
                 .append ("button")
                 .attr ("class", "choice")
                 .attr ("type", "button")
                 .attr ("id", function(d) { return d.name;})
                 .text (function(d) { return d.name; })
                 .on ("click", function(d) {
                    NapVisLib.xhr2 (d.file, 'text/plain; charset=x-user-defined', asyncMethod);
                    DWCAHelper.divDisplay(["#showOnZipLoadDiv"], "none");
                    DWCAHelper.divDisplay(["#selDiv"], "block");
                    d3.select("#filenamePlaceholder").html(d.name);
                    d3.select("#filesizePlaceholder").html("...");
                    d3.select("#dynamicSelectDiv").selectAll("span input").property("checked", false);
                 })
             ;
         }

        function setVisChoices (data) {
             var visChoices = d3.select("#buttonVisDiv").selectAll("button").data (data);
             visChoices.enter()
                 .append ("button")
                 .attr ("class", "visChoice")
                 .attr ("type", "button")
                 .attr ("id", function(d) { return d.title;})
                 .text (function(d) { return d.title; })
                 .on ("click", function(d) {
                     makeVis (d);
                     return false;
                 })
             ;
         }


         function setPresets (visboxes, radioChoices) {
             var checkListParent = d3.select("#listDiv");

             var bdiv = d3.select("#dynamicSelectDiv");
             for (var n = 0; n < visboxes.length; n++) {
                 var data = visboxes[n];
                 var spanSelection = DWCAHelper.addCheckbox (bdiv, data, "fieldGroup");
                 DWCAHelper.configureCheckbox (spanSelection, checkListParent, data.attList);
             }

             var ldiv = d3.select ("#labelSelectDiv");
             for (var n = 0; n < radioChoices.length; n++) {
                 var data = radioChoices[n];
                 var elem = DWCAHelper.addRadioButton (ldiv, data, "nameChoice", "nameChoice", true);
                 DWCAHelper.configureRadioButton (elem, checkListParent, nameLabelField);
             }

             DWCAHelper.addHelperButton (d3.select("#advancedSelectDiv"), checkListParent, "Remove Verbose Fields", VESPER.DWCAParser.flabbyLists.wordyList, false, null, "selButtonStyle listCon");
             var excepFunc = function exceptionFunc (d, i) { return i == 0; };
             d3.select("#allButton").on("click", function(d) { DWCAHelper.setAllFields (checkListParent, true, undefined, excepFunc); return false; });
             d3.select("#clearButton").on("click", function(d) { DWCAHelper.setAllFields (checkListParent, false, undefined, excepFunc); return false;});
             var advSelFunc = function (d) {
                 var val = d3.select(this).property("checked") ? "block" : "none";
                 DWCAHelper.divDisplay(["#advancedSelectDiv", "#listDiv"], val);
                 return false;
             };
             var advCheckbox = DWCAHelper.addCheckbox (d3.select("#advRevealPlaceholder"), {title:"Advanced Options", image: null}, "showAdv");
             advCheckbox.select("input").on("click", advSelFunc);
         }

         setChoices (files);
         setVisChoices (visChoiceData);
         setPresets (visTiedToSpecificAttrs, VESPER.DWCAParser.labelChoiceData);


         function makeVis (details) {
             var pdiv = d3.select ("#allVisDiv");
             var newDiv = pdiv.append("div").attr("class", "visWrapper").style("float", "left").style("width", "50%");
             newDiv.append("h3").text(details.title);
             var id = "v"+visCount;
             var indVisDiv = newDiv.append("div").attr("class", "vis").attr("id", id).style("height", details.height);

             var coreType = curMetaData.coreRowType;
             var fileData = curMetaData.fileData;
             var coreFieldIndex = fileData[coreType].filteredFieldIndex;
             var nameField = coreFieldIndex[nameLabelField.result];
             visCount++;

             var newVis = details.newVisFunc ("#"+id);
             newVis.set (details.setupFunc (coreFieldIndex), curMetaData);
             DWCAHelper.getMVC().addVis (newVis);
             newVis.go (curStruc.data, curStruc.root);
         }

         function proceed (zip, mdata) {
             var selectedStuff = DWCAHelper.getAllSelectedFilesAndFields (d3.select("div#selDiv"));
             var fileRows = {};
             function notifyFunc (str, obj) {
                 d3.select("#notifyStatusID").html(str+":"+obj);
                 d3.select("#loadStatDiv").attr("offsetWidth");
             }
             //DWCAZipParse.setNotifyFunc (notifyFunc);

             // read selected data from zip
             $.each (selectedStuff, function (key, value) {
                 var fileData = mdata.fileData[key];
                 var fileName = fileData.fileName;
                 var readFields = [];
                 for (var i = 0; i < fileData.invFieldIndex.length; i++) {
                     readFields[i] = false;
                 }

                 $.each (value, function (key, value) {
                    readFields [+key] = value;
                 });

                 console.log ("readFields", readFields);
                 VESPER.DWCAZipParse.set (fileData, readFields);
                 zip.zipEntries.readLocalFile (fileName, VESPER.DWCAZipParse.zipStreamSVParser2);
                 fileRows[fileData.rowType] = zip.zipEntries.getLocalFile(fileName).uncompressedFileData;
                 console.log ("frows", fileName, fileRows[fileData.rowType]);
                 VESPER.DWCAParser.updateFilteredLists (fileData, readFields);
             });

             if (VESPER.alerts) { alert ("mem monitor point 1"); }

             // make taxonomy (or list)
             var treeStruc = VESPER.DWCAParser.setupStrucFromRows (fileRows, mdata);
             curStruc = treeStruc;
             curMetaData = mdata;
             if (VESPER.alerts) { alert ("mem monitor point X"); }

             DWCAHelper.divDisplay(["#selDiv"], "none");
             DWCAHelper.divDisplay(["#buttonVisDiv"], "block");
             DWCAHelper.divDisplay(["#allVisDiv"], "block");

             function showButtons () {
                 var visChoices = d3.select("#buttonVisDiv").selectAll("button.visChoice");
                 console.log ("VC", visChoices);
                 visChoices.style("display", function(d) {
                     var fileData = mdata.fileData;
                     var indices = VESPER.DWCAParser.findFields (fileData, d.attList, "filteredFieldIndex");
                     var nullCount = NapVisLib.countNulls (indices);
                     console.log (d.title, nullCount);
                     return (d.matchAll && nullCount === 0) || (!d.matchAll && nullCount < indices.length)
                             ? "block" : "none"
                     ;
                 })
             }
             showButtons();

             if (window.opera) {
                 window.opera.collect();
             }
            //DWCAHelper.initViews (views, treeStruc);
         }


         var asyncMethod = function (xhr) {
            // var textLoaded = xhr && xhr.responseText
             NapVisLib.showProps (xhr);
             var textLoaded = NapVisLib.getText (xhr);
             d3.select("#filesizePlaceholder").html("zipped: "+(textLoaded.length | textLoaded.byteLength)+" bytes");

             if (VESPER.alerts) { alert ("check memory use in task manager"); }
             var accessZip = VESPER.DWCAParser.accessZip (textLoaded, "meta.xml");
             var metaData = accessZip.meta;
             var zip = accessZip.jszip;

             DWCAHelper.makeFieldSelectionBoxes (metaData, d3.select("#listDiv"));  // Makes checkboxes for all fields (normally hidden)
             d3.select("#loadButton").on("click", null).on("click", function(d) { proceed (zip, metaData); return false;});

             var checkBoxParentSelection = d3.select("#listDiv");
             var visCheckBoxGroup = d3.selectAll("span.fieldGroup");
             visCheckBoxGroup
                .property ("checked", false)
                .style ("display", function(d) {
                var poss = DWCAHelper.fieldListExistence (checkBoxParentSelection, d.attList, d.matchAll);
                return poss ? null : "none";
             });

             var nameChoiceGroup = d3.selectAll("label.nameChoice");
             nameChoiceGroup
                 .property ("checked", false)
                 .style ("display", function(d) {
                 var poss = DWCAHelper.fieldListExistence (checkBoxParentSelection, [d], true);
                 return poss ? null : "none";
             });

             var first = true;
             nameChoiceGroup.each (function(d) {
                 var disp = d3.select(this).style ("display");
                 if (disp != "none" && first) {
                     first = false;
                     // this is cross-browser
                     var click_ev = document.createEvent("MouseEvent");
                     click_ev.initEvent("click", true /* bubble */, true /* cancelable */);
                     this.dispatchEvent(click_ev);
                     //this.click(); // this wasn't (didn't work in safari)
                 }
             });

             DWCAHelper.divDisplay (["#showOnZipLoadDiv"], "block");
         };
 }());

 </script>

</body>
</html>