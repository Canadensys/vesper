/*! vespertemp 2014-02-04 */
!function(){var a={};a.alerts=!1,a.logRun=!1,a.log=function(){a.logRun&&Function.prototype.apply.call(console.log,console,arguments)},a.imgbase="../img/",a.log(a),"function"==typeof define&&define.amd?define(a):"object"==typeof module&&module.exports?module.exports=a:this.VESPER=a}(),VESPER.DWCAZipParse=new function(){var a,b,c,d,e,f,g,h,i,j,k,l,m="\\".charCodeAt(0),n=[],o=[],p=[],q=0,r=[],s=[],t=0;return this.rowReader2=function(a){for(var b,d=0,e=0,f=0,i=j[d],l=[],r=a.length,u=!1,v=!1,w=0;r>w;w++){var x=a[w];if(b=x?x:0,g&&!v&&b===h&&(u=!u),!u&&(b===c||w===r-1)){if(i){if(f=w+(b===c?0:1),g&&(a[e]===h&&e++,a[f-1]===h&&f--),e===f)l.push(n[d]);else{var y=String.fromCharCode.apply(null,a.slice(e,f)),z=o[d],A=p[d];if(z){var B=z[y];B?(y=null,y=B):(z[y]=y,VESPER.log("new entry for field",d,"at lineNo",k,":",y,y.length))}else if(A){var B=s[A][y];B?(y=null,y=B):s[A][y]=y}t+=f-e,l.push(y)}b===c&&w===r-1&&l.push(n[d])}d++,i=j[d]|!1,e=w+1}v=b===m}if(k++,(k%1e4===0||10998===k)&&VESPER.log(k,": ",l),k%100===0){var C=MGNapier.NapVisLib.makeTime();C-q>1e3&&(q=C,VESPER.log(k,": ",l))}return l},this.zipStreamSVParser2=function(b){function c(a,b,c){var g=e===a;if(1===f)return g;if(g){if(c+f<=b.length){for(var h=d.length;--h>=1;)if(d.charCodeAt(h)!==b[c+h])return!1;return n+=d.length-1,!0}B=j-n,n=j,o=void 0}return!1}function i(){for(var d=MGNapier.NapVisLib.makeTime();MGNapier.NapVisLib.makeTime()-d<D&&(j=b(u,B,r-B))>0;){j+=B;var e=0;if(B=0,A){var f=String.fromCharCode(u[0])+String.fromCharCode(u[1])+String.fromCharCode(u[2]);VESPER.log("possbom [",f,"]"),"ï»¿"===f&&(VESPER.log("UTF8 bytemark detected"),e=3),A=!1}for(n=e;j>n;n++){if(o=u[n],o>=128)if(o>=194&&224>o)j-1>n?o=((31&o)<<6)+(63&u[++n]):(B=1,n=j,o=void 0);else if(o>=224&&240>o)j-2>n?o=((255&o)<<12)+((63&u[++n])<<6)+(63&u[++n]):(B=j-n,n=j,o=void 0);else if(o>=240&&245>o)if(j-3>n){var q=((7&o)<<18)+((63&u[++n])<<12)+((63&u[++n])<<6)+(63&u[++n]);q-=65536;var E=(1023&q)+56320;o=E.charAt[0],p=E.charAt[1]}else B=j-n,n=j,o=void 0;g&&!y&&o===h?(z=!z,v.push(o)):!z&&c(o,u,n)?(w.push(x>=a.ignoreHeaderLines?VESPER.DWCAZipParse.rowReader2(v):void 0),x++,v.length=0):void 0!==o&&(v.push(o),void 0!==p&&(v.push(p),p=void 0)),y=o===m}if(B)for(var F=0;B>F;F++)u[F]=u[j-B+F]}if(l&&l(VESPER.DWCAZipParse.zipStreamSVParser2.fileName,k),j>0)setTimeout(i,1);else{v.length>0&&w.push(VESPER.DWCAZipParse.rowReader2(v)),C=MGNapier.NapVisLib.makeTime()-C,VESPER.log("Time: ",C/1e3," secs."),VESPER.log("Shared Maps: "+s.length+", "+MGNapier.NapVisLib.countObjProperties(s[1])),VESPER.log("pulled out "+t+" characters from zip"),s.length=0;var G=VESPER.DWCAZipParse.zipStreamSVParser2.callbackQ;VESPER.log("callback queue length",G.length);for(var H=G.length;--H>=0;)G[H](w)}}VESPER.alerts&&alert("start partial parse with charcodes");var j,n,o,p,r=1024,u=new Array(r),v=[],w=[],x=0,y=!1,z=!1,A=!0,B=0,C=MGNapier.NapVisLib.makeTime();q=C;var D=200;setTimeout(i,1)},this.setNotifyFunc=function(a){l=a},this.set=function(l,m){a=l,b=l.fieldsTerminatedBy.replace("\\t","	").replace("\\n","\n"),d=l.linesTerminatedBy.replace("\\t","	").replace("\\n","\n").replace("\\r","\r"),g=l.fieldsEnclosedBy.replace('\\"','"'),j=m,i=j.indexOf(!0),c=b.charCodeAt(0),e=d.charCodeAt(0),h=g?g.charCodeAt(0):-1,f=d.length,k=0,VESPER.log(VESPER.DWCAParser.sharedValuesTerms),s.length=0;for(var q=0;q<l.invFieldIndex.length;q++){var t=l.invFieldIndex[q],u=l.fieldData[t];n[q]=u?u.default:void 0,o[q]=u?u.discreteTermList:void 0,p[q]=VESPER.DWCAParser.sharedValuesTerms[t],p[q]&&(s[p[q]]={})}r.length=0;for(var v=0;256>v;v++)r.push(String.fromCharCode(v));VESPER.log("readFields",j),VESPER.log("Q#",g,"#")},this},VESPER.BarChart=function(a){function b(){f=l.chunkInfo(m,m.getData(),p),l.childScale.domain(f.extremes),VESPER.log("bin data",f.extremes,f)}var c,d,e=d3.svg.axis();this.format=void 0,this.barClass="countBin",this.childScale=d3.scale.linear();var f,g,h=d3.scale.log(),i=h,j=[void 0,void 0],k=MGNapier.NapVisLib.rangeSlider();k.tooltipTemplates({min:function(a,b){return $.t("barChart.minPrefix")+l.wrapDataType(l.makeToNearest(b.invert(a[0])))},max:function(a,b){return $.t("barChart.maxPrefix")+l.wrapDataType(l.makeToNearest(b.invert(a[1])))},bar:function(){return null}});var l,m,n=500,o=500,p={},q={left:40,right:20,top:15,bottom:40};this.minBarWidth=5,this.toNearest=1,this.divisions=[1,2,10,100];var r=function(a){var b=d[1]-q.bottom;a.attr("x",function(a){return l.childScale(a.start)}).attr("width",function(a){return l.childScale(a.end)-l.childScale(a.start)}).attr("y",function(a){return i(a.count+1)}).attr("height",function(a){return b-i(a.count+1)}).style("opacity",1)};this.set=function(b,c){p.keyField=c.makeIndices([b.identifyingField])[0],p.dateField=c.makeIndices([b.dateField])[0],p.realField=c.makeIndices([b.realField])[0],d=MGNapier.NapVisLib.getWidthHeight(d3.select(a).node()),m=c},this.go=function(){l=this,d3.select(a).style("overflow","hidden");var e=d3.select(a).selectAll("svg").data([0]);e.enter().append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),e=d3.select(a).select("svg"),c=e.append("svg:g").attr("class","treeSVG");var h=d3.select(a).select(".visControl"),i=a.substring(1);if(h.empty()){var m=d3.select(a).append("div").attr("class","visControl").attr("id",i+"Controls");VESPER.DWCAHelper.addDragArea(m),MGNapier.NapVisLib.makeSectionedDiv(m,[{header:$.t("barChart.typeLabel"),sectionID:"Totals"}],"section");var n={Interval:l.uncalcCumulative,Cumulative:l.calcCumulative},o=m.select(a+"ControlsTotals").selectAll("span.fieldGroup").data(d3.entries(n),function(a){return a.key});o.enter().append("span").attr("class","fieldGroup"),o.append("input").attr("type","radio").attr("id",function(a){return i+a.key}).attr("name","chartYType").property("checked",function(a){return"Interval"===a.key}).on("change",function(a){for(var b=[f.bins,g.bins],d=["unselected","selected"],e=0;e<b.length;e++)a.value(b[e]),l.redraw(c.selectAll("."+l.barClass+"."+d[e]).data(b[e],function(a){return Math.floor(a.start)}),b[e])}),o.append("label").attr("for",i+"count").text(function(a){return a.key}),$(a+"Controls").draggable()}l.childScale.range([q.left,d[0]-q.right]),b();var p=e.select("g.rangeHolder");p.empty()&&e.append("g").attr("class","rangeHolder").attr("transform","translate(0,"+(d[1]-20)+")"),p=e.select("g.rangeHolder"),k(p),k.scale(l.childScale).dragEndFunc(function(a,c){j=[l.wrapDataType(l.makeToNearest(c.invert(a[0]))),l.wrapDataType(l.makeToNearest(c.invert(a[1])))],b(),l.update()}).update(),l.update()},this.makeToNearest=function(a){return Math.round(a/l.toNearest)*l.toNearest},this.update=function(){g=l.chunkInfo(m,m.getData(),p,function(a){return m.getSelectionModel().contains(a)});var a=f.bins;VESPER.log("Selection bins",g);var b=d3.max(a,function(a){return a.count+1});VESPER.log("Max height",b);var e=d[1]-q.bottom;i.domain([1,b]).range([e,q.top]).nice();var h=c.select("g.valueAxis");h.empty()&&(h=c.append("g").attr("class","valueAxis vesperAxis").attr("transform","translate (0,"+(d[1]-q.bottom)+")")),h.call(d3.svg.axis().scale(l.childScale).orient("bottom").tickFormat(l.format));for(var j=[a,g.bins],k=["unselected","selected"],s=0;s<j.length;s++){VESPER.log("bins",j[s]);var t=l.barClass,u=c.selectAll("."+t+"."+k[s]).data(j[s],function(a){return Math.floor(a.start)});u.exit().on("mouseout",null).on("mouseover",null).on("contextmenu",null),u.exit().remove(),l.redraw(u,j[s]);var v=u.empty()?0:n;u.enter().append("svg:rect").attr("class",t+" "+k[s]).style("opacity",0).on("contextmenu",function(a){m.getSelectionModel().clear();var b=l.returnMatches(m,p,a.start,a.end);m.getSelectionModel().addAllToMap(b),d3.event.preventDefault()}).on("mouseover",function(a){d3.select(this).classed("highlight",!0);var b=d3.select(this).classed("selected");VESPER.tooltip.updateText($.t("barChart."+(b?"allLabel":"selLabel")),l.makeTitle(a)),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).classed("highlight",!1),VESPER.tooltip.setToFade()}).transition().delay(v).duration(o).call(r)}},this.redraw=function(a){var b=d[1]-q.bottom;i.range([b,q.top]).nice();var f=c.select("g.countAxis");f.empty()&&(f=c.append("g").attr("class","countAxis vesperAxis").attr("transform","translate ("+(q.left-1)+",0)")),f.call(e.scale(i).orient("left").ticks(5,d3.format(",d"))),a.transition().duration(n).call(r)},this.makeTitle=function(){},this.updateVals=this.update,this.chunkInfo=function(a,b,c,d){function e(){if(!n||!o)for(var d in b)if(b.hasOwnProperty(d)){var e=i.getVal(a,b,d,c);if(void 0!==e){e=i.wrapDataType(e,d);var f=i.unwrapDataType(e);q++,!n&&(void 0===k||g>f)&&(k=e,g=i.unwrapDataType(k)),!o&&(void 0===m||f>h)&&(m=e,h=i.unwrapDataType(m))}}}function f(){for(var e in b)if(b.hasOwnProperty(e)&&(!d||d(e,b))){var f=i.getVal(a,b,e,c);if(void 0!==f&&(f=i.unwrapDataType(i.wrapDataType(f,e)),!isNaN(f)&&f>=r)){var g=Math.floor((f-x)/v);g>=0&&w>=g&&p[g].count++}}}var g,h,i=l,k=j[0],m=j[1],n=void 0!==k,o=void 0!==m,p=[],q=0;if(e(),void 0!==k&&void 0!==m){var r=i.unwrapDataType(k),s=i.unwrapDataType(m),t=Math.ceil(s/l.toNearest)*l.toNearest-Math.floor(r/l.toNearest)*l.toNearest;VESPER.log("Mins and Maxs",s,r,k,m,t,l.childScale.range());var u=i.makeBarSizes(l.childScale.range()[1]-l.childScale.range()[0],t),v=u.newBinSize,w=u.newBinCount;VESPER.log("Bin size & count",v,w);for(var x=Math.floor(r/v)*v,y=0;w+1>y;y++){var z=x+v*y;p[y]={count:0,start:i.wrapDataType(Math.max(z,r)),end:i.wrapDataType(Math.min(z+v,s+v))}}f()}return{extremes:[k,m],bins:p}},this.returnMatches=function(a,b,c,d){var e=[],f=a.getData();for(var g in f)if(f.hasOwnProperty(g)){var h=l.getVal(a,f,g,b);void 0!==h&&(h=l.wrapDataType(h,g),h>=c&&d>h&&e.push(g))}return VESPER.log("Min, max, array of matches",c,d,e),e},this.calcCumulative=function(a){VESPER.log("Bins",a);for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count+=b,b+=d}},this.makeBarSizes=function(a,b){for(var c,d=b/a*l.minBarWidth,e=0;e<l.divisions.length;e++)if(l.divisions[e]>d||e===l.divisions.length-1){c=l.divisions[e];break}VESPER.log("Bar domain width, phys range, phys width",d,b,a);var f=Math.ceil(b/c);return{newBinSize:c,newBinCount:f}},this.uncalcCumulative=function(a){for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count-=b,b=d}},this.getRangeSlider=function(){return k},this.baseDestroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(a));var b=c.selectAll(l.barClass);b.remove(),$(a+"Controls").draggable("destroy"),m.removeView(l),m=null,VESPER.DWCAHelper.twiceUpRemove(a)},this.destroy=function(){this.baseDestroy()}},VESPER.TaxaDistribution=function(a){var b=new VESPER.BarChart(a);return b.makeTitle=function(a){return $.t("barChart.taxaTooltip",{count:a.end-a.start,start:a.start,end:a.end-1})+"<br>"+$.t("barChart.taxaCountLabel",{count:a.count})},b.wrapDataType=function(a){return a},b.unwrapDataType=function(a){return a},b.getVal=function(a,b,c,d){var e=a.getIndexedDataPoint(b[c],d.keyField),f=a.getIndexedDataPoint(b[c],d.realField);if(f===e||void 0==f){var g=a.getNodeFromID(c),h=a.getSubTaxa(g);return h?h.length:0}return void 0},b.divisions=[1,2,10,100,1e3],b},VESPER.TimeLine=function(a){var b=new VESPER.BarChart(a),c={};b.childScale=d3.time.scale(),b.barClass="timeBin",b.format=d3.time.format("Y%Y"),b.makeTitle=function(a){return a.start.toString()+"<br>to "+a.end.toString()+"<br>Records: "+a.count},b.wrapDataType=function(a,b){var d=void 0===b?void 0:c[b];return void 0===d?new Date(a):d},b.unwrapDataType=function(a){return a.getTime()},b.getVal=function(a,b,d,e){var f=a.getIndexedDataPoint(b[d],e.dateField);return c[d]||void 0===f||(c[d]=new Date(f)),f},b.destroy=function(){b.baseDestroy(),c={}},b.getRangeSlider().tooltipTemplates({min:function(a,c){return $.t("barChart.timeMinPrefix")+b.wrapDataType(b.makeToNearest(c.invert(a[0])))},max:function(a,c){return $.t("barChart.timeMaxPrefix")+b.wrapDataType(b.makeToNearest(c.invert(a[1])))},bar:function(){return null}});var d=864e5;return b.toNearest=7*d,b.divisions=[d,7*d,91.3125*d,365.25*d,365.25*d*10],b},VESPER.DWCAModel=function(a,b){this.getMetaData=function(){return this.metaData},this.getData=function(){return this.data.records},this.getImplicitTaxonomy=function(){return this.data.impTree},this.getImplicitRoot=function(){return this.data.impRoot},this.getExplicitTaxonomy=function(){return this.data.expTree},this.getExplicitRoot=function(){return this.data.expRoot};var c=0,d=0,e=new MGNapier.SharedSelection;this.getSelectionModel=function(){return e},this.invertSelection=function(){var a=this.getData(),b=this.getSelectionModel(),c=[];for(var d in a)b.contains(d)||c.push(d);b.clear(),b.addAllToMap(c)},this.getExtraData=function(a){return a[VESPER.DWCAParser.EXT]},this.getTaxaData=function(a){return a[VESPER.DWCAParser.TDATA]},this.getSynonyms=function(a){return a[VESPER.DWCAParser.SYN]},this.getRowData=function(a,b){return void 0==b?this.getTaxaData(a):void 0==this.getExtraData(a)?void 0:this.getExtraData(a)[b]},this.getSubTaxa=function(a){return a[VESPER.DWCAParser.TAXA]},this.getSpecimens=function(a){return a[VESPER.DWCAParser.SPECS]},this.getDescendantCount=function(a){return a.dcount},this.getSynonymCount=function(a){return a.syncount||(this.getSynonyms(a)?this.getSynonyms(a).length:0)},this.getSpecimenCount=function(a){return a.spcount||(this.getSpecimens(a)?this.getSpecimens(a).length:0)},this.getObjectCount=function(a){return(a.dcount||0)+this.getSynonymCount(a)+this.getSpecimenCount(a)},this.getSelectedDescendantCount=function(a){return a.Sdcount},this.getSelectedSynonymCount=function(a){return a.Ssyncount},this.getSelectedSpecimenCount=function(a){return a.Sspcount},this.getSelectedObjectCount=function(a){return(a.Sdcount||0)+(a.Ssyncount||0)+(a.Sspcount||0)},this.getLeafValue=function(a){var b=this.getSpecimens(a);return b?b.length:1},this.getNodeFromID=function(a){return this.getData()[a]||(this.getExplicitTaxonomy()?this.getExplicitTaxonomy()[a]:void 0)},this.getLabel=function(a){var b=this.getMetaData().vesperAdds.nameLabelField;return this.getDataPoint(a,b)},this.getDataPoint=function(a,b){var c=this.getMetaData().fileData[b.rowType];void 0==c&&VESPER.log("UNDEFINED ROW",b,this.getMetaData());var d=c.filteredFieldIndex,e=d[b.fieldType];if(void 0==e)return void 0;var f=c.extIndex;return void 0==f?this.getTaxaData(a)[e]:this.getExtraData(a)?this.getExtraData(a)[f][0][e]:void 0},this.getIndexedDataPoint=function(a,b){return void 0==b||void 0==b.fieldType?void 0:void 0==b.rowIndex?this.getTaxaData(a)[b.fieldIndex]:this.getExtraData(a)?this.getExtraData(a)[b.rowIndex][0][b.fieldIndex]:void 0},this.getIndexedDataPoints=function(a,b,c){if(void 0!==b&&void 0!==b.fieldType)if(void 0==b.rowIndex)c.push(this.getTaxaData(a)[b.fieldIndex]);else if(this.getExtraData(a))for(var d=this.getExtraData(a)[b.rowIndex],e=0;e<d.length;e++)c.push(d[e])},this.makeIndices=function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this.makeIndex(a[c]));return b},this.makeIndex=function(a){var b=this.getMetaData().fileData;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c].filteredFieldIndex[a];if(void 0!==d)return{rowIndex:b[c].extIndex,rowType:c,fieldIndex:d,fieldType:a}}return null},this.getRowRecords=function(a,b){return void 0==b?this.getTaxaData(a):this.getExtraData(a)?this.getExtraData(a)[b]:void 0},this.addView=function(a){e.addSingleVis(a),c++,d++},this.removeView=function(a){e.removeVis(a),c--},this.getViewCount=function(){return c},this.getNextSessionModelViewID=function(){return d},this.update=function(){e.update()},this.countSelectedDesc=function(a,b){this.countSelectedDescNew(a,b)},this.countSelectedDescNew=function(a,b){this.doSelectCount(a,b,"Sdcount",this.getSubTaxa,this.getDescendantCount),this.doSelectCount(a,b,"Ssyncount",this.getSynonyms,this.getSynonymCount),this.doSelectCount(a,b,"Sspcount",this.getSpecimens,this.getSpecimenCount)},this.doSelectCount=function(a,b,c,d,e){var f=this.getSubTaxa(a),g=d?d(a):void 0,h=e?e.call(this,a):0,i=g?g.length:0,j=0;if(h||i){if(i)for(var k=i;--k>=0;)j+=this.getSelectionModel().contains(this.getIndexedDataPoint(g[k],b))?1:0;if(h>i)for(var k=f.length;--k>=0;)j+=this.doSelectCount(f[k],b,c,d,e);a[c]=j}return j||0},this.data=b,this.metaData=a},VESPER.demo=function(a,b){function c(){return m}function d(a){o.divDisplay(["#showOnZipLoadDiv"],"none"),o.divDisplay(["#selDiv"],"block"),d3.select("#filenamePlaceholder").html(a.name),d3.select("#filesizePlaceholder").html("..."),d3.select("#dynamicSelectDiv").selectAll("span input").property("checked",!1),d3.select("#loadButton").property("disabled",!0)}function e(a){var c=d3.select(b).select("table");if(c.empty()){c=d3.select(b).append("table");var e=c.append("tr"),f=["Data Set","Description","Originator"],g=e.selectAll("th").data(f);g.enter().append("th").text(function(a){return a})}var h=c.selectAll("tr").data(a,function(a){return void 0==a?void 0:a.name}),i=h.enter().append("tr");i.append("td").append("button").attr("class","choice").attr("type","button").attr("id",function(a){return a.name}).text(function(a){return a.name}).on("click",function(a){MGNapier.NapVisLib.xhr2(a.file,"text/plain; charset=x-user-defined",function(a){var b=MGNapier.NapVisLib.getText(a);MGNapier.NapVisLib.showProps(a),s(b)}),d(a)}),i.append("td").text(function(a){return a.description}),i.append("td").text(function(a){return a.origin}),o.makeProgressBar(void 0,r,"loadProgressDiv"),MGNapier.NapVisLib.makeFileLoadButton(d3.select("#yourData"),"choice","localLoader","Load",function(a,b){d(a),s(b)})}function f(a,b){for(var d=d3.select("#listDiv"),e=d3.select("#dynamicSelectDiv"),f=0;f<a.length;f++){var g=a[f],h=o.addCheckbox(e,g,"fieldGroup"),l=function(a){var b=d3.select(this).property("checked");o.setAllFields(d,b,a.attList,o.isIdWrap,c(),n);var f=d3.select(this.parentNode).attr("class"),g=e.selectAll("span."+f+" input[type='checkbox']"),h=o.reselectActiveVisChoices(g,d,function(){return c()},n);d3.select("#loadButton").property("disabled",h.empty())};o.configureCheckbox(h,g.attList,l)}for(var m=d3.select("#labelSelectDiv"),f=0;f<b.length;f++){var g={fieldType:b[f],rowType:void 0},p=o.addRadioButton(m,g,"fieldGroup","nameChoice",function(a){return a.fieldType});o.configureRadioButton(p,d,function(a){c().vesperAdds.nameLabelField=$.extend({},a),k()},function(){return c()},n)}var q=function(a){var b=d3.select("#dynamicSelectDiv").selectAll(".fieldGroup input");if(b=b.filter(function(){return"none"!==d3.select(this).style("display")}),b.property("checked",a),!a){var d=d3.select("#labelSelectDiv").selectAll(".fieldGroup input");d=d.filter(function(){return"none"!==d3.select(this).style("display")}),d.property("checked",a),c().vesperAdds.nameLabelField=null}};o.addHelperButton(d3.select("#advancedSelectDiv"),d,"Remove Verbose Fields",VESPER.DWCAParser.flabbyLists.wordyList,!1,null,"selButtonStyle listCon",function(){return c()},n);var r=function(a,b){return 0===b};d3.select("#allButton").on("click",function(){return o.setAllFields(d,!0,void 0,r,c(),n),q(!0),!1}),d3.select("#clearButton").on("click",function(){return o.setAllFields(d,!1,void 0,r,c(),n),q(!1),!1});var s=o.addCheckbox(d3.select("#advancedSelectDiv"),{title:"Search DWCA Extensions",image:null},"fieldGroup");s.select("input").property("checked",n.useExtRows).on("click",function(){n.useExtRows=!n.useExtRows,i(c()),j(c())});var t=o.addCheckbox(d3.select("#advancedSelectDiv"),{title:"Select First Matching Field Only",image:null},"fieldGroup");t.select("input").property("checked",n.selectFirstOnly).on("click",function(){n.selectFirstOnly=!n.selectFirstOnly});var u=function(){var a=d3.select(this).property("checked")?"block":"none";return o.divDisplay(["#advancedSelectDiv","#listDiv"],a),!1},v=o.addCheckbox(d3.select("#advRevealPlaceholder"),{title:"Advanced Options",image:null},"showAdv");v.select("input").on("click",u)}function g(a,b){function c(a,b){d3.select("#"+r).select("p").html("Zip processing: "+a+". Parsed "+b+" records.")}o.divDisplay(["#"+r],"block"),VESPER.DWCAZipParse.setNotifyFunc(c);var d=function(a){l=a,h()};VESPER.DWCAParser.filterReadZipEntriesToMakeModel(a,b,d)}function h(){VESPER.log("META",m),VESPER.log("MODEL",l),VESPER.alerts&&alert("mem monitor point X"),o.divDisplay(["#selDiv"],"none"),o.divDisplay(["#allVisDiv"],"block"),d3.select("#"+r).select("p").html("Initialising Chosen Views... Please wait..."),setTimeout(function(){l.name=d3.select("#filenamePlaceholder").text().replace(/\W/g,""),(new VESPER.VisLauncher).makeVis(p[0],l),o.divDisplay(["#"+r],"none"),l=null,m=null},1)}function i(a){var b=d3.select("#labelSelectDiv").selectAll("span.fieldGroup");b.style("display",function(b){var c=o.fieldListExistence(a,[b.fieldType],!0,void 0,n.useExtRows);return c.fields.length>0&&(b.rowType=c.fields[0].rowName),c.match?null:"none"})}function j(a){var b=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup");b.property("checked",!1).style("display",function(b){var c=o.fieldListExistence(a,b.attList,b.matchAll,b.matchAtLeast,n.useExtRows);return c.match?null:"none"})}function k(){var a=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup input");o.reselectActiveVisChoices(a,d3.select("#listDiv"),function(){return c()})}VESPER.tooltip.init();var l,m,n={useExtRows:!0,selectFirstOnly:!0},o=VESPER.DWCAHelper,p=[{title:"Controls",multiple:!1,attList:["unachievable"],matchAll:!0,image:VESPER.imgbase+"tree.png",height:"null",width:"200px",newVisFunc:function(a){return new VESPER.VisLauncher(a,{autoLaunch:"on"})},setupFunc:function(){return{visChoiceData:p}}},{title:"Reference Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.ImplicitTaxonomy(a)},setupFunc:function(){return{rankField:"taxonRank"}}},{title:"Specimen Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.expTaxonomy,matchAtLeast:2,matchAll:!1,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.ExplicitTaxonomy(a)},setupFunc:function(){return{rankField:"taxonRank"}}},{title:"Map",multiple:!0,attList:VESPER.DWCAParser.neccLists.geo,matchAll:!0,image:VESPER.imgbase+"world.png",height:"400px",newVisFunc:function(a){return new VESPER.DWCAMapLeaflet(a)},setupFunc:function(){return{latitude:"decimalLatitude",longitude:"decimalLongitude"}}},{title:"Timeline",multiple:!0,attList:VESPER.DWCAParser.neccLists.basicTimes,matchAll:!0,image:VESPER.imgbase+"calendar.png",height:"200px",newVisFunc:function(a){return VESPER.TimeLine(a)},setupFunc:function(){return{dateField:"eventDate"}}},{title:"Missing Data Check",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"comment.png",height:"400px",newVisFunc:function(a){return new VESPER.Sanity(a)},setupFunc:function(){return void 0}},{title:"Record Details",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"comment.png",height:"500px",newVisFunc:function(a){return new VESPER.RecordDetails(a)},setupFunc:function(){return void 0}},{title:"Taxa Distribution",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"dist.png",height:"200px",newVisFunc:function(a){return VESPER.TaxaDistribution(a)},setupFunc:function(){return{realField:"acceptedNameUsageID",rankField:"taxonRank"}}},{title:"Search Box",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"search.png",height:"150px",width:"200px",newVisFunc:function(a){return new VESPER.FilterView(a)},setupFunc:function(){return{}}}],q=p.slice(0,6),r="vesperProgressBar",s=function(a){var b=d3.select("#filesizePlaceholder");b.html(null),b.append("img").attr("class","vesperIcon").attr("src",VESPER.imgbase+"zipIcon.gif"),b.append("span").text((a.length||a.byteLength).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" bytes"),VESPER.alerts&&alert("check memory use in task manager");var c=VESPER.DWCAParser.accessZip(a,"meta.xml"),d=c.meta;if(m=d,m.error)alert(m.error+" Check DWCA meta.xml compliance.");else{var e=c.jszip;o.makeFieldSelectionBoxes(d,d3.select("#listDiv")),d3.select("#loadButton").on("click",null).on("click",function(){return g(e,d),!1}),j(d),i(d);var f=d3.select("#labelSelectDiv").selectAll("span.fieldGroup"),h=!0;f.each(function(){var a=d3.select(this).style("display");if("none"!==a&&h){h=!1;var b=d3.select(this).select("input"),c=document.createEvent("MouseEvent");c.initEvent("click",!0,!0),b.node().dispatchEvent(c)}}),o.divDisplay(["#showOnZipLoadDiv"],"block")}};e(a),f(q,VESPER.DWCAParser.labelChoiceData)},VESPER.DWCAHelper=new function(){function a(a){var b=this.checked,c=d3.select(this.parentNode),d=VESPER.DWCAParser.controlledVocabSet[a]?"#999977":"#888888";c.style("background",b?"":d)}function b(a,b){return a.rowType===b.coreRowType}function c(a,b){return a.invFieldIndex[a.idIndex]===b}function d(a,b){return a.selectedItems[b]===!0||c(a,b)}function e(a,b,c){a.selectedItems[b]=c}function f(a){return a.selected===!0}function g(a,b){a.selected=b}function h(b,e,g){VESPER.log("Table, metadata, table key",b,e,g);var h=e.fileData[g],i=f(h);b.style("background",i?"":"#888888"),b.selectAll("td").style("background",function(b){return d(h,b)&&i?a(b):"#888888"}),b.selectAll("td input").attr("disabled",function(a){return c(h,a)||!i?"disabled":null}).property("checked",function(a){return d(h,a)}),b.selectAll("th").style("background",function(b){return i?a(b):"#888888"}),b.selectAll("th input").property("checked",function(){return i})}var i=this;return this.getSelectedTickBoxValues=function(a,b){function c(){this.checked&&(f[this.value]=!0)}var d="input[type=checkbox]"+(b?"."+b:""),e=d3.select(a).selectAll(d),f={};return e.each(c),f},this.isIdWrap=function(a,b){return c(a,b)},this.makeFieldSelectionBoxes=function(b,i){function j(f,g){VESPER.log("makerow args",arguments);var i=f;VESPER.log("table index and datum",g,f);var j=d3.select(this),k=j.attr("id"),l=f.value.invFieldIndex.filter(function(a){return void 0!==a}),m=j.selectAll("tr.col").data(l);m.exit().selectAll("input").on("click",null),m.exit().remove();var n=m.enter().append("tr").attr("class","col").append("td");n.append("input").attr("type","checkbox").attr("class","CSVField"),n.append("label");var o=m.select("td");o.select("input").property("checked",function(a){return d(i.value,a)}).attr("id",function(a){return k+a}).attr("value",function(a,b){return b}).attr("name",function(a){return a}).attr("disabled",function(a){return c(i.value,a)?"disabled":null}).on("click",null).on("click",function(a){var c=this.checked;return VESPER.log("File data object entry",i,c,this),e(i.value,a,c),h(j,b,i.key),!0}).each(a),o.select("label").attr("for",function(a){return k+a}).text(function(a){return a})}g(b.fileData[b.coreRowType],!0),VESPER.log("meta",b);for(var k=d3.entries(b.fileData),l=0;l<k.length;l++)k[l].value.selectedItems=k[l].value.selectedItems||{};var m=i.selectAll("div.selectBox").data(k,function(a){return a.key});m.exit().selectAll("input").on("click",null),m.exit().remove();var n=Math.floor(100/k.length)-2,o=m.enter().append("div").attr("class","selectBox").append("table");m.style("width",n+"%").select("table").attr("class",function(a){return a.key===b.coreRowType?"coreTable":null}).attr("id",function(a){return a.value.mappedRowType});var p=o.append("tr").append("th");p.append("input").attr("type","checkbox").attr("class","extensionFile").attr("id",function(a){return"cbox"+a.value.mappedRowType}).property("checked",function(a){return f(a.value)}).attr("value",function(a){return a.value.rowType}).attr("name",function(a){return a.value.mappedRowType}).attr("disabled",function(a){return a.key===b.coreRowType?"disabled":null}).on("click",function(a,c){var d=this.checked;return VESPER.log("check",d,this),g(a.value,d),h(d3.select(o[0][c]),b,a.key),!0}).each(a),p.append("label").attr("for",function(a){return"cbox"+a.value.mappedRowType}).text(function(a){return a.value.mappedRowType}),m.selectAll("table").each(j)},this.getAllSelectedFilesAndFields=function(a){var b={},c=a.fileData;for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e.selected){var f=e.selectedItems;VESPER.log("selected items",f);var g={},h=0;for(var i in f)f.hasOwnProperty(i)&&f[i]&&(g[i]=!0,h++);if(h){var j=e.invFieldIndex[e.idIndex];g[j]=!0,b[d]=g}}}return VESPER.log("Selected File and Fields Structure",b),b},this.setAllFields=function(a,c,d,e,f,i){for(var j=a.selectAll("table"),k=i?i.useExtRows:!0,l=i?i.selectFirstOnly:!1,m=f.fileData,n=d3.entries(m).sort(function(a,c){return b(a.value,f)?-1:b(c.value,f)?1:0}),o=d?d.slice(0):void 0,p=0;p<n.length;p++){var q=n[p].value,r=q.selectedItems,s=o||q.invFieldIndex;if(void 0!==r){for(var t=0;t<s.length;t++){var u=s[t];q.fieldIndex[u]&&(r[u]=b(q,f)||k?(e?e(q,u):!1)||c:!1,c&&l&&o&&(o[t]=null))}var v=d3.values(r),w=d3.set(v);g(q,w.has("true"))}}g(f.fileData[f.coreRowType],!0),j.each(function(a){h(d3.select(this),f,a.key)})},this.fieldListExistence=function(a,c,d,e,f,g){var h=d3.set(c),i=d3.set(),j=g?"filteredInvFieldIndex":"invFieldIndex",k=[];for(var l in a.fileData)if(a.fileData.hasOwnProperty(l)){var m=a.fileData[l];if(f||b(m,a))for(var n=0;n<m[j].length;n++){var o=m[j][n];h.has(o)&&(i.add(o),k.push({fieldName:o,rowName:l}))}}VESPER.log("Field List",c,"Match",k,i.values());var p=i.values().length,q=d?p===c.length:e?p>=e:p>0;return{match:q,fields:k}},this.addHelperButton=function(a,b,d,e,f,g,h,j,k){var l=a.selectAll("button[type=button]."+h).data([{key:d,value:e,add:f}],function(a){return a.key});l.enter().append("button").attr("type","button").attr("class",h).attr("value",function(a){return a.key}).attr("name",function(a){return a.key}).on("click",function(a){i.setAllFields(b,a.add,a.value,c,j(),k)}).html(function(a){return(g?'<img src="'+g+'">':"")+a.key})},this.addCheckbox=function(a,b,c){function d(a){return a.title||a.name}var e=a.selectAll("span").data([b],function(a){return a.title});if(!e.enter().empty()){var f=e.enter().append("span").attr("class",c);f.append("input").attr("type","checkbox").attr("value",d).attr("name",d).attr("id",d).property("checked",!1);var g=f.append("label").attr("for",d);(b.icon||b.image)&&g.append("img").attr("class","vesperIcon").attr("alt",d).attr("src",function(a){return a.image||a.icon}),g.append("span").text(d)}return e},this.configureCheckbox=function(a,b,c){b&&(a.datum().attList=b),a.select("input").on("click",c)},this.reselectActiveVisChoices=function(a,b,d,e){a=a.filter(function(){return d3.select(this).property("checked")});var f=[];return a.each(function(a){f.push.apply(f,a.attList)}),i.setAllFields(b,!0,f,c,d(),e),a},this.addRadioButton=function(a,b,c,d,e){var f=a.selectAll("span").data([b],function(a){return e(a)});if(!f.enter().empty()){var g=f.enter().append("span").attr("class",c);g.append("input").attr("type","radio").attr("value",e).attr("name",d).attr("id",function(a){return e(a)+"RBChoice"}).property("checked",!1),g.append("label").attr("for",function(a){return e(a)+"RBChoice"}).text(e)}return f},this.configureRadioButton=function(a,b,d,e,f){a.select("input").on("click",function(a){var g=d3.select(this).property("checked"),h=d3.select(this).attr("name"),j=d3.selectAll("input[type='radio'][name='"+h+"']"),k=[];j.each(function(a){k.push(a.fieldType)}),i.setAllFields(b,!1,k,c,e(),f),i.setAllFields(b,g,[a.fieldType],c,e(),f),d(a)})},this.makeProgressBar=function(a,b,c){var d=d3.select("#"+b);return d.empty()&&a&&a.append("div").attr("id",b),d=d3.select("#"+b),d.empty()||(d.attr("class",c),d.select("p").empty()&&d.append("p")),d},this.addDragArea=function(a){if(a){var b=a.attr("id");a.append("div").attr("class","dragHandle").attr("id",b+"dragger")}},this.divDisplay=function(a,b){for(var c=0;c<a.length;c++)d3.select(a[c]).style("display",b)},this.twiceUpRemove=function(a){var b=d3.select(a).node(),c=b.parentElement;$(function(){$(c).draggable("destroy")}),c.parentElement.removeChild(c)},this.recurseClearEvents=function(a){a.on("mouseout",null).on("mouseover",null).on("mousedown",null).on("mouseup",null).on("click",null).on("contextmenu",null),a.each(function(){var a=d3.select(this),b=a.selectAll("*");b.empty()||i.recurseClearEvents(b)})},i
},VESPER.DWCAMapLeaflet=function(a){function b(){var a=k._topClusterLevel.getChildCount(),b=Math.log(a+1);r=q/b}function c(a,b,c){var d,e,f,g,h=!1;if(!b.contains(c))return!1;for(f=0,g=a.length;g>f;f++)d=a[f],e=a[(f-1+g)%g],d.lat>c.lat!=e.lat>c.lat&&c.lng<(e.lng-d.lng)*(c.lat-d.lat)/(e.lat-d.lat)+d.lng&&(h=!h);return h}var d,e,f,g,h,i,j,k,l,m,n=this,o=a.substring(1),p={},q=60,r=5,s=L.icon({iconUrl:VESPER.imgbase+"selMarker.png",shadowUrl:"../lib/leafletjs/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],shadowAnchor:[4,62]}),t=new L.Icon.Default,u=d3.format(".6r"),v=function(a){VESPER.tooltip.updateText(a.layer.getChildCount()+" Records",(a.layer.getSelectedChildCount()>0?a.layer.getSelectedChildCount()+" Selected<br>":"")+u(a.latlng.lat)+" Lat<br>"+u(a.latlng.lng)+" Long"),VESPER.tooltip.updatePosition(a.originalEvent)},w=function(a){var b=[],c=[];if(a.layer.getAllChildMarkers(b),b.length>0){for(var d=0;d<b.length;d++)c.push(b[d].extId);h.getSelectionModel().clear(),h.getSelectionModel().addAllToMap(c)}},x=function(a){var b=a.target.extId,c=h.getNodeFromID(b);VESPER.tooltip.updateText(h.getLabel(c),a.latlng+(h.getSelectionModel().contains(b)?"<br>Selected":"")),VESPER.tooltip.updatePosition(a.originalEvent)},y=function(a){h.getSelectionModel().clear(),h.getSelectionModel().addToMap(a.target.extId)},z=function(a){var b=a.layerType,d=a.layer,e=[];if("circle"===b){VESPER.log("circle",a);var f=a.layer._latlng,g=a.layer._mRadius;k.eachLayer(function(a){var b=a.getLatLng();f.distanceTo(b)<=g&&e.push(a.extId)})}else if("rectangle"===b){VESPER.log("rectangle",a);var j=a.layer._latlngs,l=new L.LatLngBounds(j[0],j[2]);k.eachLayer(function(a){var b=a.getLatLng();l.contains(b)&&e.push(a.extId)})}else if("polygon"===b){VESPER.log("polygon",a);var j=a.layer._latlngs,m=new L.LatLngBounds(j);k.eachLayer(function(a){var b=a.getLatLng();c(j,m,b)&&e.push(a.extId)})}VESPER.log(e.length,"specimens within",b),i=d,h.getSelectionModel().clear(),h.getSelectionModel().addAllToMap(e)};this.set=function(b,c){var i=c.makeIndices([b.identifyingField,b.longitude,b.latitude]);e=i[0],f=i[1],g=i[2],d=MGNapier.NapVisLib.getDivDims(a),h=c,VESPER.log("set model for map",h)},this.go=function(){if(!m){var c="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",d="Map data � OpenStreetMap contributors",e=new L.TileLayer(c,{minZoom:1,maxZoom:19,attribution:d});d3.select(a).style("overflow","hidden"),m=L.map(o),m.addLayer(e);var i=new L.Control.Draw({draw:{marker:!1,polyline:!1}});m.addControl(i),m.on("draw:created",z),k=new L.MarkerClusterGroup({iconCreateFunction:function(a){var b=Math.log(a.getChildCount()+1),c=10+b*r,d=c*Math.log(a.getSelectedChildCount()+1)/b,e=c-d;return.5>e&&a.getChildCount()===a.getSelectedChildCount()&&(e=0),new L.DivIcon({html:'<div class="unselected" style="height:'+e+'px;">'+a.getChildCount()+'</div><div class="selected" style="height:'+d+'px">'+a.getSelectedChildCount()+"</div>",className:"vesperMapIcon",iconSize:new L.Point(40,c)})}}),k.on("clustermouseover",v),k.on("clustercontextmenu",w)}var n=[],q=[],s=h.getData();if(g&&f){var t=[],u=[];for(var A in s)if(s.hasOwnProperty(A)){t.length=0,u.length=0,h.getIndexedDataPoints(s[A],g,t),h.getIndexedDataPoints(s[A],f,u);for(var B=t.length;--B>=0;){var C=+t[B],D=+u[B];if(!isNaN(C)&&!isNaN(D)){var E=[C,D],F=L.marker(E).on("mouseover",x).on("contextmenu",y);if(F.extId=A,q.push(F),n.push(E),p[A]){var G=p[A];if(G.extId){var H=[G];p[A]=H,G=H}G.push(F)}else p[A]=F}}}k.addLayers(q)}m.addLayer(k),m.fitBounds(new L.LatLngBounds(n).pad(1.05));var I=L.TileLayer.maskCanvas({opacity:.6,radius:5,useAbsoluteRadius:!1,color:"#aaf",noMask:!0});I.setData(n),j=L.TileLayer.maskCanvas({opacity:.8,radius:5,useAbsoluteRadius:!1,color:"#f00",noMask:!0}),j.setData([]),l=L.layerGroup([I,j]),L.control.layers({},{"Marker Group":k,"Direct Plot":l}).addTo(m),L.control.scale().addTo(m),VESPER.log("group ",k),VESPER.log("map ",m),b()},this.update=function(){var a=h.getSelectionModel().values();if(k){b(),k.eachLayer(function(a){var b=h.getSelectionModel().contains(a.extId);a.setIcon(b?s:t)});for(var c,d=[],e=0;e<a.length;e++){var f=p[a[e]];if(f)if(f.extId)d.push(f.getLatLng()),c=f;else for(var g=f.length;--g>=0;){var i=f[g];d.push(i.getLatLng()),c=i}}if(k.setAllSelectedChildCounts(h.getSelectionModel()),1===d.length)k.zoomToShowLayer(c,function(){c.openPopup()});else if(d.length>1){var l=new L.LatLngBounds(d);m.fitBounds(l)}j.setData(d)}},this.destroy=function(){m.addLayer(k),m.addLayer(l),h.removeView(n),h=null,k.removeEventListener(),k.eachLayer(function(a){a.removeEventListener()}),k.clearLayers(),l.eachLayer(function(a){a.removeEventListener(),a.setData([])}),l.clearLayers();var b=[];m.eachLayer(function(a){b.push(a)}),m.removeEventListener();for(var c=0;c<b.length;c++)m.removeLayer(b[c]);m.remove(),p={},VESPER.DWCAHelper.twiceUpRemove(a)},this.updateVals=this.update,L.MarkerClusterGroup.include({setAllSelectedChildCounts:function(a){return this._topClusterLevel.setAllSelectedChildCounts(a)}}),L.MarkerCluster.include({_selChildCount:0,setAllSelectedChildCounts:function(a){for(var b=0,c=this._markers.length-1;c>=0;c--)a.contains(this._markers[c].extId)&&b++;for(var d=this._childClusters.length-1;d>=0;d--)b+=this._childClusters[d].setAllSelectedChildCounts(a);return this._selChildCount=b,this._updateIcon(),b},getSelectedChildCount:function(){return this._selChildCount}})},VESPER.DWCAParser=new function(){function a(a,b,c){$.each(c,function(c){var d=b.fileData[c],e=a.dwcaFolder+d.fileName;a.zipEntries.getLocalFile(e).uncompressedFileData=null}),VESPER.alerts&&alert("mem monitor point 1")}function b(a){var b=g[a];return void 0===b?a:b}function c(a,b,c){a[b]||(a[b]=[]),a[b].push(c)}function d(a,b){if(void 0==a.filteredFieldIndex[b]){var c=a.filteredInvFieldIndex.length;a.filteredInvFieldIndex.push(b),a.filteredFieldIndex[b]=c,c=a.invFieldIndex.length,a.invFieldIndex.push(b),a.fieldIndex[b]=c}}function e(a){var b=a?a.lastIndexOf("/")+1:-1;return b>0?a.substring(b):a}this.TDATA=0,this.TAXA=1,this.EXT=2,this.SYN=3,this.PID=4,this.COUNTS=5,this.SPECS="s",this.TCOUNT=0,this.SPECCOUNT=1,this.SYNCOUNT=2,this.SELOFFSET=3,this.SUPERROOT="superroot";var f="-1000";console.log("This",this);var g={"class":"classs",DarwinCore:"Occurrence",SimpleDarwinCore:"Occurrence",catalogNumberNumeric:"catalogNumber",collectorNumber:"recordNumber",collector:"recordedBy",nativeness:"establishmentMeans",latestDateCollected:"eventDate",earliestDateCollected:"eventDate",state:"stateProvince",province:"stateProvince",city:"municipality",depth:"verbatimDepth",elevation:"verbatimElevation",latitude:"decimalLatitude",longitude:"decimalLongitude",datum:"geodeticDatum",nameUsageID:"taxonID",nameID:"scientificNameID",acceptedTaxonID:"acceptedNameUsageID",parentTaxonID:"parentNameUsageID",higherTaxonID:"parentNameUsageID",higherNameUsageID:"parentNameUsageID",originalNameID:"originalNameUsageID",originalTaxonID:"originalNameUsageID",basionymID:"originalNameUsageID",taxonAccordingToID:"nameAccordingToID",acceptedTaxon:"acceptedNameUsage",parentTaxon:"parentNameUsage",higherTaxon:"parentNameUsage",higherNameUsage:"parentNameUsage",originalName:"originalNameUsage",originalTaxon:"originalNameUsage",basionym:"originalNameUsage",taxonAccordingTo:"nameAccordingTo",rank:"taxonRank",scientificNameRank:"taxonRank",taxonRemark:"taxonRemarks",EventAttributeType:"measurementType",eventMeasurementType:"measurementType",SamplingAttributeType:"measurementType"};this.flabbyLists={},this.flabbyLists.wordyList=["eventRemarks","taxonRemarks","georeferenceRemarks","identificationRemarks","locationRemarks","measurementRemarks","occurrenceRemarks","relationshipRemarks","verbatimCoordinates","bibliographicCitation","description"],this.explicitRanks=["kingdom","phylum","classs","order","family","genus","subgenus","specificEpithet","infraspecificEpithet"],this.neccLists={},this.neccLists.geo=["decimalLatitude","decimalLongitude","geodeticDatum"],this.neccLists.impTaxonomy=["acceptedNameUsageID","parentNameUsageID","taxonRank"],this.neccLists.expTaxonomy=this.explicitRanks,this.neccLists.times=["eventDate","modified","geodeticDatum","georeferencedDate","dateIdentified","verbatimEventDate"],this.neccLists.basicTimes=["eventDate"],this.labelChoiceData=["acceptedNameUsage","scientificName","originalNameUsage","vernacularName"],this.controlledVocabFields=["continent","country","countryCode","stateProvince","county","island","islandGroup","waterBody","higherGeographyID","geodeticDatum","georeferenceVerificationStatus","verbatimCoordinateSystem","verbatimSRS","taxonomicStatus","language","nomenclaturalCode","nomenclaturalStatus","identificationVerificationStatus","rightsHolder","type","audience","format","taxonRank","verbatimTaxonRank","basisOfRecord","dcterms:type","dcterms:language","measurementUnit","behavior","relationshipOfResource","establishmentMeans","occurrenceStatus","disposition","sex","lifeStage","reproductiveCondition","isPlural","threatStatus","isMarine","isFreshwater","isTerrestrial","isInvasive","isHybrid","isExtinct","typeDesignationType"],this.archiveLimitedFields=["institutionID","collectionID","datasetID","institutionCode","collectionCode","datasetName","ownerInstitutionCode","year","month","day","source","nameAccordingToID","isPreferredName","typeStatus","verbatimTaxonRank","superkingdom","kingdom","superphylum","phylum","subphylum","superclass","classs","order","family"],this.controlledVocabSet={};for(var h=0;h<this.controlledVocabFields.length;h++)this.controlledVocabSet[this.controlledVocabFields[h]]=!0;this.discreteTermList=this.controlledVocabFields.concat(this.archiveLimitedFields),this.discreteTermSet={};for(var h=0;h<this.discreteTermList.length;h++)this.discreteTermSet[this.discreteTermList[h]]=!0;return this.sharedValuesTerms={taxonID:1,acceptedNameUsageID:1,parentNameUsageID:1,originalNameUsageID:1},this.recordURIMap={"http://rs.tdwg.org/dwc/xsd/simpledarwincore/SimpleDarwinRecord":"Simple Darwin Record","http://rs.tdwg.org/dwc/terms/Occurrence":"Occurrence","http://rs.tdwg.org/dwc/terms/Event":"Event","http://purl.org/dc/terms/Location":"Location","http://purl.org/dc/terms/GeologicalContext":"GeologicalContext","http://rs.tdwg.org/dwc/terms/Identification":"Identification","http://rs.tdwg.org/dwc/terms/Taxon":"Taxon","http://rs.tdwg.org/dwc/terms/ResourceRelationship":"ResourceRelationship","http://rs.tdwg.org/dwc/terms/MeasurementOrFact":"MeasurementOrFact","http://rs.gbif.org/terms/1.0/Distribution":"Distribution","http://rs.gbif.org/terms/1.0/VernacularName":"VernacularName","http://rs.gbif.org/terms/1.0/SpeciesProfile":"SpeciesProfile","http://rs.gbif.org/terms/1.0/TypesAndSpecimen":"TypesAndSpecimen","http://rs.gbif.org/terms/1.0/Reference":"Reference","http://rs.gbif.org/terms/1.0/Image":"Image","http://rs.gbif.org/terms/1.0/Identifier":"Identifier","http://rs.gbif.org/terms/1.0/Description":"Description","http://rs.nordgen.org/dwc/germplasm/0.1/terms/GermplasmSample":"GermplasmSample","http://purl.org/germplasm/germplasmTerm#GermplasmAccession":"GermplasmAccession","http://purl.org/germplasm/germplasmTerm#MeasurementExperiment":"MeasurementExperiment","http://purl.org/germplasm/germplasmTerm#MeasurementMethod":"MeasurementMethod","http://eol.org/schema/reference/Reference":"EOL Reference","http://eol.org/schema/media/Document":"EOL Document","http://eol.org/schema/agent/Agent":"EOL Agent","http://www.w3.org/ns/oa#Annotationt":"W3 Annotation"},this.rowTypeDefaults={},this.fieldAttrNames={},this.xsd=null,this.loadxsd=function(a){$.get(a,function(a){VESPER.log("XSD",a,typeof a),VESPER.DWCAParser.xsd="string"==typeof a?$(MGNapier.NapVisLib.parseXML(a)):$(a),VESPER.DWCAParser.makeRowTypeDefaults(VESPER.DWCAParser.xsd),VESPER.DWCAParser.makeFieldAttrNames(VESPER.DWCAParser.xsd)})},this.accessZip=function(a,b){var c=new JSZip(a,{base64:!1,noInflate:!0});c.dwcaFolder="";for(var d,e=0;e<c.zipEntries.files.length;e++){var f=c.zipEntries.files[e].fileName,g=f.indexOf(b);if(g>=0){d=f,c.dwcaFolder=d.slice(0,g);break}}if(VESPER.log("ZIP ENTRIES",c.zipEntries,d),void 0!==d){c.zipEntries.readLocalFile(d),VESPER.log("unzipped ",c,c.files);var h=c.zipEntries.getLocalFile(d),i=VESPER.DWCAParser.parseMeta($.parseXML(h.uncompressedFileData));return{jszip:c,meta:i}}return{jszip:c,meta:{error:"Cannot locate "+b+" within zip."}}},this.filterReadZipEntriesToMakeModel=function(b,c,d){function e(j){var k=h[i].key,l=h[i].value,m=c.fileData[k],n=b.dwcaFolder+m.fileName,o=MGNapier.NapVisLib.newFilledArray(m.invFieldIndex.length,!1);$.each(l,function(a,b){o[m.fieldIndex[a]]=b}),VESPER.DWCAZipParse.set(m,o),j.callbackQ=[],j.fileName=n;var p=function(){g[m.rowType]=b.zipEntries.getLocalFile(n).uncompressedFileData,VESPER.DWCAParser.updateFilteredLists(m,o),i===h.length-1&&(a(b,c,f),d(new VESPER.DWCAModel(c,VESPER.DWCAParser.setupStrucFromRows(g,c)))),j.callbackQ.length=0,j.fileName=void 0,i++,i<h.length&&e(j)};j.callbackQ.push(p),b.zipEntries.readLocalFile(n,j)}var f=VESPER.DWCAHelper.getAllSelectedFilesAndFields(c),g={},h=d3.entries(f),i=0;e(VESPER.DWCAZipParse.zipStreamSVParser2)},$.fn.filterNode=function(a){return this.find("*").filter(function(){return this.nodeName?this.nodeName.toUpperCase()===a.toUpperCase():!1})},this.makeRowTypeDefaults=function(a){var b=a.find('xs\\:attributeGroup[name="fileAttributes"], attributeGroup[name="fileAttributes"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("default"),c=a.attr("type");"xs:integer"==c&&(b=+b),VESPER.DWCAParser.rowTypeDefaults[a.attr("name")]=b}),VESPER.log("Row Type Defaults",VESPER.DWCAParser.rowTypeDefaults)},this.makeFieldAttrNames=function(a){var b=a.find('xs\\:complexType[name="fieldType"], complexType[name="fieldType"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("name"),c=a.attr("type");VESPER.DWCAParser.fieldAttrNames[b]=c}),VESPER.log("Field Attribute Names",VESPER.DWCAParser.fieldAttrNames)},this.occArray2JSONArray=function(a,b){var c={};VESPER.alerts&&alert("mem monitor point 1.4");for(var d=0,e=a.length;e>d;d++){var f=a[d];if(f){var g=f[b];c[g]={},c[g][this.TDATA]=f}}return c},this.jsonTaxaObj2JSONTree=function(a,b,d,e){var f=d.filteredFieldIndex,g=d.idIndex;VESPER.alerts&&alert("mem monitor point 1.5");for(var h=f.parentNameUsageID,i=f.acceptedNameUsageID,j=0,k=b.length;k>j;j++){var l=b[j];if(l){var m=l[g],n=l[h],o=a[n];n!==m&&o&&c(o,VESPER.DWCAParser.TAXA,a[m])}}for(var j=0,k=b.length;k>j;j++){var l=b[j];if(l){var m=l[g],n=l[h],o=a[n];if(void 0==o){var p=l[i];if(p&&m!==p){var q=a[p];if(q){var r=a[m];c(q,VESPER.DWCAParser.SYN,r);var s=r[VESPER.DWCAParser.TAXA];if(s){for(var t=0;t<s.length;t++){var u=s[t],v=u[VESPER.DWCAParser.TDATA],w=v[g],x=v[i];w===x&&void 0!==x&&c(q,VESPER.DWCAParser.TAXA,u)}r[VESPER.DWCAParser.TAXA].length=0}}else VESPER.log("Deadonym. No link to accepted name id "+p+" for "+l)}}}}var y=this.findRoots(a,g,f);return this.createSuperroot(a,y,d,e,f),VESPER.log("roots",y),VESPER.log("JSON",a[1],a),a},this.jsonTaxaObj2ExplicitJSONTree=function(a,b,e,f,g){d(e,"taxonRank");var h=e.idIndex,i=e.filteredFieldIndex;VESPER.alerts&&alert("mem monitor point 1.5a ex"),VESPER.log("SPECS",VESPER.DWCAParser.SPECS);var j=VESPER.DWCAParser.explicitRanks;VESPER.log("Vesper adds",f.vesperAdds);for(var k=i[f.vesperAdds.nameLabelField.fieldType],l={},m=j.length,n={},o=[],p=[],q=0;m>q;q++){var r=j[q];("specificEpithet"===r||"infraspecificEpithet"===r)&&(o[q]=!0),p[q]=i[r]}for(var s=0,t=b.length;t>s;s++){var u=b[s];if(u){for(var v=!1,w=void 0,x=void 0,y=[],q=0;m>q;q++){var r=j[q],z=p[q];if(z){var A=u[z];if(y[q]=A,A){o[q]&&w&&(A=w[this.TDATA][k]+" "+A);var B=A;if(n[B]&&w){var C=w[this.TDATA][h],D=n[B][this.PID];C!==D&&(B=C+B,n[B]||VESPER.log("Introducing new id",B))}if(!n[B]){var E=[];E[h]=B,E[k]=A,E[i.taxonRank]=r;var F={};F[this.TDATA]=E,n[B]=F,w&&c(w,VESPER.DWCAParser.TAXA,F),F[this.PID]=w?w[this.TDATA][h]:-10}w||(l[B]=!0),v&&VESPER.log("trace",B,A,z,n[B]),w=n[B],x=B}}}w&&(v&&console.log("adding original",a[u[h]],u[k]),g(w,a[u[h]],n,x,h,i,k))}}var G=d3.keys(l);return this.createSuperroot(n,G,e,f,i),VESPER.log("roots",G),VESPER.log("json",a,"tree",n),n},this.addOriginalAsSpecimenEntry=function(a,b,d,e,f,g,h){var i=e;if(!d[i]){var j=[];j[f]=i,j[h]=i,j[g.taxonRank]="Species";var k={};k[VESPER.DWCAParser.TDATA]=j,d[i]=k,a&&c(a,VESPER.DWCAParser.TAXA,d[i])}c(d[i],VESPER.DWCAParser.SPECS,b)},this.addOriginalAsLeaf=function(a,b){c(a,VESPER.DWCAParser.TAXA,b)},this.addExtRows2JSON=function(a,b,d){var e=d.idIndex,f=[];if(b&&void 0!=e)for(var g=d.extIndex,h=0,i=b.length;i>h;h++){var j=b[h];if(j){var k=j[e];if(void 0!=k){var l=a[k];if(l){l[this.EXT]||(l[this.EXT]=[]);var m=l[this.EXT];c(m,g,j)}}else f.push(h)}}return f},this.makeTreeFromAllFileRows=function(a,b){var c,d,e=b.fileData,f=e[b.coreRowType],g=a[f.rowType],h=this.occArray2JSONArray(g,f.idIndex),i=VESPER.DWCAHelper.fieldListExistence(b,VESPER.DWCAParser.neccLists.impTaxonomy,!0,void 0,!0,!0),j=VESPER.DWCAHelper.fieldListExistence(b,VESPER.DWCAParser.neccLists.expTaxonomy,!1,2,!0,!0);VESPER.log("TREE POS",i,j),VESPER.log("MDR",b.coreRowType),i.match&&(c=this.jsonTaxaObj2JSONTree(h,g,f,b)),j.match&&(d=this.jsonTaxaObj2ExplicitJSONTree(h,g,f,b,VESPER.DWCAParser.addOriginalAsSpecimenEntry));var k={records:h,impTree:c,expTree:d};for(var l in e)if(e.hasOwnProperty(l)){var m=e[l];if(b.coreRowType!==m.rowType&&m.selected){var n=this.addExtRows2JSON(k.records,a[m.rowType],m);VESPER.log("unreconciled in ",l,n)}}return k},this.setupStrucFromRows=function(a,b){console.log("METADATA",b);var c=this.makeTreeFromAllFileRows(a,b);return VESPER.alerts&&alert("mem monitor point 2"),c.impTree&&(c.impRoot=c.impTree[f],VESPER.log("root",c.impRoot),c.impRoot&&(this.recursiveCount(c.impRoot,"dcount",void 0,1),this.recursiveCount(c.impRoot,"syncount",VESPER.DWCAParser.SYN,0))),c.expTree&&(c.expRoot=c.expTree[f],c.expRoot&&(this.recursiveCount(c.expRoot,"dcount",void 0,1),this.recursiveCount(c.expRoot,"spcount",VESPER.DWCAParser.SPECS,0))),VESPER.log("STRUC",c),VESPER.alerts&&alert("mem monitor point 3"),VESPER.log("root",c.impRoot,c.expRoot,c.expTree),c},this.findRoots=function(a,b,c){var d=[],e=c.parentNameUsageID,f=c.acceptedNameUsageID;if(void 0!==f&&void 0!==e)for(var g in a)if(a.hasOwnProperty(g)){var h=a[g],i=h[this.TDATA];if(i){var j=i[b],k=i[f],l=i[e];j!==k&&void 0!=k||l!==j&&void 0!=a[l]||d.push(g)}}return d},this.createSuperroot=function(a,b,c,d,e){if(0===b.length)return void 0;if(1===b.length)return a[f]=a[b[0]],a[b[0]];var g=e[d.vesperAdds.nameLabelField.fieldType],h=c.invFieldIndex[e.id],i=c.invFieldIndex[g],j=e.parentNameUsageID,k={acceptedNameUsageID:f,parentNameUsageID:f,acceptedNameUsage:VESPER.DWCAParser.SUPERROOT,taxonRank:VESPER.DWCAParser.SUPERROOT,nameAccordingTo:"dwcaParse.js"};k[i]=VESPER.DWCAParser.SUPERROOT,k[h]=f;var l={};l[this.TAXA]=[];for(var m=0;m<b.length;m++)l[this.TAXA].push(a[b[m]]),a[b[m]][VESPER.DWCAParser.TDATA][j]=f;l[VESPER.DWCAParser.TDATA]=[];for(var n in k)k.hasOwnProperty(n)&&void 0!==e[n]&&(l[VESPER.DWCAParser.TDATA][e[n]]=k[n]);return VESPER.log("superroot",l),a[f]=l,l},this.recursiveCount=function(a,b,c,d){var e=0;if(a[this.TAXA]){for(var f=0;f<a[this.TAXA].length;f++)e+=this.recursiveCount(a[this.TAXA][f],b,c,d);a[b]=e}return e+=c&&a[c]?a[c].length:0,a[b]&&(a[b]=e),e+d},this.parseMeta=function(a){var b={},c=this.getCoreRowType(a);b[c]=this.parseCore(a,c);for(var d=this.getExtensionRowTypes(a),e=0;e<d.length;e++)b[d[e]]=this.parseExtension(a,d[e],e);var f={coreRowType:c,extRowTypes:d,fileData:b,vesperAdds:{}};return void 0==c?f.error="JQuery cannot find element[attribute]: core[rowType] within xml.":b[c].error&&(f.error=b[c].error),f},this.parseCore=function(a,b){return this.parseFrag(a,'archive core[rowType="'+b+'"]',"id",b)},this.parseExtension=function(a,b,c){var d=this.parseFrag(a,'extension[rowType="'+b+'"]',"coreid",b);return d.extIndex=c,d},this.parseFrag=function(a,c,d,f){VESPER.log("thexml",typeof a,a);var g=$(a).find(c);if(void 0!==g[0]){var h=$(g[0]),i={},j=h.find("files location").contents();if(void 0!==j[0]){i.fileName=j[0].data,i.rowType=f,i.mappedRowType=this.recordURIMap[f]||f;for(var k in this.rowTypeDefaults)this.rowTypeDefaults.hasOwnProperty(k)&&(i[k]=void 0!==h.attr(k)?h.attr(k):this.rowTypeDefaults[k],VESPER.log("att",k,"#",i[k],"#"));VESPER.log(h.attr("fieldsEnclosedBy"));var l=+h.find(d).attr("index");i.idIndex=l;var m=h.find("field");VESPER.log("fieldsTerminatedBy",i.fieldsTerminatedBy),i.fieldIndex={},i.invFieldIndex=[],i.fieldData={},i.fieldIndex[d]=l,i.invFieldIndex[l]=d;for(var n=0;n<m.length;n++){var o=$(m[n]),p={};for(var q in VESPER.DWCAParser.fieldAttrNames)if(VESPER.DWCAParser.fieldAttrNames.hasOwnProperty(q)){var r=VESPER.DWCAParser.fieldAttrNames[q],s=o.attr(q);"xs:integer"==r&&(s=+s),p[q]=s}p.shortTerm=b(e(p.term));var t=p.index,u=p.shortTerm;p.discreteTermList=VESPER.DWCAParser.discreteTermSet[u]?{}:void 0,isNaN(t)||(i.fieldIndex[u]=t,i.invFieldIndex[i.fieldIndex[u]]=u),i.fieldData[u]=p}return i.filteredFieldIndex={},i.filteredInvFieldIndex=[],VESPER.log("filenames: ",j),i}return{error:"JQuery cannot find path [files location] within "+c+" section of xml."}}return{error:"JQuery cannot find path ["+c+"] within xml."}},this.updateFilteredLists=function(a,b){var c=0;a.filteredInvFieldIndex.length=0;var d=a.invFieldIndex[a.idIndex];$.each(a.filteredFieldIndex,function(b){b!==d&&(a.filteredFieldIndex[b]=void 0)});for(var e=0;e<b.length;e++)if(b[e]){var f=a.invFieldIndex[e];a.filteredFieldIndex[f]=c,a.filteredInvFieldIndex[c]=f,c++}VESPER.log("fi",a.fieldIndex,a.filteredFieldIndex,a.invFieldIndex,a.filteredInvFieldIndex)},this.getCoreRowType=function(a){var b=$(a).find("core"),c=$(b[0]).attr("rowType");return VESPER.log("core",c),c},this.getExtensionRowTypes=function(a){for(var b=$(a).find("extension"),c=[],d=0;d<b.length;d++){var e=$(b[d]).attr("rowType");c.push(e)}return c},this.getFilteredIdIndex=function(a){var b=a.fileData[a.coreRowType];return b.filteredFieldIndex[b.invFieldIndex[b.idIndex]]},this.selectNodes=function(a,b,c,d){var e=0,f=c.getData();if(void 0!==a&&a.length>0)for(var g in f)if(f.hasOwnProperty(g)){var h=f[g],i=b(c,h,a);i&&(e++,d(g))}return e},this.loadxsd("dwca.xsd"),this},VESPER.Filters=new function(){return this.nameLabelFilter=function(a,b){VESPER.log("regex",b);var c=a.getMetaData(),d=c.vesperAdds.nameLabelField,e=c.fileData[d.rowType],f=e.extIndex,g=e.filteredFieldIndex[d.fieldType],h=[],i=function(a,b,c){var d=a.getRowRecords(b,f);if(void 0==f&&(h[0]=d,d=h),d)for(var e=d.length;--e>=0;){var i=d[e][g];if(i&&null!=i.match(c))return!0}return!1};a.getSelectionModel().setUpdating(!0);var j=VESPER.DWCAParser.selectNodes(b,i,a,function(b){a.getSelectionModel().addToMap(b)});return a.getSelectionModel().setUpdating(!1),j},this},VESPER.modelComparisons=new function(){function a(a,b){var c=MGNapier.NapVisLib.countObjProperties(a.getData()),d=MGNapier.NapVisLib.countObjProperties(b.getData());return d>c?a:b}function b(a,b){for(var c=Math.min(a?a.length:0,b?b.length:0),d=0;c>d;d++)if(a[d]!==b[d])return d;return c}function c(a,c,d,e,f,g){var h=c.length;if(d>0){var i=e[d-1],j=Math.min(h,i[1].length),k=b(c,i[1]);k>=10&&k===j&&(f.addToMap(i[0]),g.addToMap(a))}if(d<e.length){var l=e[d],m=Math.min(h,l[1].length),n=b(c,l[1]);n>=10&&n===m&&(f.addToMap(l[0]),g.addToMap(a))}}function d(a,b){for(var c,d,e,f=0,g=a.length-1;g>=f;)if(e=c=(f+g)/2|0,d=a[c][1],b>d)f=c+1;else{if(!(d>b))return c;g=c-1}return~Math.max(g,f)}return this.modelCoverageToSelection=function(b,e,f,g){var h=a(b,e),i=h===b?e:b,j=h===b?f:g,k=h===b?g:f,l=[h.getExplicitTaxonomy(),h.getData()],m=[i.getExplicitTaxonomy(),i.getData()],n=h.getSelectionModel(),o=i.getSelectionModel();n.clear(),o.clear(),n.setUpdating(!0),o.setUpdating(!0);for(var p=[],q=0;q<l.length;q++){var r=l[q];if(r)for(var s in r)if(r.hasOwnProperty(s)){var t=h.getDataPoint(r[s],j);p.push([s,t])}}var u={base:0};MGNapier.NapVisLib.resetStopwatch(u),p.sort(function(a,b){return a[1]<b[1]?-1:a[1]>b[1]?1:0}),VESPER.log("sort",MGNapier.NapVisLib.elapsedStopwatch(u),"ms"),MGNapier.NapVisLib.resetStopwatch(u);for(var v,w,x=0,y=0;y<m.length;y++){var r=m[y];if(r)for(var s in r)if(r.hasOwnProperty(s)){var t=i.getDataPoint(r[s],k),z=v===t?w:d(p,t);v=t,w=z,x++,z>=0?(n.addToMap(p[z][0]),o.addToMap(s)):(z=~z,c(s,t,z,p,n,o))}}VESPER.log("search",MGNapier.NapVisLib.elapsedStopwatch(u),"ms"),VESPER.log("Done",x,"comparisons"),n.setUpdating(!1),o.setUpdating(!1)},this.test1=function(){for(var a=[["345","ant"],["2013","bat"],["45","cat"],["133","dog"],["708","eel"]],b=["rabbit","aardvark","cat","cattus fattus"],c=0;c<b.length;c++)console.log("binary test",b[c],d(a,b[c]))},this},VESPER.FilterView=function(a){function b(){var b=d3.select(a).select("span input");b.on("keyup",function(){(f||13===(d3.event.keyCode|d3.event.charCode))&&(c.getSelectionModel().clear(),VESPER.Filters.nameLabelFilter(c,d3.select(this).property("value")))})}var c,d,e=this,f=!0;this.set=function(a,b){d=a.identifyingField,c=b},this.go=function(){var c=d3.select(a).attr("id")+"Text",d=d3.select(a).append("span");d.append("label").attr("for",c).text($.t("search.label")),d.append("input").attr("type","text").attr("id",c);var e=d.append("div");e.append("input").attr("name",c+"TypeAhead").attr("value",f?"checked":"").attr("checked",f).attr("type","checkbox").on("click",function(){f=d3.event.target.checked}),e.append("label").attr("for",c+"TypeAhead").text($.t("search.keystrokeLabel")),b(),this.update()},this.update=function(){},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(a)),c.removeView(e),c=null,VESPER.DWCAHelper.twiceUpRemove(a)}},VESPER.modelBag=[],VESPER.RecordDetails=function(a){function b(b,c,d){var e=b.select("."+c);if(e.empty()){d3.select(a).append("table").attr("class",c),e=d3.select(a).select("."+c);var f=e.append("tr").selectAll("th").data(d);f.enter().append("th").text(function(a){return a})}return e}function c(b){h.getNodeFromID(b)?(i=b,n.update()):d3.select(a).select("div").select("span.vesperWarning").style("display",null)}function d(b){b&&(d3.select(a).select("input").property("value",b),c(b))}function e(a){function b(a){a.substring&&"http://"===a.substring(0,7)?d3.select(this).append("a").attr("href",function(a){return a}).attr("target","_blank").text(function(a){return a}):d3.select(this).text(function(a){return a})}var c=a.selectAll("td").data(function(a){return a});c.enter().append("td"),c.each(b).on("click",d).style("cursor","pointer")}function f(a,b,c,d){var e=h.getMetaData().fileData;VESPER.log("table",d,"#"+b+"Table",c);var f=d3.select(d).select("#"+b+"Table"),g=f.selectAll("tr.hrow"),i=g.data([0]);i.enter().append("tr").attr("class","hrow");var j=e[c].filteredInvFieldIndex;g=f.selectAll("tr.hrow");var k=g.selectAll("th").data(j);k.text(function(a,b){return j[b]}),k.enter().append("th").text(function(a,b){return j[b]})}function g(a,b,c,d){var e=b,f=d3.select(d).select("#"+b+"Table"),g=f.selectAll("tr.drow"),h=g.data(a[e]);h.exit().remove(),h.enter().append("tr").attr("class","drow").attr("id",function(a,c){return b+c});for(var i=0;i<a[e].length;i++){var j=a[e][i],k=f.select("#"+b+i).selectAll("td"),l=k.data(j);l.exit().text(""),l.text(function(a){return a}),l.enter().append("td").text(function(a){return a})}}var h,i,j,k="mappedRowType",l="extDetailTable",m="detailTable",n=this;this.set=function(a,b){var c=b.makeIndices([a.identifyingField]);j=c[0],h=b},this.go=function(){var b=d3.select(a),d=b.append("div"),e=b.attr("id")+"textinput";d.append("label").attr("for",e).text($.t("search.findLabel")),d.append("input").attr("type","text").attr("id",e),d.append("span").attr("class","vesperWarning").text($.t("search.noResult")).style("display","none");var f=b.select("input");f.on("keyup",function(){if(d.select("span.vesperWarning").style("display","none"),13===(d3.event.keyCode|d3.event.charCode)){var a=d3.select(this).property("value");c(a)}})},this.update=function(){var c=d3.select(a);if(void 0!==i){for(var d=h.getMetaData(),n=d.fileData,o=h.getNodeFromID(i),p=b(c,m,["Field","Value"]),q=[],r=n[d.coreRowType].filteredInvFieldIndex,s=h.getTaxaData(o),t=0;t<s.length;t++)s[t]&&q.push([r[t],s[t]]);var u=p.selectAll("tr.nonHeader").data(q);u.exit().remove(),e(u);var v=u.enter().append("tr").attr("class","nonHeader");e(v);var w=d3.keys(h.getExtraData(o)),x=c.selectAll("table."+l),y=x.data(w);y.exit().remove(),y.enter().append("table").attr("class",l).attr("id",function(a){return a+"Table"});for(var z={},A=0;A<d.extRowTypes.length;A++){var B=d.extRowTypes[A];z[n[B][k]]=B}for(var t=0;t<w.length;t++)f(h.getExtraData(o),w[t],z[w[t]],a),g(h.getExtraData(o),w[t],z[w[t]],a);var C=b(c,"synTable",[$.t("search.recordSyn")]),D=h.getSynonyms(o);if(q=[],D)for(var t=0;t<D.length;t++){var E=D[t];q.push([h.getIndexedDataPoint(E,j)])}C.style("display",D?null:"none"),u=C.selectAll("tr.nonHeader").data(q),u.exit().remove(),e(u),v=u.enter().append("tr").attr("class","nonHeader"),e(v);var F=b(c,"specTable",[$.t("search.recordSpec")]),G=h.getSpecimens(o);if(q=[],G)for(var t=0;t<G.length;t++){var H=G[t];q.push([h.getIndexedDataPoint(H,j)])}F.style("display",G?null:"none"),u=F.selectAll("tr.nonHeader").data(q),u.exit().remove(),e(u),v=u.enter().append("tr").attr("class","nonHeader"),e(v)}c.selectAll("table").style("visibility",void 0===i?"collapse":"visible")},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(a)),i=void 0,h.removeView(n),h=null,VESPER.DWCAHelper.twiceUpRemove(a)}},VESPER.Sanity=function(a){function b(){e=k(),f=l(),g=m(),i=!1}var c,d,e,f,g,h=this,i=!0,j=100;this.set=function(a,b){c=b,VESPER.log("sanity model",c)},this.go=function(){d=this,this.update()};var k=function(a){var b=[],d=[],e=c.getData(),f=VESPER.DWCAParser.neccLists;for(var g in f)if(f.hasOwnProperty(g)){var h=c.makeIndices(f[g]),i=MGNapier.NapVisLib.countNulls(h);0===i&&(b.push(h),d.push({listName:g,all:0,some:0}))}var j=0;for(var k in e)if(e.hasOwnProperty(k)&&(!a||a(c,k))){j++;for(var l=0;l<b.length;l++){for(var m=b[l],n=!1,o=!0,p=0;p<m.length;p++){var q=c.getIndexedDataPoint(e[k],m[p]);void 0==q?n=!0:o=!1}n&&d[l].some++,o&&d[l].all++}}return{outputs:d,dataCount:j}},l=function(a){for(var b=d3.entries(c.getMetaData().fileData),d=c.getData(),e={},f=0;f<b.length;f++){var g=b[f].value.filteredInvFieldIndex,h=b[f].value.mappedRowType;e[h]={};for(var i=0;i<g.length;i++)e[h][g[i]]={recordType:h,name:g[i],count:0}}var j=b.filter(function(a){return a.value.filteredInvFieldIndex.length>0});for(var k in d)if(d.hasOwnProperty(k)&&(!a||a(c,k)))for(var f=0;f<j.length;f++){var l=j[f].value,g=l.filteredInvFieldIndex,m=c.getRowData(d[k],l.extIndex);m&&l.extIndex&&(m=m[0]);for(var h=l.mappedRowType,i=0;i<g.length;i++){var n=g[i];(void 0==m||void 0==m[i])&&e[h][n].count++}}var o={};for(var p in e)if(e.hasOwnProperty(p)){var q=e[p];for(var r in q)q.hasOwnProperty(r)&&(o[p+" "+r]=q[r])}return o},m=function(){for(var a=d3.entries(c.getMetaData().fileData),b={},d=0;d<a.length;d++){var e=a[d].value.fieldData;for(var f in e)if(e.hasOwnProperty(f)){var g=d3.values(e[f].discreteTermList);g.length>0&&(b[f]={name:f,count:g.length})}}return b},n=function(a,b){return a.getSelectionModel().contains(b)};this.update=function(){function d(a,b){var c=s.select("table."+a);if(c.empty()){var d=s.append("table").attr("class",a).append("tr");d.selectAll("th").data(b).enter().append("th").attr("class","sanityTableHeading").text(function(a){return a})}return s.select("table."+a)}function h(a){var b=s.select("table."+a);b.remove()}function m(a,b){a.exit().remove(),a.enter().append("tr").attr("class","sanityRow"),a.each(b)}function o(a){function b(a,b){var c=H[b].func?H[b].func(a.value):a.value;return a.value.toString()+(isNaN(a.value)||void 0===c?"":" ("+F(c)+")")}for(var c=[],d=0;d<H.length;d++){var e=H[d].name;void 0!==a[e]&&c.push({key:e,value:a[e]})}var f=d3.select(this).selectAll("td").data(c);f.enter().append("td").attr("class",function(a,b){return H[b]&&H[b].klass?H[b].klass:null
}),f.select("div").empty()&&(f.append("div").attr("class",function(a,b){var c=H[b].func===r?"selected":"unselected";return c}),f.selectAll("div").style("height","10px")),f.select("div").style("width",function(a,b){var c=H[b].func?H[b].func(a.value):a.value;return isNaN(a.value)?0:Math.min(j,c*j)+"px"}),f.select("span.sanityBarText").empty()&&f.append("span").attr("class","sanityBarText"),f.select("span.sanityBarText").text(b),f.attr("title",b)}function p(){return void 0}function q(a){return a/x}function r(a){return t>0?a/t:0}var s=d3.select(a);i&&b();for(var t=c.getSelectionModel().values().length,u=k(n),v=l(n),w=e.outputs,x=e.dataCount,y=0;y<w.length;y++){var z=w[y],A=u.outputs[y];z.selSome=A.some,z.selAll=A.all}for(var B in f)if(f.hasOwnProperty(B)){var C=f[B],D=v[B];C.selCount=D.count}var E=s.select("div.sanityHeader");E.empty&&s.append("div").attr("class","sanityHeader").append("p"),s.select("div.sanityHeader").select("p").text(x+" Records"+(t>0?", "+t+" Selected":""));var F=d3.format(".2%"),G=d("visSanityTests",["Vis Type","Partial records","No records","Partial records (sel)","No records (sel)"]),H=[{name:"listName",func:p,klass:"showSanityText"},{name:"some",func:q,klass:"dontShowSanityText"},{name:"all",func:q,klass:"dontShowSanityText"},{name:"selSome",func:r,klass:"dontShowSanityText"},{name:"selAll",func:r,klass:"dontShowSanityText"}];m(G.selectAll("tr.sanityRow").data(w),o),$.isEmptyObject(f)||(G=d("fieldSanityTests",["Record Type","Field Type","No value","No value (sel)"]),H=[{name:"recordType",func:p,klass:"showSanityText"},{name:"name",func:p,klass:"showSanityText"},{name:"count",func:q,klass:"dontShowSanityText"},{name:"selCount",func:r,klass:"dontShowSanityText"}],m(G.selectAll("tr.sanityRow").data(d3.values(f)),o)),$.isEmptyObject(g)?h("vocabSanityTests"):(G=d("vocabSanityTests",["Field Type","Vocabulary Size"]),H=[{name:"name",func:p,klass:"showSanityText"},{name:"count",func:p,klass:"showSanityText"}],m(G.selectAll("tr.sanityRow").data(d3.values(g)),o))},this.updateVals=this.update,this.destroy=function(){VESPER.DWCAHelper.recurseClearEvents(d3.select(a)),c.removeView(h),c=null,VESPER.DWCAHelper.twiceUpRemove(a)}},VESPER.Tree=function(a){function b(a){return void 0!==a&&"*"===a.charAt(0)?"url(#"+J+")":null}function c(a){var b=v.getObjectCount(a),c=v.getSelectedObjectCount(a),d=c>0&&b>0?Math.log(c+1)/Math.log(b+1):0;return d}function d(){var b=d3.select(a).append("div").attr("class","visControl").attr("id",w+"controls");VESPER.DWCAHelper.addDragArea(b),MGNapier.NapVisLib.makeSectionedDiv(b,[{header:$.t("tree.sizeLabel"),sectionID:"Space"},{header:$.t("tree.layoutLabel"),sectionID:"Layout"},{header:$.t("tree.sortLabel"),sectionID:"Sort"}],"section");var c=d3.select(a+"controlsSpace").selectAll("button.allocChoice").data(d3.entries(M),function(a){return a.key}),d=c.enter().append("span").attr("class","fieldGroup");d.append("input").attr("class","allocChoice").attr("type","radio").attr("id",function(a){return w+a.key}).attr("name",function(){return w+"alloc"}).property("checked",function(a){return r===a.value}).on("change",function(a){return r=a.value,g(q),!1}),d.append("label").attr("for",function(a){return w+a.key}).html(function(a){return N[a.key]});var e=d3.select(a+"controlsLayout").selectAll("button.layoutChoice").data(d3.entries(Q),function(a){return a.key}),f=e.enter().append("span").attr("class","fieldGroup");f.append("input").attr("class","layoutChoice").attr("type","radio").attr("id",function(a){return w+a.key}).attr("name",function(){return w+"layout"}).property("checked",function(a){return s===a.value}).on("change",function(a){s=a.value;var b=n.selectAll(".treeNode");return i(b),b.remove(),g(q),!1}).html(function(a){return a.key}),f.append("label").attr("for",function(a){return w+a.key}).html(function(a){return R[a.key]});var h=d3.select(a+"controlsSort").selectAll("button.sortChoice").data(d3.entries(K),function(a){return a.key}),j=h.enter().append("span").attr("class","fieldGroup");j.append("input").attr("class","sortChoice").attr("type","radio").attr("id",function(a){return w+a.key}).attr("name",function(){return w+"sort"}).property("checked",function(a){return t===a.value}).on("change",function(a){return t=a.value,g(q),!1}).html(function(a){return a.key}),j.append("label").attr("for",function(a){return w+a.key}).html(function(a){return L[a.key]}),$("#"+w+"controls").draggable()}function e(a){var b=v.getNodeFromID(a);return void 0==b&&(b=v.getNodeFromID(a.substring(1))),b}function f(a){var b=v.getDescendantCount(a)||0;if(!b){var c=v.getSpecimens(a);c&&(b=c.length)}return b}function g(a){F&&(VESPER.alerts&&alert("about to calc layout"),F=!1),r.size(s.sizeBounds()).cutoff(s.cutoffVal).sort(t),VESPER.log("what alloc reports ",r.size()),VESPER.log("root",a);var b=r.nodes(a);VESPER.log(b.length,b),q=a;var c=n.selectAll(".treeNode").data(b,function(a){return a.id});s.prep(b),s.removeOld(c.exit());var d=c.exit().empty()?0:C;s.redrawExistingNodes(c,d),d+=c.empty()?0:D;var e=s.makeNew(c.enter());MGNapier.NapVisLib.d3fadeInNewGroups([e],E,d)}function h(a){var b=v.getIndexedDataPoint(a,A);if(!v.getSelectedDescendantCount(a)||v.getSelectionModel().contains(b))return a;var c=v.getSubTaxa(a);if(c){for(var d,e=0,f=0;f<c.length;f++){var g=c[f],i=v.getIndexedDataPoint(g,A);v.getSelectionModel().contains(i)?e++:v.getSelectedDescendantCount(g)>0&&(e++,d=g)}if(e>1)return a;d&&(a=h(d))}return a}function i(a){a.on("click",null).on("mouseover",null).on("mouseout",null).on("contextmenu",null)}function j(a){a.on("click",function(a){var b=e(a.id);g(b===q&&void 0!=b.parent?b.parent:b)}).on("mouseover",function(a){d3.select(this).selectAll("*").classed("highlight",!0);var b=e(a.id),c=y.tooltipString(b,v,x);VESPER.tooltip.updateText(v.getLabel(b),c),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).selectAll("*").classed("highlight",!1)}).on("contextmenu",function(a){k(e(a.id)),d3.event.preventDefault()})}function k(a){v.getSelectionModel().clear();var b=[];l(a,b,!0),v.getSelectionModel().addAllToMap(b)}function l(a,b,c){var d=v.getIndexedDataPoint(a,A);b.push(d);var e=v.getSubTaxa(a);if(e)for(var f=e.length;--f>=0;)l(e[f],b,c);var g=v.getSpecimens(a);if(g)for(var f=g.length;--f>=0;)l(g[f],b,c);var h=v.getSynonyms(a);if(h)for(var f=h.length;--f>=0;)l(h[f],b,!1)}var m,n,o,p,q,r,s,t,u,v,w,x,y=this,z=d3.behavior.zoom();z.scaleExtent([1,4]);var A,B,C=400,D=1e3,E=400,F=!0,G={},H={},I="hatch",J="hatch",K={Alpha:function(a,b){var c=v.getLabel(a),d=v.getLabel(b);return d>c?-1:c>d?1:0},Descendants:function(a,b){var c=f(a)||0,d=f(b)||0;return c>d?-1:d>c?1:0},Selected:function(a,b){var c=v.getSelectionModel(),d=c.contains(v.getIndexedDataPoint(a,A)),e=c.contains(v.getIndexedDataPoint(b,A));return d===e?0:d===!0?-1:1},SelectedDesc:function(a,b){var c=v.getSelectedDescendantCount(a),d=v.getSelectedDescendantCount(b);return c===d?0:void 0===c?1:void 0===d?-1:c-d}},L={Alpha:$.t("tree.sortAlpha"),Descendants:$.t("tree.sortDesc"),Selected:$.t("tree.sortSel"),SelectedDesc:$.t("tree.sortDescSel")};this.tooltipString=function(){var a="Placeholder";return a};var M={bottomUp:MGNapier.AdaptedD3.bottomUp().sort(null).value(function(a){return v.getLeafValue(a)}).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,A)}),bottomUpLog:MGNapier.AdaptedD3.logPartition().sort(null).value(function(a){return v.getLeafValue(a)}).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,A)}),topDown:MGNapier.AdaptedD3.topDown().sort(null).value(null).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,A)})},N={bottomUp:$.t("tree.sizeBottomUp"),bottomUpLog:$.t("tree.sizeBottomUpLog"),topDown:$.t("tree.sizeTopDown")},O={cutoffVal:4,sizeBounds:function(){return[o[1],o[0]]},booleanSelectedAttrs:function(a){a.attr("class",function(a){return v.getSelectionModel().contains(a.id)?"selected":"unselected"}).attr("y",function(a){return a.x}).attr("x",function(a){return a.y}).attr("width",function(a){return a.dy}).attr("height",function(a){return a.dx})},widthLogFunc:function(a){var b=e(a.id);return c(b)*a.dy},xFunc:function(a){var b=e(a.id),d=c(b);return a.y+(1-d)*a.dy},propSharedAttrs:function(a,b,c){a.attr("class","holdsSelected").attr("y",function(a){return a.x}).attr("x",b).attr("height",function(a){return a.dx}).attr("width",c)},sharedTextAttrs:function(a){function b(a,b){return a.dx>a.dy&&b.getComputedTextLength()<a.dx-4}a.attr("transform",function(a){var c=b(a,this);if(c){var d=this.getComputedTextLength(),e=Math.max(0,(a.dx-d)/2);return"translate ("+a.y+","+a.x+")  rotate (90 0 0) translate ("+e+", -"+a.dy/2+")"}return"translate ("+a.y+","+(a.x+Math.max((a.dx-14)/2+14,14))+") "}).attr("clip-path",function(a){return b(a,this)?null:"url(#"+w+"depthclipR0)"})},prep:function(a){n.attr("transform","translate(0,0)"),O.makeTextClips(a)},removeOld:function(a){i(a),MGNapier.NapVisLib.d3fadeAndRemoveGroups([a],C,0)},makeNew:function(a){var c=a.append("svg:g").attr("class","treeNode").style("opacity",0).call(j);return c.append("svg:rect").call(O.booleanSelectedAttrs).style("fill",function(a){return b(a.id)}),c.append("svg:rect").style("opacity",.75).call(O.propSharedAttrs,this.xFunc,this.widthLogFunc),c.append("svg:text").text(function(a){return v.getLabel(e(a.id))}).style("display",function(a){return a.dx>15&&a.dy>15?null:"none"}).call(O.sharedTextAttrs),c},redrawExistingNodes:function(a,b){a.select("rect:not(.holdsSelected)").transition().delay(b).duration(D).call(O.booleanSelectedAttrs),a.select("rect.holdsSelected").transition().delay(b).duration(D).call(O.propSharedAttrs,this.xFunc,this.widthLogFunc),a.select("text").style("display",function(a){return a.dx>15&&a.dy>15?null:"none"}).transition().delay(b).duration(D).call(O.sharedTextAttrs)},makeTextClips:function(a){for(var b=m.node().getBoundingClientRect().height,c=[],d=0;d<a.length;d++){var f=a[d],g=e(f.id);c[g.depth]||(c[g.depth]={depth:g.depth,x:f.y,y:-20,width:f.dy,height:b+20})}var h=m.select("defs").selectAll(".napierClipR").data(c),i=function(a){a.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height})};h.exit().remove(),h.select("rect").call(i),h.enter().append("clipPath").attr("class","napierClipR").attr("id",function(a){return w+"depthclipR"+a.depth}).append("rect").call(i)}},P={cutoffVal:.05,sizeBounds:function(){var a=d3.min(o)/2;return VESPER.log("DIMS",o,a),[2*Math.PI,a*a]},booleanSelectedAttrs:function(a){a.attr("class",function(a){return v.getSelectionModel().contains(a.id)?"selected":"unselected"})},propSelectedAttrs:function(a){a.attr("class","holdsSelected")},sharedTextAttrs:function(a){a.attr("transform",function(a){var b=e(a.id);if(0===b.depth)return"translate (0,0)";var c=(a.x+a.dx/2)*(360/(2*Math.PI))-90;return"rotate ("+c+" 0 0) translate ("+Math.sqrt(a.y)+",0) "}).style("text-anchor",function(a){return 0===e(a.id).depth?"middle":null}).style("display",function(a){return a.dx>.1&&Math.sqrt(a.y+a.dy)-Math.sqrt(a.y)>20?null:"none"}).attr("clip-path",function(a){return"url(#"+w+"depthclip"+e(a.id).depth+")"})},arc:d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),parc:d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){var b=Math.sqrt(a.y+a.dy),d=b-Math.sqrt(a.y),f=e(a.id),g=c(f);return g*=g,b-g*d}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),cstash:function(a){G[a.id]={x0:a.x,dx0:a.dx,y0:a.y,dy0:a.dy}},pstash:function(a){H[a.id]={x0:a.x,dx0:a.dx,y0:a.y,dy0:a.dy}},arcTween:function(a){var b=G[a.id];if(void 0===b&&VESPER.log("No STORE",a.id,a),b){var c=d3.interpolate({x:b.x0,dx:b.dx0,y:b.y0,dy:b.dy0},a);return function(a){var d=c(a);return b.x0=d.x,b.dx0=d.dx,b.y0=d.y,b.dy0=d.dy,P.arc(d)}}},parcTween:function(a){var b=H[a.id],c=d3.interpolate({x:b.x0,dx:b.dx0,y:b.y0,dy:b.dy0},a);return function(a){var d=c(a);return b.x0=d.x,b.dx0=d.dx,b.y0=d.y,b.dy0=d.dy,P.parc(d)}},prep:function(a){n.attr("transform","translate("+o[0]/2+","+o[1]/2+")"),P.makeTextClips(a)},removeOld:function(a){i(a),a.transition().delay(0).duration(0).each("end",function(){var a=d3.select(this).datum().id;G[a]=void 0,H[a]=void 0}),MGNapier.NapVisLib.d3fadeAndRemoveGroups([a],C,0)},makeNew:function(a){var c=a.append("svg:g").attr("class","treeNode").style("opacity",0).call(j);return c.append("path").attr("d",P.arc).call(P.booleanSelectedAttrs).style("fill",function(a){return b(a.id)}).each(P.cstash),c.append("path").attr("d",P.parc).style("opacity",.75).call(P.propSelectedAttrs).each(P.pstash),c.append("svg:text").text(function(a){return v.getLabel(e(a.id))}).call(P.sharedTextAttrs),c},redrawExistingNodes:function(a,b){a.select("path:not(.holdsSelected)").call(P.booleanSelectedAttrs).transition().delay(b).duration(D).attrTween("d",P.arcTween).each("end",P.cstash),a.select("path.holdsSelected").call(P.propSelectedAttrs).transition().delay(b).duration(D).attrTween("d",P.parcTween).each("end",P.pstash);var c=function(){d3.select(this).call(P.sharedTextAttrs)};a.select("text").style("display","none").transition().delay(b).duration(D).each("end",c)},makeTextClips:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],f=e(d.id);b[f.depth]||(b[f.depth]={depth:f.depth,inner:Math.sqrt(d.y),outer:Math.sqrt(d.y+d.dy)})}var g=m.select("defs").selectAll(".napierClip").data(b),h=function(a){a.attr("cx",0).attr("cy",0).attr("r",function(a){return a.outer-a.inner})};g.exit().remove(),g.select("circle").call(h),g.enter().append("clipPath").attr("class","napierClip").attr("id",function(a){return w+"depthclip"+a.depth}).append("circle").call(h)}},Q={Icicle:O,Sunburst:P},R={Icicle:$.t("tree.layoutIcicle"),Sunburst:$.t("tree.layoutSunburst")};this.set=function(b,c){x=c.makeIndices([b.identifyingField,b.rankField]),A=x[0],B=x[1],o=MGNapier.NapVisLib.getWidthHeight(d3.select(a).node()),v=c},this.go=function(){u=this,d3.select(a).style("overflow","hidden"),w=a.substring(1),J=I+w,m=d3.select(a).append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),m.append("defs");var b=m.select("defs").append("pattern").attr("id",J);b.attr("x",0).attr("y",0).attr("width",4).attr("height",4).attr("patternUnits","userSpaceOnUse").attr("viewBox","0 0 4 4 ");var c=[0,2];b.selectAll("rect").data(c).enter().append("rect").attr("x",function(a,b){return 2*b}).attr("y",function(a,b){return 2*b}).attr("width",2).attr("height",2).attr("class","indHatch").classed("unselected",!0),n=m.append("svg:g").attr("class","treeSVG");var f=v.getSelectionModel().values(),g=1===f.length?e(f[0]):y.getRoot(v);return void 0===g?(VESPER.log("no root defined for tree",y.getRoot(v),g,f),void 0):(p=g,r=M.bottomUpLog,t=K.Alpha,s=Q.Sunburst,d(),this.update(),void 0)},this.update=function(){var a=v.getSelectionModel().values(),b=1===a.length?e(a[0]):y.getRoot(v);VESPER.log("Root",b,a[0]),v.countSelectedDesc(y.getRoot(v),A),b=h(y.getRoot(v)),g(b)},this.getRoot=function(a){return a.getImplicitRoot()},this.updateVals=this.update,this.redraw=function(){var a=n.selectAll(".treeNode");s.redrawExistingNodes(a,0)},this.destroy=function(){i(n.selectAll(".treeNode")),n.selectAll(".treeNode").remove(),$(a+"controls").draggable("destroy"),v.removeView(y),v=null,p=null,q=null,G={},H={},VESPER.DWCAHelper.twiceUpRemove(a)}},VESPER.ImplicitTaxonomy=function(a){var b=new VESPER.Tree(a);return b.type="impTree",b.getRoot=function(a){return a.getImplicitRoot()},b.tooltipString=function(a,b,c){console.log("tooltip node",a);for(var d=b.getDescendantCount(a),e=b.getSelectedDescendantCount(a),f=b.getSubTaxa(a),g="",h=0;h<c.length;h++)c[h]&&(g+=(h>0?"<br>":"")+c[h].fieldType+": "+b.getIndexedDataPoint(a,c[h]));g+=(void 0===f?"":"<hr>"+$.t("tree.taxaTooltip",{count:d}))+(e>0?void 0===f?"":"<br>"+$.t("tree.taxaSelTooltip",{count:e}):"");var i=b.getSynonymCount(a);if(i){g+="<hr>"+$.t("tree.synTooltip",{count:i});var j=b.getSelectedSynonymCount(a);j&&(g+="<br>"+$.t("tree.synSelTooltip",{syn:j}))}var k=b.getSynonyms(a);if(k)for(g+="<hr><i>"+$.t("tree.synLabel")+"</i>",h=0;h<k.length;h++){var l=b.getIndexedDataPoint(k[h],c[0]),m=b.getSelectionModel().contains(l)?"selected":"";g+='<br><span class="'+m+'">'+l+"</span>: "+b.getLabel(k[h])}return g},b},VESPER.ExplicitTaxonomy=function(a){var b=new VESPER.Tree(a);return b.type="expTree",b.sepArray=["<hr>","<br>"],b.getRoot=function(a){return a.getExplicitRoot()},b.tooltipString=function(a,b,c){console.log("tooltip node",a);for(var d=b.getSpecimens(a),e="",f=10,g=0;g<c.length;g++)c[g]&&(e+=(g>0?"<br>":"")+c[g].fieldType+": "+b.getIndexedDataPoint(a,c[g]));var h=b.getSpecimenCount(a);if(h){e+="<hr>"+$.t("tree.specTooltip",{count:h});var i=b.getSelectedSpecimenCount(a);i&&(e+="<br>"+$.t("tree.specSelTooltip",{count:i}))}if(d){for(e+="<hr><i>"+$.t("tree.specLabel")+"</i>",g=0;g<Math.min(d.length,f);g++){var j=d[g],k=b.getIndexedDataPoint(j,c[0]),l=b.getSelectionModel().contains(k)?"selected":"";e+='<br><span class="'+l+'">'+k+"</span>, "+b.getLabel(j)}d.length-f>0&&(e+="<br>"+$.t("tree.andMore",{count:d.length-f}))}return e},b},VESPER.tooltip=new function(){this.holdDuration=1e4,this.fadeDuration=200;var a=this;return this.init=function(){var a=d3.select("body").selectAll("#vesperTooltip").data([0]).enter().append("div").attr("id","vesperTooltip").attr("class","vesperTooltip").style("visibility","hidden");a.append("h2"),a.append("p")},this.setToFade=function(){var b=d3.select("#vesperTooltip");b.transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})},this.updateText=function(b,c){var d=d3.select("#vesperTooltip");d.select("h2").text(b),d.select("p").html(c),d.style("visibility","visible").style("opacity",null).transition().duration(a.holdDuration).each("end",function(){d3.select(this).transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})})},this.updatePosition=function(a){var b=d3.select("#vesperTooltip");b.style("top",a.pageY+10+"px").style("left",a.pageX+10+"px")},this},VESPER.VisLauncher=function(a,b){function c(a){var b=k.makeIndices(a.attList),c=MGNapier.NapVisLib.countNulls(b);return 0===b.length||a.matchAll&&0===c||!a.matchAll&&c<b.length}function d(a){var b=k.makeIndices(a.attList);return b.length>0}function e(b){d3.select(a).append("H3").text($.t("launcher.launchHeader"));var c=d3.select(a).append("div").attr("id",a+"Vis").selectAll("button").data(b),d=c.enter().append("button").attr("class","visChoice").attr("type","button").on("click",function(a){return o.makeVis(a,k),!1});d.append("img").attr("src",function(a){return a.icon||a.image}).attr("class","vesperIcon"),d.append("span").text(function(a){return a.title})}function f(){d3.select(a).append("H3").text($.t("launcher.selectHeader"));var b=d3.select(a).append("div").attr("id",a+"Sel");b.append("button").attr("type","button").text($.t("launcher.selectSave")),window.requestFileSystem?b.select("button").on("click",function(){MGNapier.NapVisLib.prepareForWrite(MGNapier.NapVisLib.writeArray,k.getSelectionModel().values())}):MGNapier.NapVisLib.html5LacksOnButton(b.select("button"),$.t("launcher.noFileWriter")),b.append("button").attr("type","button").text($.t("launcher.selectInvert")).on("click",function(){k.invertSelection()}),b.append("button").attr("type","button").text($.t("launcher.selectClear")).on("click",function(){k.getSelectionModel().clear(),k.getSelectionModel().update()}),b.selectAll("button").style("display","block").attr("class","safetyGap")}function g(){d3.select(a).append("H3").text($.t("launcher.compareHeader"));var b=d3.select(a).append("div").attr("id",a+"TComp"),c=$.t("launcher.compareLabel");b.append("button").attr("type","button").attr("class","compareVesperModel").text(c).on("click",function(){if(VESPER.modelBag.push({model:k}),VESPER.log("ModelBag",VESPER.modelBag),VESPER.modelBag.length>1)VESPER.modelComparisons.modelCoverageToSelection(VESPER.modelBag[0].model,VESPER.modelBag[1].model,VESPER.modelBag[0].model.getMetaData().vesperAdds.nameLabelField,VESPER.modelBag[1].model.getMetaData().vesperAdds.nameLabelField),VESPER.modelBag.length=0,d3.selectAll("button.compareVesperModel").classed("taxonomyCompareActive",!1).text(c);else{var a=d3.select(this);a.classed("taxonomyCompareActive",!0),d3.selectAll("button.compareVesperModel").filter("*:not(.taxonomyCompareActive)").text(c+" to "+k.name)}}),b.selectAll("button").style("display","block")}function h(a){var b=a.selectAll("button.visChoice");b.style("display",function(a){var b=c(a);return b?"block":"none"})}function i(a,b){a.append("button").attr("type","button").on("click",function(){b&&b.destroy&&b.destroy(),d3.select(d3.event.target).on("click",null)}).attr("title",$.t("launcher.closeTooltip")).append("img").attr("src",VESPER.imgbase+"close.png").attr("alt","Close")}function j(a,b){a.append("button").attr("type","button").on("click",function(){var a=d3.select(b),c=a.style("display");a.style("display","none"===c?null:"none"),d3.select(this).select("svg polygon").attr("points","none"===c?"0,12 12,12 6,0":"0,0 12,0 6,12")}).attr("title",$.t("launcher.hideTooltip")).append("svg").attr("width",13).attr("height",13).append("polygon").attr("points","0,12 12,12 6,0").attr("class","showHideColours")}var k,l,m,n,o=this;this.title="Controls",this.set=function(b,c){l=b.identifyingField,n=b.visChoiceData,m=MGNapier.NapVisLib.getWidthHeight(d3.select(a).node()),k=c},this.go=function(){var i=d3.select(a);if(e(n),h(i),f(),g(),$(function(){$(a).accordion({heightStyle:"content",collapsible:!0})}),b&&"on"===b.autoLaunch)for(var j=0;j<n.length;j++){var l=n[j];c(l)&&d(l)&&o.makeVis(l,k)}},this.update=function(){},this.updateVals=this.update,this.makeVis=function(a,b){var c=b.name+"view"+(a.multiple?b.getNextSessionModelViewID():"");c=c.replace(/\s+/g,"");var d=a.title+" "+b.name;if(d3.select("#"+c).empty()){var e=d3.select("#allVisDiv").append("div").attr("class","visWrapper").attr("id",c+"container").style("width",a.width?a.width:"50%"),f=e.append("div").attr("class","dragbar").attr("id",c+"dragBar"),g=f.append("div").attr("class","buttonBank");f.append("div").attr("class","visTitle").text(d),e.append("div").attr("class","vis").attr("id",c).style("height","null"!=a.height?a.height:"100%");var h=b.getMetaData().coreRowType,k=b.getMetaData().fileData,l=a.newVisFunc("#"+c);VESPER.log("newvis",l,l.set);var m=a.setupFunc()||{},n=k[h].filteredInvFieldIndex[VESPER.DWCAParser.getFilteredIdIndex(b.getMetaData())];m.identifyingField=n,l.set(m,b),b.addView(l),l.go(b),j(g,"#"+c),i(g,l),$("#"+c+"container").draggable({handle:"div.dragbar"})}},this.destroy=function(){for(var b=k.getSelectionModel().getVis(),c=0;c<b.length;c++)b[c]!==o&&(b[c].destroy&&b[c].destroy(),k.removeView(b[c]));var d=$.inArray(k,VESPER.modelBag);d>=0&&(VESPER.modelBag[d]=void 0,VESPER.modelBag=VESPER.modelBag.splice(d,1),VESPER.modelBag.length=0),VESPER.DWCAHelper.recurseClearEvents(d3.select(a)),k.removeView(o),k.getSelectionModel().clear(),k=null,VESPER.DWCAHelper.twiceUpRemove(a)}};