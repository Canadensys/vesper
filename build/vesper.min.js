/*! vespertemp 2013-11-08 */
function Model(){Model.prototype={getNodeFromID:function(){},getTaxaData:function(){},getSubTaxa:function(){}}}function DWCAModel(a,b){this.getMetaData=function(){return this.metaData},this.getData=function(){return this.data.records},this.getTaxonomy=function(){return this.data.tree},this.getRoot=function(){return this.data.root};var c=0,d=0,e=new SharedSelection;this.getSelectionModel=function(){return e},this.invertSelection=function(){var a=this.getData(),b=this.getSelectionModel(),c=[];for(var d in a)b.contains(d)||c.push(d);b.clear(),b.addAllToMap(c)},this.getExtraData=function(a){return a[VESPER.DWCAParser.EXT]},this.getTaxaData=function(a){return a[VESPER.DWCAParser.TDATA]},this.getSubTaxa=function(a){return a[VESPER.DWCAParser.TAXA]},this.getSpecimens=function(a){return a[VESPER.DWCAParser.SPECS]},this.getDescendantCount=function(a){return a.dcount},this.getSelectedDescendantCount=function(a){return a.sdcount},this.getLeafValue=function(a){var b=this.getSpecimens(a);return b?b.length:1},this.getNodeFromID=function(a){return this.getData()[a]||this.getTaxonomy()[a]},this.addView=function(a){e.addSingleVis(a),c++,d++},this.removeView=function(a){e.removeVis(a),c--},this.getViewCount=function(){return c},this.getNextSessionModelViewID=function(){return d},this.update=function(){e.update()},this.countSelectedDesc=function(a,b){var c=this.getSubTaxa(a),d=this.getSpecimens(a);if(void 0!=c||void 0!=d){if(a.sdcount=0,void 0!=c)for(var e=0,f=c.length;f>e;e++)a.sdcount+=this.countSelectedDesc(c[e],b);if(void 0!=d)for(var e=0,f=d.length;f>e;e++)a.sdcount+=this.getSelectionModel().contains(this.getTaxaData(d[e])[b])?1:0}return(a.sdcount||0)+(this.getSelectionModel().contains(this.getTaxaData(a)[b])?1:0)},this.data=b,this.metaData=a}var VESPER=function(){var a={};return a.alerts=!1,a.logRun=!0,a.log=function(){a.logRun&&console.log.apply(console,arguments)},a.imgbase="../img/",a.log(a),a}();VESPER.DWCAZipParse=new function(){var a,b,c,d,e,f,g,h,i,j,k,l="\\".charCodeAt(0),m=[],n=[],o=[],p=0,q=[],r=[],s=0;this.rowReader2=function(a){for(var b,d=0,e=0,h=0,q=i[d],t=[],u=a.length,v=!1,w=!1,x=0;u>x;x++){var y=a[x];if(b=y?y:0,f&&!w&&b==g&&(v=!v),!v&&(b===c||x===u-1)){if(q)if(h=x+(x===u-1?1:0),e===h)t.push(m[d]);else{var z=String.fromCharCode.apply(null,a.slice(e,h)),A=n[d],B=o[d];if(A){var C=A[z];C?(z=null,z=C):(A[z]=z,VESPER.log("new entry for field",d,"at lineNo",j,":",z,z.length))}else if(B){var C=r[B][z];C?(z=null,z=C):r[B][z]=z}s+=h-e,t.push(z)}d++,q=i[d]|!1,e=x+1}w=b==l}if(j++,(j%1e4===0||10998===j)&&(k?k(j,t):VESPER.log(j,": ",t)),j%100===0){var D=NapVisLib.makeTime();D-p>1e3&&(p=D,k?k(j,t):VESPER.log(j,": ",t))}return t},this.zipStreamSVParser2=function(b){VESPER.alerts&&alert("start partial parse with charcodes");var c,d,h,i=new Array(1024),j=1024,k=[],m=[],n=0,o=!1,q=!1,t=!0,u=0,v=NapVisLib.makeTime();for(p=v;(c=b(i,u,j-u))>0;){c+=u;var w=0;if(u=0,t){var x=String.fromCharCode(i[0])+String.fromCharCode(i[1])+String.fromCharCode(i[2]);VESPER.log("possbom [",x,"]"),"ï»¿"==x&&(VESPER.log("UTF8 bytemark detected"),w=3),t=!1}for(var y=w;c>y;y++){if(d=i[y],d>=128)if(d>=194&&224>d)c-1>y?d=((31&d)<<6)+(63&i[++y]):(u=1,y=c,d=void 0);else if(d>=224&&240>d)c-2>y?d=((255&d)<<12)+((63&i[++y])<<6)+(63&i[++y]):(u=c-y,y=c,d=void 0);else if(d>=240&&245>d)if(c-3>y){var z=((7&d)<<18)+((63&i[++y])<<12)+((63&i[++y])<<6)+(63&i[++y]);z-=65536;var A=(1023&z)+56320;d=A.charAt[0],h=A.charAt[1]}else u=c-y,y=c,d=void 0;f&&!o&&d==g?q=!q:q||d!=e?void 0!==d&&(k.push(d),void 0!==h&&(k.push(h),h=void 0)):(m.push(n>=a.ignoreHeaderLines?VESPER.DWCAZipParse.rowReader2(k):void 0),n++,k.length=0),o=d==l}if(u)for(var B=0;u>B;B++)i[B]=i[c-u+B]}return k.length>0&&m.push(VESPER.DWCAZipParse.rowReader2(k)),v=NapVisLib.makeTime()-v,VESPER.log("Time: ",v/1e3," secs."),VESPER.log("Shared Maps: "+r.length+", "+NapVisLib.countObjProperties(r[1])),VESPER.log("pulled out "+s+" characters from zip"),m},this.setNotifyFunc=function(a){k=a},this.set=function(k,l){a=k,b=k.fieldsTerminatedBy.replace("\\t","	").replace("\\n","\n"),d=k.linesTerminatedBy.replace("\\t","	").replace("\\n","\n"),f=k.fieldsEnclosedBy.replace('\\"','"'),i=l,h=i.indexOf(!0),c=b.charCodeAt(0),e=d.charCodeAt(0),g=f?f.charCodeAt(0):-1,j=0,VESPER.log(VESPER.DWCAParser.sharedValuesTerms);for(var p=0;p<k.invFieldIndex.length;p++){var s=k.invFieldIndex[p],t=k.fieldData[s];m[p]=t?t.default:void 0,n[p]=t?t.discreteTermList:void 0,o[p]=VESPER.DWCAParser.sharedValuesTerms[s],o[p]&&(r[o[p]]={})}q.length=0;for(var u=0;256>u;u++)q.push(String.fromCharCode(u));VESPER.log("readFields",i),VESPER.log("Q#",f,"#")}},VESPER.DWCAZipParseDB=new function(){var a,b,c,d,e,f,g,h,i,j,k,l="\\".charCodeAt(0),m=[],n=[],o=[],p=0,q=[],r=[],s=0;this.rowReader2=function(a){for(var b,d=0,e=0,h=0,q=i[d],t=[],u=a.length,v=!1,w=!1,x=0;u>x;x++){var y=a[x];if(b=y?y:0,f&&!w&&b==g&&(v=!v),!v&&(b===c||x===u-1)){if(q)if(h=x+(x===u-1?1:0),e===h)t.push(m[d]);else{var z=String.fromCharCode.apply(null,a.slice(e,h)),A=n[d],B=o[d];if(A){var C=A[z];C?(z=null,z=C):(A[z]=z,VESPER.log("new entry for",d,":",z,z.length))}else if(B){var C=r[B][z];C?(z=null,z=C):r[B][z]=z}s+=h-e,t.push(z)}d++,q=i[d]|!1,e=x+1}w=b==l}if(j++,(j%1e4===0||10998===j)&&(k?k(j,t):VESPER.log(j,": ",t)),j%100===0){var D=NapVisLib.makeTime();D-p>1e3&&(p=D,k?k(j,t):VESPER.log(j,": ",t))}return t},this.zipStreamSVParser2=function(b){VESPER.alerts&&alert("start partial parse with charcodes");var c,d,h=1024,i=new Array(h),j=[],k=[],m=0,n=!1,o=!1,q=!0,t=0,u=NapVisLib.makeTime();for(p=u;(c=b(i,t,h-t))>0;){c+=t;var v=0;if(t=0,q){var w=String.fromCharCode(i[0])+String.fromCharCode(i[1])+String.fromCharCode(i[2]);VESPER.log("possbom [",w,"]"),"ï»¿"==w&&(VESPER.log("UTF8 bytemark detected"),v=3),q=!1}for(var x=v;c>x;x++){var d=i[x];if(d>=128)if(d>=194&&224>d)c-1>x?d=((31&d)<<6)+(63&i[++x]):(t=1,x=c,d=void 0);else if(d>=224&&240>d)c-2>x?d=((255&d)<<12)+((63&i[++x])<<6)+(63&i[++x]):(t=c-x,x=c,d=void 0);else if(d>=240&&245>d)if(c-3>x){var y=((7&d)<<18)+((63&i[++x])<<12)+((63&i[++x])<<6)+(63&i[++x]);y-=65536,d=(1023&y)+56320}else t=c-x,x=c,d=void 0;f&&!n&&d==g?o=!o:o||d!=e?void 0!==d&&j.push(d):(k.push(m>=a.ignoreHeaderLines?DWCAZipParse.rowReader2(j):void 0),m++,j.length=0),n=d==l}if(t)for(var z=0;t>z;z++)i[z]=i[c-t+z]}return j.length>0&&k.push(DWCAZipParse.rowReader2(j)),u=NapVisLib.makeTime()-u,VESPER.log("Time: ",u/1e3," secs."),VESPER.log("Shared Maps: "+r.length+", "+NapVisLib.countObjProperties(r[1])),VESPER.log("pulled out "+s+" characters from zip"),k},this.setNotifyFunc=function(a){k=a},this.set=function(k,l){a=k,b=k.fieldsTerminatedBy.replace("\\t","	").replace("\\n","\n"),d=k.linesTerminatedBy.replace("\\t","	").replace("\\n","\n"),f=k.fieldsEnclosedBy.replace('\\"','"'),i=l,h=i.indexOf(!0),c=b.charCodeAt(0),e=d.charCodeAt(0),g=f?f.charCodeAt(0):-1,j=0,VESPER.log(VESPER.DWCAParser.sharedValuesTerms);for(var p=0;p<k.invFieldIndex.length;p++){var s=k.invFieldIndex[p],t=k.fieldData[s];m[p]=t?t.default:void 0,n[p]=t?t.discreteTermList:void 0,o[p]=VESPER.DWCAParser.sharedValuesTerms[s],o[p]&&(r[o[p]]={})}q.length=0;for(var u=0;256>u;u++)q.push(String.fromCharCode(u));this.tryDB(),VESPER.log("readFields",i)},this.tryDB=function(){function a(){return{bookName:"bookName-"+parseInt(100*Math.random()),price:parseInt(1e3*Math.random()),checkedOut:new Date}}function b(){function b(){1e6>g?(g%5e3==0&&VESPER.log("adding record",g),e.add(a()).done(b),++g):VESPER.log("populate complete")}var e,f=$.indexedDB(c).transaction([d],$.indexedDB.IDBTransaction.READ_WRITE),g=0;f.progress(function(a){VESPER.log("Trans",a,a.objectStore("OldBookList")),e=a.objectStore("OldBookList"),b()}),f.then(function(a){VESPER.log("done then",a)},function(a){VESPER.log("fail then",a)}),f.done(function(a){VESPER.log("done",a)}),f.fail(function(a){VESPER.log("fail",a)})}var c="MartZip5",d="OldBookList",e=indexedDB.deleteDatabase(c);e.onsuccess=function(){};var f=$.indexedDB(c,{schema:{1:function(a){a.createObjectStore(d,{keyPath:"id",autoIncrement:!0})}}}).done(function(){VESPER.log("setup done"),b()});VESPER.log("WOT",f)}},VESPER.BarChart=function(a){function b(){g=i.chunkInfo(j,j.getData(),o),i.childScale.domain(g.extremes),VESPER.log("bin stuff",g.extremes,g)}function c(a){return Math.round(a/i.toNearest)*i.toNearest}var d,e,f=d3.svg.axis();this.format=void 0,this.barClass="countBin",this.childScale=d3.scale.linear();var g,h,i,j,k=d3.scale.log(),l=(d3.scale.linear(),k),m=[void 0,void 0],n=d3.behavior.zoom();n.scaleExtent([1,4]);var o={},p={left:40,right:20,top:15,bottom:40};this.minBarWidth=5,this.toNearest=1,this.divisions=[1,2,10,100];var q=function(a){var b=e[1]-p.bottom;a.attr("x",function(a){return i.childScale(a.start)}).attr("width",function(a){return i.childScale(a.end)-i.childScale(a.start)}).attr("y",function(a){return l(a.count+1)}).attr("height",function(a){return b-l(a.count+1)}).style("opacity",1)};this.set=function(b,c){o.keyField=b.identifyingField,o.dateField=b.dateField,o.nameField=b.nameField,o.realField=b.realField,e=NapVisLib.getWidthHeight(d3.select(a).node()),j=c},this.go=function(){i=this;var f=d3.select(a).selectAll("svg").data([0]);f.enter().append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),f=d3.select(a).select("svg"),d=f.append("svg:g").attr("class","treeSVG");var j=d3.select(a).select(".barChartControl");VESPER.log("controls",j);var k=a.substring(1);if(j.empty()){var l=d3.select(a).append("span").attr("class","visControl").attr("id",k+"Controls"),n={regular:i.uncalcCumulative,cumulative:i.calcCumulative},o=l.selectAll("span.fieldGroup").data(d3.entries(n),function(a){return a.key});o.enter().append("span").attr("class","fieldGroup"),o.append("input").attr("type","radio").attr("id",function(a){return k+a.key}).attr("name","chartYType").property("checked",function(a){return"regular"==a.key}).on("change",function(a){for(var b=[g.bins,h.bins],c=["unselected","selected"],e=0;e<b.length;e++)a.value(b[e]),i.redraw(d.selectAll("."+i.barClass+"."+c[e]).data(b[e],function(a){return Math.floor(a.start)}),b[e])}),o.append("label").attr("for",k+"count").text(function(a){return a.key}),$(function(){$(a+"Controls").buttonset()}),$(function(){$(a+"Controls").draggable()})}i.childScale.range([p.left,e[0]-p.right]),b();var q=f.select("g.rangeHolder");q.empty()&&f.append("g").attr("class","rangeHolder").attr("transform","translate(0,"+(e[1]-20)+")"),q=f.select("g.rangeHolder");var r=NapVisLib.rangeSlider();r(q),r.scale(i.childScale).dragEndFunc(function(a,d){m=[i.wrapDataType(c(d.invert(a[0]))),i.wrapDataType(c(d.invert(a[1])))],b(),i.update()}).tooltipTemplates({min:function(a,b){return"min: "+i.wrapDataType(c(b.invert(a[0])))},max:function(a,b){return"min: "+i.wrapDataType(c(b.invert(a[1])))},bar:function(){return null}}).update(),i.update()},this.update=function(){h=i.chunkInfo(j,j.getData(),o,function(a){return j.getSelectionModel().contains(a)});var a=g.bins;VESPER.log("SEL BINS",h);var b=d3.max(a,function(a){return a.count+1});VESPER.log("maxh",b);var c=e[1]-p.bottom;l.domain([1,b]).range([c,p.top]).nice();var f=d.select("g.valueAxis");f.empty()&&(f=d.append("g").attr("class","valueAxis vesperAxis").attr("transform","translate (0,"+(e[1]-p.bottom)+")")),f.call(d3.svg.axis().scale(i.childScale).orient("bottom").tickFormat(i.format));for(var k=[a,h.bins],m=["unselected","selected"],n=0;n<k.length;n++){VESPER.log("bins",k[n]);var r=i.barClass,s=d.selectAll("."+r+"."+m[n]).data(k[n],function(a){return Math.floor(a.start)});s.exit().on("click",null).on("mouseout",null).on("mouseover",null).on("contextmenu",null),s.exit().remove(),i.redraw(s,k[n]);var t=s.empty()?0:500;s.enter().append("svg:rect").attr("class",r+" "+m[n]).style("opacity",0).on("click",function(){}).on("contextmenu",function(a){VESPER.log("hello right click"),j.getSelectionModel().clear();var b=i.returnMatches(j,o,a.start,a.end);j.getSelectionModel().addAllToMap(b),d3.event.preventDefault()}).on("mouseover",function(a){d3.select(this).classed("highlight",!0);var b=d3.select(this).classed("selected");VESPER.tooltip.updateText(b?"Selected":"All",i.makeTitle(a)),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).classed("highlight",!1),VESPER.tooltip.setToFade()}).transition().delay(t).duration(500).call(q)}},this.redraw=function(a,b){var c=(d3.max(b,function(a){return a.count+1}),e[1]-p.bottom);l.range([c,p.top]).nice();var g=d.select("g.countAxis");g.empty()&&(g=d.append("g").attr("class","countAxis vesperAxis").attr("transform","translate ("+(p.left-1)+",0)")),g.call(f.scale(l).orient("left").ticks(5,d3.format(",d"))),VESPER.log("cds",a),a.transition().duration(500).call(q)},this.makeTitle=function(){},this.updateVals=this.update,this.chunkInfo=function(a,b,c,d){function e(){if(!n||!o)for(var d in b)if(b.hasOwnProperty(d)){var e=j.getVal(a,b,d,c);if(void 0!==e){e=j.wrapDataType(e,d);var f=j.unwrapDataType(e);q++,!n&&(void 0===k||g>f)&&(k=e,g=j.unwrapDataType(k)),!o&&(void 0===l||f>h)&&(l=e,h=j.unwrapDataType(l))}}}function f(){for(var e in b)if(b.hasOwnProperty(e)&&(!d||d(e,b))){var f=j.getVal(a,b,e,c);if(void 0!==f&&(f=j.unwrapDataType(j.wrapDataType(f,e)),!isNaN(f)&&f>=r)){var g=Math.floor((f-x)/v);g>=0&&w>=g&&p[g].count++}}}var g,h,j=i,k=m[0],l=m[1],n=void 0!==k,o=void 0!==l,p=[],q=0;if(e(),void 0!==k&&void 0!==l){var r=j.unwrapDataType(k),s=j.unwrapDataType(l),t=Math.ceil(s/i.toNearest)*i.toNearest-Math.floor(r/i.toNearest)*i.toNearest;VESPER.log("MINS",s,r,k,l,t,i.childScale.range());var u=j.makeBarSizes(i.childScale.range()[1]-i.childScale.range()[0],t),v=u.newBinSize,w=u.newBinCount;VESPER.log("bb",v,w);for(var x=Math.floor(r/v)*v,y=0;w+1>y;y++){var z=x+v*y;p[y]={count:0,start:j.wrapDataType(Math.max(z,r)),end:j.wrapDataType(Math.min(z+v,s+v))}}f()}return{extremes:[k,l],bins:p}},this.returnMatches=function(a,b,c,d){var e=[],f=a.getData();for(var g in f)if(f.hasOwnProperty(g)){var h=i.getVal(a,f,g,b);void 0!==h&&(h=i.wrapDataType(h,g),h>=c&&d>h&&e.push(g))}return VESPER.log("Arr",c,d,e),e},this.calcCumulative=function(a){VESPER.log("Bins",a);for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count+=b,b+=d}},this.makeBarSizes=function(a,b){for(var c,d=b/a*i.minBarWidth,e=0;e<i.divisions.length;e++)if(i.divisions[e]>d||e===i.divisions.length-1){c=i.divisions[e];break}VESPER.log("bdw: ",d,b,a);var f=Math.ceil(b/c);return{newBinSize:c,newBinCount:f}},this.uncalcCumulative=function(a){for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count-=b,b=d}},this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a));var b=d.selectAll(i.barClass);b.remove(),j.removeView(i),j=null,DWCAHelper.twiceUpRemove(a)}},VESPER.TaxaDistribution=function(a){var b=new VESPER.BarChart(a);return b.makeTitle=function(a){var b=a.end-a.start==1;return"Subtaxa: "+a.start+(b?"":" to "+(a.end-1))+"<br>Count: "+a.count},b.wrapDataType=function(a){return a},b.unwrapDataType=function(a){return a},b.getVal=function(a,b,c,d){var e=a.getTaxaData(b[c]);if(e[d.realField]==e[d.keyField]){var f=a.getNodeFromID(c),g=a.getSubTaxa(f);return g?g.length:0}return void 0},b.divisions=[1,2,10],b},VESPER.TimeLine=function(a){var b=new VESPER.BarChart(a),c={};b.childScale=d3.time.scale(),b.barClass="timeBin",b.format=d3.time.format("Y%Y"),b.makeTitle=function(a){return a.start.toString()+"<br>to "+a.end.toString()+"<br>Records: "+a.count},b.wrapDataType=function(a,b){var d=void 0===b?void 0:c[b];return void 0===d?new Date(a):d},b.unwrapDataType=function(a){return a.getTime()},b.getVal=function(a,b,d,e){var f=a.getTaxaData(b[d])[e.dateField];return c[d]||void 0===f||(c[d]=new Date(f)),f};var d=864e5;return b.toNearest=7*d,b.divisions=[d,7*d,91.3125*d,365.25*d,365.25*d*10],b};var View=function(){};VESPER.demo=function(a){function b(){return h}function c(a){DWCAHelper.divDisplay(["#showOnZipLoadDiv"],"none"),DWCAHelper.divDisplay(["#selDiv"],"block"),d3.select("#filenamePlaceholder").html(a.name),d3.select("#filesizePlaceholder").html("..."),d3.select("#dynamicSelectDiv").selectAll("span input").property("checked",!1)}function d(a){var b=d3.select("#chooseFileDiv").selectAll("button").data(a);b.enter().append("button").attr("class","choice").attr("type","button").attr("id",function(a){return a.name}).text(function(a){return a.name}).on("click",function(a){NapVisLib.xhr2(a.file,"text/plain; charset=x-user-defined",function(a){var b=NapVisLib.getText(a);NapVisLib.showProps(a),l(b)}),c(a)}),NapVisLib.makeFileLoadButton(d3.select("#chooseFileDiv"),"choice","localLoader","Load",function(a,b){c(a),l(b)})}function e(a,c){for(var d=d3.select("#listDiv"),e=d3.select("#dynamicSelectDiv"),f=0;f<a.length;f++){var g=a[f],h=DWCAHelper.addCheckbox(e,g,"fieldGroup");DWCAHelper.configureCheckbox(h,d,g.attList,function(){return b()})}for(var j=d3.select("#labelSelectDiv"),f=0;f<c.length;f++){var g=c[f],k=DWCAHelper.addRadioButton(j,g,"nameChoice","nameChoice",!0);DWCAHelper.configureRadioButton(k,d,i,function(){return b()})}var l=function(a){var b=d3.select("#dynamicSelectDiv").selectAll(".fieldGroup input");if(b=b.filter(function(){return"none"!=d3.select(this).style("display")}),b.property("checked",a),!a){var c=d3.select("#labelSelectDiv").selectAll(".nameChoice input");c=c.filter(function(){return"none"!=d3.select(this).style("display")}),c.property("checked",a),i.result=null}};DWCAHelper.addHelperButton(d3.select("#advancedSelectDiv"),d,"Remove Verbose Fields",VESPER.DWCAParser.flabbyLists.wordyList,!1,null,"selButtonStyle listCon",function(){return b()});var m=function(a,b){return 0==b};d3.select("#allButton").on("click",function(){return DWCAHelper.setAllFields(d,!0,void 0,m,b()),l(!0),!1}),d3.select("#clearButton").on("click",function(){return DWCAHelper.setAllFields(d,!1,void 0,m,b()),l(!1),!1});var n=function(){var a=d3.select(this).property("checked")?"block":"none";return DWCAHelper.divDisplay(["#advancedSelectDiv","#listDiv"],a),!1},o=DWCAHelper.addCheckbox(d3.select("#advRevealPlaceholder"),{title:"Advanced Options",image:null},"showAdv");o.select("input").on("click",n)}function f(a,b){var c=DWCAHelper.getAllSelectedFilesAndFields(b),d={};VESPER.log("ZIP:",a),$.each(c,function(c,e){var f=b.fileData[c],g=f.fileName,h=NapVisLib.newFilledArray(f.invFieldIndex.length,!1);$.each(e,function(a,b){h[f.fieldIndex[a]]=b}),VESPER.log("readFields",h),VESPER.DWCAZipParse.set(f,h),a.zipEntries.readLocalFile(g,VESPER.DWCAZipParse.zipStreamSVParser2),d[f.rowType]=a.zipEntries.getLocalFile(g).uncompressedFileData,VESPER.DWCAParser.updateFilteredLists(f,h)}),VESPER.alerts&&alert("mem monitor point 1"),g=new DWCAModel(b,VESPER.DWCAParser.setupStrucFromRows(d,b)),VESPER.log("MODEL",g),VESPER.alerts&&alert("mem monitor point X"),DWCAHelper.divDisplay(["#selDiv"],"none"),DWCAHelper.divDisplay(["#allVisDiv"],"block"),g.name=d3.select("#filenamePlaceholder").text().replace(/\W/g,""),(new VESPER.VisLauncher).makeVis(j[0],g),g=null,h=null}VESPER.tooltip.init();var g,h,i={result:null},j=[{title:"VisChoices",multiple:!1,attList:["unachievable"],matchAll:!0,image:VESPER.imgbase+"tree.png",height:"null",width:"200px",newVisFunc:function(a){return new VESPER.VisLauncher(a)},setupFunc:function(a){return{nameField:a[i.result],visChoiceData:j}}},{title:"Implicit Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.Tree(a)},setupFunc:function(a){return{nameField:a[i.result],rankField:a.taxonRank}}},{title:"Explicit Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.expTaxonomy,matchAll:!1,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.Tree(a)},setupFunc:function(a){return{nameField:a[i.result],rankField:a.taxonRank}}},{title:"Map",multiple:!0,attList:VESPER.DWCAParser.neccLists.geo,matchAll:!0,image:VESPER.imgbase+"world.png",height:"400px",newVisFunc:function(a){return new VESPER.DWCAMapLeaflet(a)},setupFunc:function(a){return{latitude:a.decimalLatitude,longitude:a.decimalLongitude,nameField:a[i.result]}}},{title:"Timeline",multiple:!0,attList:VESPER.DWCAParser.neccLists.basicTimes,matchAll:!0,image:VESPER.imgbase+"geo.png",height:"200px",newVisFunc:function(a){return VESPER.TimeLine(a)},setupFunc:function(a){return{dateField:a.eventDate,nameField:a[i.result]}}},{title:"Sanity Check",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"geo.png",height:"400px",newVisFunc:function(a){return new VESPER.Sanity(a)},setupFunc:function(){return void 0}},{title:"Taxa Distribution",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"200px",newVisFunc:function(a){return VESPER.TaxaDistribution(a)},setupFunc:function(a){return{realField:a.acceptedNameUsageID,nameField:a[i.result],rankField:a.taxonRank}}},{title:"Search Box",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"geo.png",height:"150px",width:"200px",newVisFunc:function(a){return new VESPER.FilterView(a)},setupFunc:function(a){return{nameField:a[i.result]}}}],k=j.slice(0,6),l=function(a){d3.select("#filesizePlaceholder").html("zipped: "+(a.length|a.byteLength)+" bytes"),VESPER.alerts&&alert("check memory use in task manager");var b=VESPER.DWCAParser.accessZip(a,"meta.xml"),c=b.meta;h=c;var d=b.jszip;DWCAHelper.makeFieldSelectionBoxes(c,d3.select("#listDiv")),d3.select("#loadButton").on("click",null).on("click",function(){return f(d,c),!1});var e=(d3.select("#listDiv"),d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup"));VESPER.log(e),e.property("checked",!1).style("display",function(a){var b=DWCAHelper.fieldListExistence(c,a.attList,a.matchAll);return b?null:"none"});var g=d3.select("#labelSelectDiv").selectAll("label.nameChoice");VESPER.log(g),g.property("checked",!1).style("display",function(a){var b=DWCAHelper.fieldListExistence(c,[a],!0);return b?null:"none"});var i=!0;g.each(function(){var a=d3.select(this).style("display");if("none"!=a&&i){i=!1;var b=document.createEvent("MouseEvent");b.initEvent("click",!0,!0),this.dispatchEvent(b)}}),DWCAHelper.divDisplay(["#showOnZipLoadDiv"],"block")};d(a),e(k,VESPER.DWCAParser.labelChoiceData)};var DWCAHelper=new function(){function a(a){var b=this.checked,c=d3.select(this.parentNode),d=VESPER.DWCAParser.controlledVocabSet[a]?"#999977":"#888888";c.style("background",b?"":d)}function b(a,b){return a.invFieldIndex[a.idIndex]===b}function c(a,c){return a.selectedItems[c]===!0||b(a,c)}function d(a,b,c){a.selectedItems[b]=c}function e(a){return a.selected===!0}function f(a,b){a.selected=b}function g(d,f,g){VESPER.log("rt",d,f,g);var h=f.fileData[g],i=e(h);d.style("background",i?"":"#888888"),d.selectAll("td").style("background",function(b){return c(h,b)&&i?a(b):"#888888"}),d.selectAll("td input").attr("disabled",function(a){return b(h,a)||!i?"disabled":null}).property("checked",function(a){return c(h,a)}),d.selectAll("th").style("background",function(b){return i?a(b):"#888888"}),d.selectAll("th input").property("checked",function(){return i})}this.getSelectedTickBoxValues=function(a,b){function c(){this.checked&&(f[this.value]=!0)}var d="input[type=checkbox]"+(b?"."+b:""),e=d3.select(a).selectAll(d),f={};return e.each(c),f},this.makeFieldSelectionBoxes=function(h,i){function j(e,f){VESPER.log("makerow args",arguments);var i=e;VESPER.log("table",f,e);var j=d3.select(this),k=j.attr("id"),l=j.selectAll("tr.col").data(e.value.invFieldIndex);l.exit().selectAll("input").on("click",null),l.exit().remove();var m=l.enter().append("tr").attr("class","col").append("td");m.append("input").attr("type","checkbox").attr("class","CSVField"),m.append("label");var n=l.select("td");n.select("input").property("checked",function(a){return c(i.value,a)}).attr("id",function(a){return k+a}).attr("value",function(a,b){return b}).attr("name",function(a){return a}).attr("disabled",function(a){return b(i.value,a)?"disabled":null}).on("click",null).on("click",function(a){var b=this.checked;return VESPER.log("fdEntry",i,b,this),d(i.value,a,b),g(j,h,i.key),!0}).each(a),n.select("label").attr("for",function(a){return k+a}).text(function(a){return a})}f(h.fileData[h.coreRowType],!0),VESPER.log("meta",h);for(var k=d3.entries(h.fileData),l=0;l<k.length;l++)k[l].value.selectedItems=k[l].value.selectedItems||{};var m=i.selectAll("div.selectBox").data(k,function(a){return a.key});m.exit().selectAll("input").on("click",null),m.exit().remove();var n=Math.floor(100/k.length)-2,o=m.enter().append("div").attr("class","selectBox").append("table");m.style("width",n+"%").select("table").attr("class",function(a){return a.key==h.coreRowType?"coreTable":null}).attr("id",function(a){return a.value.mappedRowType});var p=o.append("tr").append("th");p.append("input").attr("type","checkbox").attr("class","extensionFile").attr("id",function(a){return"cbox"+a.value.mappedRowType}).property("checked",function(a){return e(a.value)}).attr("value",function(a){return a.value.rowType}).attr("name",function(a){return a.value.mappedRowType}).attr("disabled",function(a){return a.key==h.coreRowType?"disabled":null}).on("click",function(a,b){var c=this.checked;return VESPER.log("check",c,this),f(a.value,c),g(d3.select(o[0][b]),h,a.key),!0}).each(a),p.append("label").attr("for",function(a){return"cbox"+a.value.mappedRowType}).text(function(a){return a.value.mappedRowType}),VESPER.log("divs",m),m.selectAll("table").each(j)},this.getAllSelectedFilesAndFields=function(a){var b={},c=a.fileData;for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e.selected){var f=e.selectedItems;VESPER.log("so",f);var g={},h=0;for(var i in f)f.hasOwnProperty(i)&&f[i]&&(g[i]=!0,h++);if(h){var j=e.invFieldIndex[e.idIndex];g[j]=!0,b[d]=g}}}return VESPER.log("Sel Struc",b),b},this.setAllFields=function(a,b,c,d,e){var h=a.selectAll("table"),i=e.fileData;for(var j in i)if(i.hasOwnProperty(j)){var k=i[j],l=k.selectedItems,m=c||k.invFieldIndex;if(void 0!==l){for(var n=0;n<m.length;n++){var o=m[n];k.fieldIndex[o]&&(l[o]=(d?d(k,o):!1)||b)}var p=d3.values(l),q=d3.set(p);f(k,q.has("true")),VESPER.log(j,q.has("true"))}}f(e.fileData[e.coreRowType],!0),h.each(function(a){g(d3.select(this),e,a.key)})},this.fieldListExistence=function(a,b,c){var d=[];for(var e in a.fileData)a.fileData.hasOwnProperty(e)&&(d=d.concat(a.fileData[e].invFieldIndex));var f=NapVisLib.intersectArrays(b,d);return c?f.length===b.length:f.length>0},this.addHelperButton=function(a,c,d,e,f,g,h,i){VESPER.log("IN",d,e,f,a.selectAll("button[type=button]."+h));var j=a.selectAll("button[type=button]."+h).data([{key:d,value:e,add:f}],function(a){return a.key});j.enter().append("button").attr("type","button").attr("class",h).attr("value",function(a){return a.key}).attr("name",function(a){return a.key}).on("click",function(a){DWCAHelper.setAllFields(c,a.add,a.value,b,i())}).html(function(a){return(g?'<img src="'+g+'">':"")+a.key})},this.addCheckbox=function(a,b,c){function d(a){return a.title||a.name}var e=a.selectAll("span").data([b],function(a){return a.title});if(!e.enter().empty()){var f=e.enter().append("span").attr("class",c);f.append("input").attr("type","checkbox").attr("value",d).attr("name",d).attr("id",d).property("checked",!1);var g=f.append("label").attr("for",d).text(d);b.icon&&g.append("img").attr("alt",d).attr("src",function(a){return a.image||a.icon})}return e},this.configureCheckbox=function(a,c,d,e){d&&(a.datum().attList=d),a.select("input").on("click",function(a){var d=d3.select(this).property("checked");DWCAHelper.setAllFields(c,d,a.attList,b,e());var f=d3.select(d3.select(this).node().parentNode).attr("class"),g=d3.selectAll("span."+f+" input[type='checkbox']");g=g.filter(function(){return d3.select(this).property("checked")});var h=[];g.each(function(a){h.push.apply(h,a.attList)}),DWCAHelper.setAllFields(c,!0,h,b,e())})},this.addRadioButton=function(a,b,c,d){var e=a.selectAll("label").data([b],function(a){return a});if(!e.enter().empty()){var f=e.enter().append("label").attr("class",c).attr("for",function(a){return a+"RBChoice"}).text(function(a){return a});f.append("input").attr("type","radio").attr("value",function(a){return a}).attr("name",d).attr("id",function(a){return a+"RBChoice"}).property("checked",!1)}return e},this.configureRadioButton=function(a,c,d,e){a.select("input").on("click",function(a){var f=d3.select(this).property("checked"),g=d3.select(this).attr("name"),h=d3.selectAll("input[type='radio'][name='"+g+"']"),i=[];h.each(function(a){i.push(a)}),DWCAHelper.setAllFields(c,!1,i,b,e()),DWCAHelper.setAllFields(c,f,[a],b,e()),d.result=a})},this.divDisplay=function(a,b){for(var c=0;c<a.length;c++)d3.select(a[c]).style("display",b)},this.addKillViewButton=function(a,b,c){a.append("button").attr("type","button").attr("class","killbutton").on("click",function(){c&&c.destroy&&c.destroy(),d3.select(d3.event.target).on("click",null)}).attr("title","Close this view").append("img").attr("src",VESPER.imgbase+"close.png").attr("alt","Close")},this.twiceUpRemove=function(a){var b=d3.select(a).node(),c=b.parentElement;c.parentElement.removeChild(c)},this.recurseClearEvents=function(a){a.on("mouseout",null).on("mouseover",null).on("mousedown",null).on("mouseup",null).on("click",null).on("contextmenu",null),VESPER.log("REC SEL",a),a.each(function(){var a=d3.select(this),b=a.selectAll("*");b.empty()||DWCAHelper.recurseClearEvents(b)})}};VESPER.DWCAMapLeaflet=function(a){function b(a,b,c){var d,e,f,g,h=!1;if(!b.contains(c))return!1;for(f=0,g=a.length;g>f;f++)d=a[f],e=a[(f-1+g)%g],d.lat>c.lat!=e.lat>c.lat&&c.lng<(e.lng-d.lng)*(c.lat-d.lat)/(e.lat-d.lat)+d.lng&&(h=!h);return h}var c,d,e,f,g,h,i,j,k,l,m=this,n=a.substring(1),o={},p=L.icon({iconUrl:VESPER.imgbase+"selMarker.png",shadowUrl:"../lib/leafletjs/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],shadowAnchor:[4,62]}),q=new L.Icon.Default;this.set=function(b,i){d=b.identifyingField,e=b.longitude,f=b.latitude,g=b.nameField,c=NapVisLib.getDivDims(a),h=i,VESPER.log("set model for map",h)},this.go=function(){if(VESPER.log("map go"),!k){var c="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",m="Map data � OpenStreetMap contributors",p=new L.TileLayer(c,{minZoom:1,maxZoom:19,attribution:m});d3.select(a).style("overflow","hidden"),k=L.map(n),k.addLayer(p),VESPER.log("size",k.getSize());var q=new L.Control.Draw({draw:{marker:!1,polyline:!1}});k.addControl(q),k.on("draw:created",function(a){var c=a.layerType,d=a.layer,e=[],f=0;if("circle"===c){VESPER.log("circle",a);var g=a.layer._latlng,i=a.layer._mRadius;j.eachLayer(function(a){f++;var b=a.getLatLng();g.distanceTo(b)<=i&&e.push(a.extId)})}else if("rectangle"===c){VESPER.log("rectangle",a);var m=a.layer._latlngs,n=new L.LatLngBounds(m[0],m[2]);j.eachLayer(function(a){f++;var b=a.getLatLng();n.contains(b)&&e.push(a.extId)})}else if("polygon"===c){VESPER.log("polygon",a);var m=a.layer._latlngs,o=new L.LatLngBounds(m);j.eachLayer(function(a){f++;var c=a.getLatLng();b(m,o,c)&&e.push(a.extId)})}l&&k.removeLayer(l),VESPER.log(e.length,"specimens within",c),k.addLayer(d),l=d,h.getSelectionModel().clear(),h.getSelectionModel().addAllToMap(e)}),j=new L.MarkerClusterGroup({iconCreateFunction:function(a){return new L.DivIcon({html:'<div class="unselected">'+a.getChildCount()+'</div><div class="selected">'+a.getSelectedChildCount()+"</div>",className:"vesperMapIcon",iconSize:new L.Point(40,20+(a.getSelectedChildCount()>0?20:0))})}}),j.clearLayers()}var r=L.TileLayer.maskCanvas({radius:5,useAbsoluteRadius:!1,color:"#000",opacity:.6});VESPER.log("maskmap ",r);var s=[],t=[];if(i=h.getData(),f&&e){for(var u in i)if(i.hasOwnProperty(u)){var v=h.getTaxaData(i[u]),w=+v[f],x=+v[e];if(!isNaN(w)&&!isNaN(x)){var y=[w,x],z=L.marker(y).bindPopup(v[d]+" "+v[g]).on("dblclick",function(a){h.getSelectionModel().clear(),h.getSelectionModel().addToMap(a.target.extId)});z.extId=u,s.push(z),t.push(y),o[u]=z}}j.addLayers(s),r.setData(t)}k.addLayer(j),k.fitBounds(new L.LatLngBounds(t).pad(1.05)),L.control.layers({},{Marker:j,Mask:r}).addTo(k),L.control.scale().addTo(k),VESPER.log("group ",j),VESPER.log("map ",k)
},this.update=function(){var a=h.getSelectionModel().values();if(k.hasLayer(j)){j.eachLayer(function(a){var b=h.getSelectionModel().contains(a.extId);a.setIcon(b?p:q)});for(var b,c=[],d=0;d<a.length;d++){var e=o[a[d]];e&&(c.push(e.getLatLng()),b=e)}if(j.setAllSelectedChildCounts(h.getSelectionModel()),1==c.length)j.zoomToShowLayer(b,function(){b.openPopup()});else if(c.length>1){var f=new L.LatLngBounds(c);k.fitBounds(f)}}},this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),h.removeView(m),h=null,DWCAHelper.twiceUpRemove(a)},this.updateVals=this.update;var r=0;L.MarkerClusterGroup.include({setAllSelectedChildCounts:function(a){r=0;var b=this._topClusterLevel.setAllSelectedChildCounts(a);return b}}),L.MarkerCluster.include({_selChildCount:0,setAllSelectedChildCounts:function(a){var b=0;r++;for(var c=this._markers.length-1;c>=0;c--)a.contains(this._markers[c].extId)&&b++;for(var d=this._childClusters.length-1;d>=0;d--)b+=this._childClusters[d].setAllSelectedChildCounts(a);return this._selChildCount=b,this._updateIcon(),b},getSelectedChildCount:function(){return this._selChildCount}})},VESPER.DWCAParser=new function(){function a(a){var b=e[a];return void 0===b?a:b}function b(a,b,c){a[b]||(a[b]=[]),a[b].push(c)}function c(a){var b=a?a.lastIndexOf("/")+1:-1;return b>0?a.substring(b):a}function d(a,b,c){for(var d in a)if(a.hasOwnProperty(d)){var e=a[d][c][b];if(void 0!==e)return{type:d,index:e,fieldName:b}}return null}this.TDATA=0,this.TAXA=1,this.EXT=2,this.SYN=3,this.SPECS="s";var e={"class":"classs",DarwinCore:"Occurrence",SimpleDarwinCore:"Occurrence",catalogNumberNumeric:"catalogNumber",collectorNumber:"recordNumber",collector:"recordedBy",nativeness:"establishmentMeans",latestDateCollected:"eventDate",earliestDateCollected:"eventDate",state:"stateProvince",province:"stateProvince",city:"municipality",depth:"verbatimDepth",elevation:"verbatimElevation",latitude:"decimalLatitude",longitude:"decimalLongitude",datum:"geodeticDatum",nameUsageID:"taxonID",nameID:"scientificNameID",acceptedTaxonID:"acceptedNameUsageID",parentTaxonID:"parentNameUsageID",higherTaxonID:"parentNameUsageID",higherNameUsageID:"parentNameUsageID",originalNameID:"originalNameUsageID",originalTaxonID:"originalNameUsageID",basionymID:"originalNameUsageID",taxonAccordingToID:"nameAccordingToID",acceptedTaxon:"acceptedNameUsage",parentTaxon:"parentNameUsage",higherTaxon:"parentNameUsage",higherNameUsage:"parentNameUsage",originalName:"originalNameUsage",originalTaxon:"originalNameUsage",basionym:"originalNameUsage",taxonAccordingTo:"nameAccordingTo",rank:"taxonRank",scientificNameRank:"taxonRank",taxonRemark:"taxonRemarks",EventAttributeType:"measurementType",eventMeasurementType:"measurementType",SamplingAttributeType:"measurementType"};this.flabbyLists={},this.flabbyLists.wordyList=["eventRemarks","taxonRemarks","georeferenceRemarks","identificationRemarks","locationRemarks","measurementRemarks","occurrenceRemarks","relationshipRemarks","verbatimCoordinates","bibliographicCitation","description"],this.explicitRanks=["kingdom","phylum","classs","order","family","genus","subgenus"],this.neccLists={},this.neccLists.geo=["decimalLatitude","decimalLongitude","geodeticDatum"],this.neccLists.impTaxonomy=["acceptedNameUsageID","parentNameUsageID","taxonRank"],this.neccLists.expTaxonomy=this.explicitRanks.concat(["taxonRank"]),this.neccLists.times=["eventDate","modified","geodeticDatum","georeferencedDate","dateIdentified","verbatimEventDate"],this.neccLists.basicTimes=["eventDate"],this.labelChoiceData=["acceptedNameUsage","scientificName","originalNameUsage","vernacularName"],this.controlledVocabFields=["continent","country","countryCode","stateProvince","county","island","islandGroup","waterBody","higherGeographyID","geodeticDatum","georeferenceVerificationStatus","verbatimCoordinateSystem","verbatimSRS","taxonomicStatus","language","nomenclaturalCode","nomenclaturalStatus","identificationVerificationStatus","rightsHolder","type","audience","format","taxonRank","verbatimTaxonRank","basisOfRecord","dcterms:type","dcterms:language","measurementUnit","behavior","relationshipOfResource","establishmentMeans","occurrenceStatus","disposition","sex","lifeStage","reproductiveCondition","isPlural","threatStatus","isMarine","isFreshwater","isTerrestrial","isInvasive","isHybrid","isExtinct","typeDesignationType"],this.archiveLimitedFields=["institutionID","collectionID","datasetID","institutionCode","collectionCode","datasetName","ownerInstitutionCode","year","month","day","source","nameAccordingToID","isPreferredName","typeStatus","verbatimTaxonRank","superkingdom","kingdom","superphylum","phylum","subphylum","superclass","classs","order","family"],this.controlledVocabSet={};for(var f=0;f<this.controlledVocabFields.length;f++)this.controlledVocabSet[this.controlledVocabFields[f]]=!0;this.discreteTermList=this.controlledVocabFields.concat(this.archiveLimitedFields),this.discreteTermSet={};for(var f=0;f<this.discreteTermList.length;f++)this.discreteTermSet[this.discreteTermList[f]]=!0;this.sharedValuesTerms={taxonID:1,acceptedNameUsageID:1,parentNameUsageID:1,originalNameUsageID:1},this.recordURIMap={"http://rs.tdwg.org/dwc/xsd/simpledarwincore/SimpleDarwinRecord":"Simple Darwin Record","http://rs.tdwg.org/dwc/terms/Occurrence":"Occurrence","http://rs.tdwg.org/dwc/terms/Event":"Event","http://purl.org/dc/terms/Location":"Location","http://purl.org/dc/terms/GeologicalContext":"GeologicalContext","http://rs.tdwg.org/dwc/terms/Identification":"Identification","http://rs.tdwg.org/dwc/terms/Taxon":"Taxon","http://rs.tdwg.org/dwc/terms/ResourceRelationship":"ResourceRelationship","http://rs.tdwg.org/dwc/terms/MeasurementOrFact":"MeasurementOrFact","http://rs.gbif.org/terms/1.0/Distribution":"Distribution","http://rs.gbif.org/terms/1.0/VernacularName":"VernacularName","http://rs.gbif.org/terms/1.0/SpeciesProfile":"SpeciesProfile","http://rs.gbif.org/terms/1.0/TypesAndSpecimen":"TypesAndSpecimen","http://rs.gbif.org/terms/1.0/Reference":"Reference","http://rs.gbif.org/terms/1.0/Image":"Image","http://rs.gbif.org/terms/1.0/Identifier":"Identifier","http://rs.gbif.org/terms/1.0/Description":"Description","http://rs.nordgen.org/dwc/germplasm/0.1/terms/GermplasmSample":"GermplasmSample","http://purl.org/germplasm/germplasmTerm#GermplasmAccession":"GermplasmAccession","http://purl.org/germplasm/germplasmTerm#MeasurementExperiment":"MeasurementExperiment","http://purl.org/germplasm/germplasmTerm#MeasurementMethod":"MeasurementMethod"},this.rowTypeDefaults={},this.fieldAttrNames={},this.xsd=null,this.loadxsd=function(a){VESPER.log("yp2",a),$.get(a,function(a){VESPER.log("XSD",a,typeof a),VESPER.DWCAParser.xsd="string"==typeof a?$(NapVisLib.parseXML(a)):$(a),VESPER.DWCAParser.makeRowTypeDefaults(VESPER.DWCAParser.xsd),VESPER.DWCAParser.makeFieldAttrNames(VESPER.DWCAParser.xsd)})},this.accessZip=function(a,b){var c=new JSZip(a,{base64:!1,noInflate:!0});c.zipEntries.readLocalFile(b),VESPER.log("unzipped ",c,c.files);var d=c.zipEntries.getLocalFile(b),e=VESPER.DWCAParser.parseMeta($.parseXML(d.uncompressedFileData));return{jszip:c,meta:e}},$.fn.filterNode=function(a){return VESPER.log("go"),this.find("*").filter(function(){return VESPER.log(this),this.nodeName?this.nodeName.toUpperCase()==a.toUpperCase():!1})},this.makeRowTypeDefaults=function(a){var b=a.find('xs\\:attributeGroup[name="fileAttributes"], attributeGroup[name="fileAttributes"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("default"),c=a.attr("type");"xs:integer"==c&&(b=+b),VESPER.DWCAParser.rowTypeDefaults[a.attr("name")]=b}),VESPER.log("rtd",VESPER.DWCAParser.rowTypeDefaults)},this.makeFieldAttrNames=function(a){var b=a.find('xs\\:complexType[name="fieldType"], complexType[name="fieldType"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("name"),c=a.attr("type");VESPER.DWCAParser.fieldAttrNames[b]=c}),VESPER.log("fan",VESPER.DWCAParser.fieldAttrNames)},this.loadxsd("dwca.xsd"),this.occArray2JSONArray=function(a,b){var c={};VESPER.alerts&&alert("mem monitor point 1.4");for(var d=0,e=a.length;e>d;d++){var f=a[d];if(void 0!==f){var g=f[b];c[g]={},c[g][this.TDATA]=f}}return c},this.taxaArray2JSONTree=function(a,c,d){var e=c.idIndex,f=this.occArray2JSONArray(a,e);VESPER.alerts&&alert("mem monitor point 1.5");for(var g=d.parentNameUsageID,h=d.acceptedNameUsageID,i=0,j=a.length;j>i;i++){var k=a[i];if(void 0!==k){var l=k[e],m=k[g],n=f[m];if(m!=l&&void 0!=n)b(n,VESPER.DWCAParser.TAXA,f[l]);else if(void 0==n){var o=k[h];if(l!=o){var p=f[o];void 0!=p&&b(p,VESPER.DWCAParser.SYN,f[l])}}}}var q=this.findRoots(f,e,d);return this.createSuperroot(f,q,c.invFieldIndex[e],d),VESPER.log("roots",q),VESPER.log("JSON",f[1],f),{records:f,tree:f}},this.taxaArray2ExplicitJSONTree=function(a,c,d,e){var f=c.idIndex,g=this.occArray2JSONArray(a,f);VESPER.alerts&&alert("mem monitor point 1.5a ex"),VESPER.log("SPECS",VESPER.DWCAParser.SPECS);var h=VESPER.DWCAParser.explicitRanks,i=d.acceptedNameUsage||d.vernacularName||d.scientificName,j={},k=h.length,l=g,m=0,n=Date.now();for(var o in l)l.hasOwnProperty(o)&&m++;n=Date.now()-n,VESPER.log("first iter pass: ",n,"ms.");for(var p={},q=0,r=a.length;r>q;q++){var s=a[q];if(void 0!==s){for(var t,u=0;k>u;u++){var v=h[u],w=d[v];if(w){var x=s[w];if(x){if(!p[x]){var y=[];y[f]=x,y[i]=x,y[d.taxonRank]=v;var z={};z[this.TDATA]=y,p[x]=z,t&&b(t,VESPER.DWCAParser.TAXA,z)}t||(j[x]=!0),t=p[x]}}}t&&e(t,g[s[f]],p,s[i],f,d,i)}}m=0,n=Date.now();for(var o in l)l.hasOwnProperty(o)&&m++;n=Date.now()-n,VESPER.log("second iter pass: ",n,"ms.");var A=d3.keys(j);return this.createSuperroot(p,A,c.invFieldIndex[f],d),VESPER.log("roots",A),VESPER.log("json",g,"tree",p),{records:g,tree:p}},this.addOriginalAsSpecimenEntry=function(a,c,d,e,f,g,h){var i=e;if(!d[i]){var j=[];j[f]=i,j[h]=i,j[g.taxonRank]="Species";var k={};k[VESPER.DWCAParser.TDATA]=j,d[i]=k,a&&b(a,VESPER.DWCAParser.TAXA,d[i])}b(d[i],VESPER.DWCAParser.SPECS,c)},this.addOriginalAsLeaf=function(a,c){b(a,VESPER.DWCAParser.TAXA,c)},this.addExtRows2JSON=function(a,c,d,e){var f=[];if(c&&void 0!=d)for(var g=0,h=c.length;h>g;g++){var i=c[g];if(void 0!==i){var j=i[d];if(void 0!=j){var k=a[j];if(void 0!=k){k[this.EXT]||(k[this.EXT]={});var l=k[this.EXT];b(l,e,i)}}else f.push(g)}}return f},this.makeTreeFromAllFileRows=function(a,b){var c,d=b.fileData,e=d[b.coreRowType];NapVisLib.endsWith(b.coreRowType,"Taxon")?c=this.taxaArray2JSONTree(a[e.rowType],e,e.filteredFieldIndex):NapVisLib.endsWith(b.coreRowType,"Occurrence")&&(c=this.taxaArray2ExplicitJSONTree(a[e.rowType],e,e.filteredFieldIndex,VESPER.DWCAParser.addOriginalAsSpecimenEntry));for(var f in d)if(d.hasOwnProperty(f)){var g=d[f];if(b.coreRowType!==g.rowType&&g.selected){var h=this.addExtRows2JSON(c.records,a[g.rowType],g.idIndex,g.mappedRowType);VESPER.log("unreconciled in ",f,h)}}return c},this.setupStrucFromRows=function(a,b){var c=this.makeTreeFromAllFileRows(a,b);return VESPER.alerts&&alert("mem monitor point 2"),c.root=c.tree["-1000"],c.root&&this.countDescendants(c.root),VESPER.alerts&&alert("mem monitor point 3"),VESPER.log("root",c.root),c},this.findRoots=function(a,b,c){var d=[],e=c.parentNameUsageID,f=c.acceptedNameUsageID;if(void 0!==f&&void 0!==e)for(var g in a)if(a.hasOwnProperty(g)){var h=a[g],i=h[this.TDATA];if(void 0!==i){var j=i[b],k=i[f],l=i[e];j!=k||l!=j&&void 0!=a[l]||d.push(g)}}return d},this.createSuperroot=function(a,b,c,d){if(0==b.length)return void 0;if(1==b.length)return a["-1000"]=a[b[0]],a[b[0]];var e=d.parentNameUsageID,f="-1000",g={acceptedNameUsageID:f,parentNameUsageID:f,acceptedNameUsage:"superroot",taxonRank:"superroot",nameAccordingTo:"dwcaParse.js",scientificName:"superroot"};g[c]=f;var h={};h[this.TAXA]=[];for(var i=0;i<b.length;i++)h[this.TAXA].push(a[b[i]]),a[b[i]][VESPER.DWCAParser.TDATA][e]=f;h[VESPER.DWCAParser.TDATA]=[];for(var j in g)g.hasOwnProperty(j)&&(h[VESPER.DWCAParser.TDATA][d[j]]=g[j]);return VESPER.log("superroot",h),a[f]=h,h},this.countDescendants=function(a){if(void 0!=a[this.TAXA]){a.dcount=0;for(var b=0;b<a[this.TAXA].length;b++)a.dcount+=this.countDescendants(a[this.TAXA][b])}return(a.dcount||(a[VESPER.DWCAParser.SPECS]?a[VESPER.DWCAParser.SPECS].length:0))+1},this.parseMeta=function(a){var b={},c=this.getCoreRowType(a);b[c]=this.parseCore(a,c);for(var d=this.getExtensionRowTypes(a),e=0;e<d.length;e++)b[d[e]]=this.parseExtension(a,d[e]);var f={coreRowType:c,extRowTypes:d,fileData:b};return VESPER.log("metadata",f),f},this.parseCore=function(a,b){return this.parseFrag(a,'archive core[rowType="'+b+'"]',"id",b)},this.parseExtension=function(a,b){return this.parseFrag(a,'extension[rowType="'+b+'"]',"coreid",b)},this.parseFrag=function(b,d,e,f){VESPER.log("thexml",typeof b,b);var g=$(b).find(d),h=$(g[0]),i={},j=h.find("files location").contents();i.fileName=j[0].data,i.rowType=f,i.mappedRowType=this.recordURIMap[f];for(var k in this.rowTypeDefaults)this.rowTypeDefaults.hasOwnProperty(k)&&(i[k]=void 0!==h.attr(k)?h.attr(k):this.rowTypeDefaults[k],VESPER.log("att",k,"#",i[k],"#"));VESPER.log(h.attr("fieldsEnclosedBy"));var l=+h.find(e).attr("index");i.idIndex=l;var m=h.find("field");VESPER.log("fieldsTerminatedBy",i.fieldsTerminatedBy),i.fieldIndex={},i.invFieldIndex=[],i.fieldData={},i.fieldIndex[e]=l,i.invFieldIndex[l]=e;for(var n=0;n<m.length;n++){var o=$(m[n]),p={};for(var q in VESPER.DWCAParser.fieldAttrNames)if(VESPER.DWCAParser.fieldAttrNames.hasOwnProperty(q)){var r=VESPER.DWCAParser.fieldAttrNames[q],s=o.attr(q);"xs:integer"==r&&(s=+s),p[q]=s}p.shortTerm=a(c(p.term));var t=p.index,u=p.shortTerm;p.discreteTermList=VESPER.DWCAParser.discreteTermSet[u]?{}:void 0,isNaN(t)||(i.fieldIndex[u]=t,i.invFieldIndex[i.fieldIndex[u]]=u),i.fieldData[u]=p}return i.filteredFieldIndex={},i.filteredInvFieldIndex=[],VESPER.log("filenames: ",j),i},this.updateFilteredLists=function(a,b){var c=0;a.filteredInvFieldIndex.length=0;var d=a.invFieldIndex[a.idIndex];$.each(a.filteredFieldIndex,function(b){b!=d&&(a.filteredFieldIndex[b]=void 0)});for(var e=0;e<b.length;e++)if(b[e]){var f=a.invFieldIndex[e];a.filteredFieldIndex[f]=c,a.filteredInvFieldIndex[c]=f,c++}VESPER.log("fi",a.fieldIndex,a.filteredFieldIndex,a.invFieldIndex,a.filteredInvFieldIndex)},this.getCoreRowType=function(a){var b=$(a).find("core"),c=$(b[0]).attr("rowType");return VESPER.log("core",c),c},this.getExtensionRowTypes=function(a){for(var b=$(a).find("extension"),c=[],d=0;d<b.length;d++){var e=$(b[d]).attr("rowType");c.push(e)}return c},this.getFilteredIdIndex=function(a){var b=a.fileData[a.coreRowType];return b.filteredFieldIndex[b.invFieldIndex[b.idIndex]]},this.findFields=function(a,b,c){void 0==c&&(c="filteredFieldIndex");for(var e=[],f=0,g=b.length;g>f;f++)e.push(d(a,b[f],c));return e},this.selectNodes=function(a,b,c,d){var e=0,f=c.getData();if(void 0!==a&&a.length>0)for(var g in f)if(f.hasOwnProperty(g)){var h=f[g],i=b(c,h,a);i&&(e++,d(g))}return e}},VESPER.Filters=new function(){this.filter2=function(a,b,c,d){VESPER.log("regex",c),VESPER.log("filedata",a.getMetaData().fileData);var e,f=VESPER.DWCAParser.findFields(a.getMetaData().fileData,["vernacularName"],"filteredFieldIndex")[0],g=function(a,b,c){var g=a.getTaxaData(b)[d];if(g&&null!=g.match(c))return!0;if(e=a.getExtraData(b)&&f&&e[f.type])for(var h=e[f.type],i=h.length;--i>=0;){var j=h[i][f.index];if(null!=j.match(c))return!0}return!1};a.getSelectionModel().setUpdating(!0);var h=VESPER.DWCAParser.selectNodes(c,g,a,function(b){a.getSelectionModel().addToMap(b)});return a.getSelectionModel().setUpdating(!1),h}},VESPER.modelComparisons=new function(){function a(a,b){var c=NapVisLib.countObjProperties(a.getData()),d=NapVisLib.countObjProperties(b.getData());return d>c?a:b}this.modelCoverageToSelection=function(b,c,d,e){var f=a(b,c),g=f==b?c:b,h=f==b?d:e,i=f==b?e:d,j=f.getData(),k=g.getData();VESPER.log("lf",d,e),f.getSelectionModel().clear(),g.getSelectionModel().clear(),f.getSelectionModel().setUpdating(!0),g.getSelectionModel().setUpdating(!0);var l={};for(var m in j)if(j.hasOwnProperty(m)){var n=j[m],o=f.getTaxaData(n),p=o[h];l[p]=m}var q=0;for(var m in k)if(k.hasOwnProperty(m)){var n=k[m],o=g.getTaxaData(n),p=o[i];l[p]&&(f.getSelectionModel().addToMap(l[p]),g.getSelectionModel().addToMap(m),q++)}f.getSelectionModel().setUpdating(!1),g.getSelectionModel().setUpdating(!1)}};var OccList=function(a){function b(){var a=d3.select("#regexId");a.data([0]).on("keyup",function(){return e(),!1}),VESPER.log(a)}function c(a){function b(a){a.attr("color","#222222").text(function(a){return a}).attr("title",function(a){return a})}var c=d3.select(this),e=c.selectAll("td").data(d(h.getTaxaData(a)));e.exit().remove(),e.call(b),e.enter().append("td").call(b)}function d(a){newArr=[];for(var b=0;b<a.length;b++)l[b]&&newArr.push(a[b]);return newArr}function e(){h.update()}var f,g,h,i,j,k,l,m=(NapVisLib.getDivDims(a),400);this.set=function(a,b){i=a.identifyingField,j=a.nameField,k=a.rankField,l=a.rowFields,h=b},this.go=function(){f=this,g=d3.select(a).append("table").attr("pointer-events","all"),d3.select(a).style("overflow","auto"),b(),this.update()},this.update=function(){function b(a,b){var c=e&&h.getTaxaData(e)[i]==h.getTaxaData(a)[i];return c&&(j=b.offsetTop),c?"#ff0000":null}var d=h.getSelectionModel().values(),e=d[0];VESPER.log("oc",h.getData());var f=g.selectAll("tr").data(d3.values(h.getData()).slice(1,1e3),function(a){return h.getNodeFromID(a)[i]}),j=0;f.exit().on("mousedown",null),NapVisLib.d3fadeAndRemoveGroups([f.exit()],m,0),f.style("background",function(a){return b(a,this)});var k=(f.enter().append("tr").classed("dwcalist",!0).on("mousedown",function(a){h.getSelectionModel().clear(),h.getSelectionModel.addToMap(h.getNodeFromID(a)[i])}).style("background",function(a){return b(a,this)}).each(c),d3.select(a).node());VESPER.log("scrollTop, offset, scrollTop+clientHeight",k.scrollTop,j,k.scrollTop+k.clientHeight),(k.scrollTop>j||k.scrollTop+k.clientHeight<j)&&(k.scrollTop=j)},this.updateVals=this.update};VESPER.Sanity=function(a){var b,c,d=this,e=100;this.set=function(a,c){b=c,VESPER.log("sanity model",b)},this.go=function(){c=this,this.update()};var f=function(){var a=[],c=[],d=b.getData(),e=VESPER.DWCAParser.neccLists;for(var f in e)if(e.hasOwnProperty(f)){var g=VESPER.DWCAParser.findFields(b.getMetaData().fileData,e[f],"filteredFieldIndex"),h=NapVisLib.countNulls(g);0===h&&(a.push(g),c.push({listName:f,all:0,some:0}))}var i=0;for(var j in d)if(d.hasOwnProperty(j)){i++;var k=b.getTaxaData(d[j]);if(k)for(var l=0;l<a.length;l++){for(var m=a[l],n=!1,o=!0,p=0;p<m.length;p++){var q=m[p],r=q.index,s=k[r];void 0===s||null===s?n=!0:o=!1}n&&c[l].some++,o&&c[l].all++}}return{outputs:c,dataCount:i}},g=function(){for(var a=d3.entries(b.getMetaData().fileData),c=b.getData(),d={},e=0;e<a.length;e++){var f=a[e].value.filteredInvFieldIndex,g=a[e].value.mappedRowType;d[g]={};for(var h=0;h<f.length;h++)d[g][f[h]]={recordType:g,name:f[h],count:0}}for(var i in c)if(c.hasOwnProperty(i)){var j=b.getTaxaData(c[i]);if(j)for(var e=0;e<a.length;e++)for(var f=a[e].value.filteredInvFieldIndex,g=a[e].value.mappedRowType,h=0;h<f.length;h++){var k=f[h];(void 0===j[h]||null===j[h])&&d[g][k].count++}}var l={};for(var m in d)if(d.hasOwnProperty(m)){var n=d[m];for(var o in n)n.hasOwnProperty(o)&&(l[m+" "+o]=n[o])}return l},h=function(){for(var a=d3.entries(b.getMetaData().fileData),c={},d=0;d<a.length;d++){var e=a[d].value.fieldData;for(var f in e)if(e.hasOwnProperty(f)){var g=d3.values(e[f].discreteTermList);g.length>0&&(c[f]={name:f,count:g.length})}}return c};this.update=function(){function b(a,b){var c=l.select("table."+a);if(c.empty()){var d=l.append("table").attr("class",a).append("tr");d.selectAll("th").data(b).enter().append("th").attr("class","sanityTableHeading").text(function(a){return a})}}function c(a){var b=l.select("table."+a);b.remove()}function d(a,b,c,d){a.exit().remove(),a.enter().append("tr").attr("class","sanityText"),VESPER.log("rows",a,a.enter()),k=c,a.each(b).each(d)}function i(a){function b(a,b){return(t[b]?t[b](a.value):a.value.toString())+(isNaN(a.value)?"":" ("+s(a.value/q)+")")}var c=[];if(k)for(var d=0;d<k.length;d++){var f=k[d];void 0!==a[f]&&c.push({key:f,value:a[f]})}else c=d3.entries(a);VESPER.log("d",a,k,c);{var g=d3.select(this).selectAll("td").data(c);g.enter().append("td")}g.select("img").empty()&&(g.append("img").attr("class","sanityBarFail").attr("src",VESPER.imgbase+"blackpixel.gif"),g.append("img").attr("class","sanityBarOK").attr("src",VESPER.imgbase+"whitepixel.gif"),g.selectAll("img").attr("height",10)),g.select("img.sanityBarFail").attr("width",function(a){return isNaN(a.value)?0:Math.min(e,a.value/q*e)}),g.select("img.sanityBarOK").attr("width",function(a){return isNaN(a.value)?0:Math.min(e,e-a.value/q*e)}),g.select("span").empty()&&g.append("span").attr("class","sanityText"),g.select("span").text(b),g.attr("title",b)}function j(){}var k,l=d3.select(a),m=f(),n=g(),o=h(),p=m.outputs,q=m.dataCount,r=l.select("div.visHeader");r.empty&&d3.select(a).append("div").attr("class","visHeader").append("p"),l.select("div.visHeader").select("p").text("Sanity Check: "+q+" Records.");var s=d3.format(".2%"),t=[];b("visSanityTests",["Vis Type","some fields missing","all fields missing"]);var u=l.select("table.visSanityTests").selectAll("tr.sanityText").data(p);t.length=0,t[3]=s,t[4]=s,d(u,j,["listName","some","all"],i),$.isEmptyObject(n)||(b("fieldSanityTests",["Record Type","Field Type","fields missing"]),u=l.select("table.fieldSanityTests").selectAll("tr.sanityText").data(d3.values(n)),t.length=0,t[3]=s,d(u,j,["recordType","name","count"],i)),$.isEmptyObject(o)?c("vocabSanityTests"):(b("vocabSanityTests",["Field Type","Vocabulary Size"]),u=l.select("table.vocabSanityTests").selectAll("tr.sanityText").data(d3.values(o)),t.length=0,d(u,j,["name","count"],i))},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),b.removeView(d),b=null,DWCAHelper.twiceUpRemove(a)}},VESPER.FilterView=function(a){function b(){var b=d3.select(a).select("span input");b.on("keyup",function(){VESPER.log(d3.select(this).node(),d3.select(this).property("value")),c.getSelectionModel().clear();VESPER.Filters.filter2(c,null,d3.select(this).property("value"),d)}),VESPER.log(b)}var c,d,e=this;this.set=function(a,b){c=b,d=a.nameField},this.go=function(){var c=d3.select(a).attr("id")+"Text",d=d3.select(a).append("span");d.append("label").attr("for",c).text("Search"),d.append("input").attr("type","text").attr("id",c),b(),this.update()},this.update=function(){},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),c.removeView(e),c=null,DWCAHelper.twiceUpRemove(a)}},VESPER.modelBag=[],VESPER.SelectedView=function(a){function b(a){function b(a){"http://"==a.data.substring(0,7)?d3.select(this).append("a").attr("href",function(a){return a.data}).attr("target","_blank").text(function(a){return a.data}):d3.select(this).text(function(a){return a.data})}a.append("td").attr("class","field").text(function(a){return a.field}),a.append("td").attr("class","value").each(b)}function c(a,b,c,d){var f=e.getMetaData().fileData;VESPER.log("table",d,"#"+b+"Table",c);var g=d3.select(d).select("#"+b+"Table"),h=g.selectAll("tr.hrow"),i=h.data([0]);i.enter().append("tr").attr("class","hrow");var j=f[c].filteredInvFieldIndex;h=g.selectAll("tr.hrow");var k=h.selectAll("th").data(j);k.text(function(a,b){return j[b]}),k.enter().append("th").text(function(a,b){return j[b]})}function d(a,b,c,d){var f=b,g=(e.getMetaData().fileData,d3.select(d).select("#"+b+"Table")),h=g.selectAll("tr.drow"),i=h.data(a[f]);i.exit().remove(),i.enter().append("tr").attr("class","drow").attr("id",function(a,c){return b+c});for(var j=0;j<a[f].length;j++){var k=a[f][j],l=g.select("#"+b+j).selectAll("td"),m=l.data(k);m.exit().text(""),m.text(function(a){return a}),m.enter().append("td").text(function(a){return a})}}var e,f,g="mappedRowType",h="extDetailTable",i="detailTable",j=this;this.set=function(a,b){e=b,f=a.nameField},this.go=function(){var b=d3.select(a).select("button#save");b.empty()&&(window.requestFileSystem?d3.select(a).append("button").text("SAVE").on("click",function(){NapVisLib.prepareForWrite(NapVisLib.writeArray,e.getSelectionModel().values())}):NapVisLib.html5Lacks(d3.select(a),"[Browser does not support FileWriter]"));var c=d3.select(a).select("button#clearSel");c.empty()&&d3.select(a).append("button").text("CLEAR").on("click",function(){e.getSelectionModel().clear(),e.getSelectionModel().update()});var d=d3.select(a).select("button#compareMod");d.empty()&&d3.select(a).append("button").text("COMPARE MODEL").on("click",function(){VESPER.modelBag.push({model:e,name:f}),VESPER.log("ModelBag",VESPER.modelBag),VESPER.modelBag.length>1&&(VESPER.modelComparisons.modelCoverageToSelection(VESPER.modelBag[0].model,VESPER.modelBag[1].model,VESPER.modelBag[0].name,VESPER.modelBag[1].name),VESPER.modelBag.length=0)}),this.update()},this.update=function(){var f=e.getSelectionModel().values(),j=f[0],k=d3.select(a).selectAll("p.summary").data([f.length]);if(k.enter().append("p").attr("class","summary"),k.text(function(a){return"Selected "+a+" item"+(1===a?"":"s")+"."}),void 0!==j){var l=e.getMetaData(),m=l.fileData,n=e.getNodeFromID(j),o=d3.select(a).select("."+i);o.empty()&&(d3.select(a).append("table").attr("class",i),o=d3.select(a).select("."+i));var p=o.node();p.innerHTML="";var q=document.createElement("tr"),r=document.createElement("th"),s=document.createElement("th");r.innerHTML="Field",s.innerHTML="Value",q.appendChild(r),q.appendChild(s),p.appendChild(q);var t=[],u=m[l.coreRowType].filteredInvFieldIndex;VESPER.log("TAXON",j,n);for(var v=e.getTaxaData(n),w=0;w<v.length;w++)v[w]&&t.push({field:u[w],data:v[w]});var x=o.selectAll("tr.nonHeader").data(t);b(x);var y=x.enter().append("tr").attr("class","nonHeader");b(y);var z=d3.keys(e.getExtraData(n)),A=d3.select(a).selectAll("table."+h),B=A.data(z);B.exit().remove(),B.enter().append("table").attr("class",h).attr("id",function(a){return a+"Table"});for(var C={},D=0;D<l.extRowTypes.length;D++){var E=l.extRowTypes[D];C[m[E][g]]=E}for(var w=0;w<z.length;w++)c(e.getExtraData(n),z[w],C[z[w]],a),d(e.getExtraData(n),z[w],C[z[w]],a)}d3.select(a).selectAll("table").style("visibility",void 0===j?"collapse":"visible")},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),e.removeView(j),e=null,DWCAHelper.twiceUpRemove(a)}},VESPER.Tree=function(a){function b(a,b){var c=b.getTaxaData(a),d=b.getSpecimens(a),e=b.getDescendantCount(a),f=b.getSelectedDescendantCount(a),g=b.getSubTaxa(a);return c[A]+": "+c[B]+(void 0===g?d?"<br>"+d.length+" specimens":"":"<br>"+e+" descendants")+(f>0?void 0===g?d?"<br>"+f+" selected specimens":"":"<br>"+f+" selected descendants":"")}function c(a){return a.innerRadius}function d(a){return a.outerRadius}function e(a){return a.startAngle}function f(a){return a.endAngle}function g(){var b=a.substring(1),c=d3.select(a).append("span").attr("class","visControl").attr("id",b+"controls");c.append("p").html("Space Allocation");var d=c.selectAll("button.allocChoice").data(d3.entries(I),function(a){return a.key}),e=d.enter().append("span").attr("class","fieldGroup");e.append("input").attr("class","allocChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"alloc"}).property("checked",function(a){return s===a.value}).on("change",function(a){return s=a.value,i(r),!1}),e.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key}),c.append("p").html("Layout Style");var f=c.selectAll("button.layoutChoice").data(d3.entries(O),function(a){return a.key}),g=f.enter().append("span").attr("class","fieldGroup");g.append("input").attr("class","layoutChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"layout"}).property("checked",function(a){return t===a.value}).on("change",function(a){t=a.value;var b=o.selectAll(".treeNode");return j(b),b.remove(),i(r),!1}).html(function(a){return a.key}),g.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key}),c.append("p").html("Sort");var h=c.selectAll("button.sortChoice").data(d3.entries(H),function(a){return a.key}),k=h.enter().append("span").attr("class","fieldGroup");k.append("input").attr("class","sortChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"sort"}).property("checked",function(a){return u===a.value}).on("change",function(a){return u=a.value,i(r),!1}).html(function(a){return a.key}),k.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key}),$(function(){$("#"+b+"controls").draggable()})}function h(a){return w.getNodeFromID(a)}function i(a){F&&(VESPER.alerts&&alert("about to calc layout"),F=!1),s.size(t.sizeBounds()).cutoff(t.cutoffVal).sort(u),VESPER.log("what alloc reports ",s.size()),VESPER.log("root",a);var b=s.nodes(a);VESPER.log(b.length,b),r=a;var c=o.selectAll(".treeNode").data(b,function(a){return a.id});t.prep(b),t.removeOld(c.exit());var d=c.exit().empty()?0:C;t.redrawExistingNodes(c,d),d+=c.empty()?0:D;var e=t.makeNew(c.enter());VESPER.log(e),NapVisLib.d3fadeInNewGroups([e],E,d)}function j(a){a.on("click",null).on("mouseover",null).on("mouseout",null).on("contextmenu",null)}function k(a){a.on("click",function(a){var b=h(a.id);i(b==r&&void 0!=b.parent?b.parent:b)}).on("mouseover",function(a){d3.select(this).classed("highlight",!0);var c=h(a.id),d=b(c,w);VESPER.tooltip.updateText(w.getTaxaData(c)[A],d),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).classed("highlight",!1)}).on("contextmenu",function(a){l(h(a.id)),d3.event.preventDefault()})}function l(a){w.getSelectionModel().clear();var b=[];m(a,b),w.getSelectionModel().addAllToMap(b)}function m(a,b){var c=w.getTaxaData(a)[z];b.push(c);var d=w.getSubTaxa(a);if(void 0!=d)for(var e=0;e<d.length;e++)m(d[e],b);var f=w.getSpecimens(a);if(void 0!=f)for(var e=0;e<f.length;e++)m(f[e],b)}var n,o,p,q,r,s,t,u,v,w,x=this,y=d3.behavior.zoom();y.scaleExtent([1,4]);var z,A,B,C=400,D=1e3,E=400,F=!0,G=(d3.scale.category20c(),d3.scale.linear().domain([0,1]).range(["#ffcccc","#ff6666"]),{}),H={alpha:function(a,b){var c=w.getTaxaData(a)[A],d=w.getTaxaData(b)[A];return d>c?-1:c>d?1:0},descendants:function(a,b){var c=w.getDescendantCount(a),d=w.getDescendantCount(b);if(void 0===c&&void 0===d){var e=w.getSpecimens(a);c=e?e.length:0;var f=w.getSpecimens(b);d=f?f.length:0}return c=c||0,d=d||0,c>d?1:d>c?-1:0},selected:function(a,b){var c=w.getSelectionModel(),d=c.contains(w.getTaxaData(a)[z]),e=c.contains(w.getTaxaData(b)[z]);return d===e?0:d===!0?1:-1}},I={bottomUp:AdaptedD3.partition3().sort(null).value(function(a){return w.getLeafValue(a)}).children(function(a){return w.getSubTaxa(a)}).nodeId(function(a){return w.getTaxaData(a)[z]}),bottomUpLog:AdaptedD3.logPartition().sort(null).value(function(a){return w.getLeafValue(a)}).children(function(a){return w.getSubTaxa(a)}).nodeId(function(a){return w.getTaxaData(a)[z]}),topDown:AdaptedD3.topdown().sort(null).value(null).children(function(a){return w.getSubTaxa(a)}).nodeId(function(a){return w.getTaxaData(a)[z]})},J={cutoffVal:4,sizeBounds:function(){return[p[1],p[0]]},sharedAttrs:function(a){a.attr("class",function(a){var b=h(a.id);return w.getSelectionModel().contains(a.id)?"selected":b.sdcount>0?"holdsSelected":"unselected"}).attr("y",function(a){return a.x}).attr("x",function(a){return a.y}).attr("width",function(a){return a.dy}).attr("height",function(a){return a.dx})},sharedTextAttrs:function(a){function b(a,b){return a.dx>a.dy&&d3.select(b).node().getComputedTextLength()<a.dx-4}a.attr("transform",function(a){return"translate ("+a.y+","+(a.x+Math.max((a.dx-14)/2+14,14))+") rotate ("+(b(a,this)?90:0)+" "+a.dy/2+" 0)"}).attr("clip-path",function(a){h(a.id);return b(a,this)?null:"url(#depthclip0)"})},prep:function(a){o.attr("transform","translate(0,0)"),J.makeTextClips(a)
},removeOld:function(a){j(a),NapVisLib.d3fadeAndRemoveGroups([a],C,0)},makeNew:function(a){var b=a.append("svg:g").attr("class","treeNode").style("opacity",0);return b.append("svg:rect").style("visibility",function(a){return a.dx>=J.cutoffVal?"visible":"hidden"}).call(J.sharedAttrs).call(k),b.append("svg:text").text(function(a){var b=h(a.id);return w.getTaxaData(b)[A]}).style("visibility",function(a){return a.dx>15&&a.dy>15?"visible":"hidden"}).call(J.sharedTextAttrs),b},redrawExistingNodes:function(a,b){a.select("rect").style("visibility",function(a){return a.dx>=J.cutoffVal?"visible":"hidden"}).transition().delay(b).duration(D).call(J.sharedAttrs),a.select("text").style("visibility",function(a){return a.dx>15&&a.dy>15?"visible":"hidden"}).transition().delay(b).duration(D).call(J.sharedTextAttrs)},makeTextClips:function(a){for(var b=n.node().getBoundingClientRect().height,c=[],d=0;d<a.length;d++){var e=a[d],f=h(e.id);c[f.depth]||(c[f.depth]={depth:f.depth,x:e.y,y:-20,width:e.dy,height:b+20})}var g=n.select("defs").selectAll(".napierClip").data(c),i=function(a){a.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height})};g.exit().remove(),g.select("rect").call(i),g.enter().append("clipPath").attr("class","napierClip").attr("id",function(a){return"depthclip"+a.depth}).append("rect").call(i)}},K=Math.PI;d3.svg.parc=function(){function a(){VESPER.log("this",this);var a=g.apply(this,arguments),b=h.apply(this,arguments)+L,c=i.apply(this,arguments)+L,d=(b>c&&(d=b,b=c,c=d),c-b),e=K>d?"0":"1",f=Math.cos(b),j=Math.sin(b),k=Math.cos(c),l=Math.sin(c);return d>=M?"M0,"+a+"A"+a+","+a+" 0 1,1 0,"+-a+"A"+a+","+a+" 0 1,1 0,"+a:"M"+a*f+","+a*j+"A"+a+","+a+" 0 "+e+",1 "+a*k+","+a*l}var b=c,g=d,h=e,i=f;return a.innerRadius=function(c){return arguments.length?(b=d3.functor(c),a):b},a.outerRadius=function(b){return arguments.length?(g=d3.functor(b),a):g},a.startAngle=function(b){return arguments.length?(h=d3.functor(b),a):h},a.endAngle=function(b){return arguments.length?(i=d3.functor(b),a):i},a.centroid=function(){var a=(b.apply(this,arguments)+g.apply(this,arguments))/2,c=(h.apply(this,arguments)+i.apply(this,arguments))/2+L;return[Math.cos(c)*a,Math.sin(c)*a]},a};var L=-K/2,M=2*K-1e-6,N={cutoffVal:.05,sizeBounds:function(){var a=d3.min(p)/2;return VESPER.log("DIMS",p,a),[2*Math.PI,a*a]},sharedAttrs:function(a){a.attr("class",function(a){var b=h(a.id);return"fatarc "+(w.getSelectionModel().contains(a.id)?"selected":b.sdcount>0?"holdsSelected":"unselected")})},sharedTextAttrs:function(a){a.attr("transform",function(a){return"translate ("+a.x+","+a.y+")"})},arc:d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),parc:d3.svg.parc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),stash:function(a){G[a.id]={x0:a.x,dx0:a.dx,y0:a.y,dy0:a.dy}},arcTween:function(a){var b=G[a.id],c=d3.interpolate({x:b.x0,dx:b.dx0,y:b.y0,dy:b.dy0},a);return function(a){var d=c(a);return b.x0=d.x,b.dx0=d.dx,b.y0=d.y,b.dy0=d.dy,N.arc(d)}},prep:function(){o.attr("transform","translate("+p[0]/2+","+.52*p[1]+")")},removeOld:function(a){j(a),a.each(function(){var a=d3.select(this).datum().id;G[a]=void 0}),NapVisLib.d3fadeAndRemoveGroups([a],C,0)},makeNew:function(a){{var b=a.append("svg:g").attr("class","treeNode").style("opacity",0);b.append("path").attr("d",N.arc).attr("id",function(a){return"arc"+a.id}).call(N.sharedAttrs).call(k).each(N.stash)}return b},redrawExistingNodes:function(a,b){a.select("path.fatarc").call(N.sharedAttrs).transition().delay(b).duration(D).attrTween("d",N.arcTween).each("end",N.stash),a.select("text").style("visibility",function(a){return a.dx>1?"visible":"collapse"})}},O={icicle:J,sunburst:N};this.set=function(b,c){VESPER.log("set args",arguments,d3.select(a).node()),z=b.identifyingField,A=b.nameField,B=b.rankField,p=NapVisLib.getWidthHeight(d3.select(a).node()),w=c},this.go=function(){var b=w.getSelectionModel().values(),c=1==b.length?h(b[0]):w.getRoot();if(void 0===c)return VESPER.log("no root defined for tree"),void 0;q=c,v=this,n=d3.select(a).append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),n.append("defs"),o=n.append("svg:g").attr("class","treeSVG");for(var d=d3.values(I),e=0;e<d.length;e++){d[e]}s=I.bottomUp,u=H.alpha,t=O.sunburst,g(),this.update()},this.update=function(){var a=w.getSelectionModel().values(),b=1==a.length?h(a[0]):w.getRoot();VESPER.log("Root",b,a[0]),w.countSelectedDesc(b,z),i(b)},this.updateVals=this.update,this.redraw=function(){var a=o.selectAll(".treeNode");t.redrawExistingNodes(a,0)},this.destroy=function(){j(o.selectAll(".treeNode")),o.selectAll(".treeNode").remove(),w.removeView(x),w=null,DWCAHelper.twiceUpRemove(a)}},VESPER.tooltip=new function(){this.holdDuration=1e4,this.fadeDuration=200;var a=this;this.init=function(){var a=d3.select("body").selectAll("#vesperTooltip").data([0]).enter().append("div").attr("id","vesperTooltip").attr("class","vesperTooltip").style("visibility","hidden");a.append("h2"),a.append("p")},this.setToFade=function(){var b=d3.select("#vesperTooltip");b.transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})},this.updateText=function(b,c){var d=d3.select("#vesperTooltip");d.select("h2").text(b),d.select("p").html(c),d.style("visibility","visible").style("opacity",null).transition().duration(a.holdDuration).each("end",function(){d3.select(this).transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})})},this.updatePosition=function(a){var b=d3.select("#vesperTooltip");b.style("top",a.pageY+10+"px").style("left",a.pageX+10+"px")}},VESPER.VisLauncher=function(a){function b(a,b){var c=b.selectAll("button").data(a);c.enter().append("button").attr("class","visChoice").attr("type","button").attr("id",function(a){return a.title}).text(function(a){return a.title}).on("click",function(a){return j.makeVis(a,e),!1})}function c(){d3.select(a).append("hr"),d3.select(a).append("h4").text("Selection Ops"),window.requestFileSystem?d3.select(a).append("button").attr("type","button").text("SAVE").on("click",function(){NapVisLib.prepareForWrite(NapVisLib.writeArray,e.getSelectionModel().values())}):NapVisLib.html5Lacks(d3.select(a),"[Browser does not support FileWriter]"),d3.select(a).append("button").attr("type","button").text("COMPARE MODEL").on("click",function(){VESPER.modelBag.push({model:e,name:g}),VESPER.log("ModelBag",VESPER.modelBag),VESPER.modelBag.length>1&&(VESPER.modelComparisons.modelCoverageToSelection(VESPER.modelBag[0].model,VESPER.modelBag[1].model,VESPER.modelBag[0].name,VESPER.modelBag[1].name),VESPER.modelBag.length=0)}),d3.select(a).append("button").attr("type","button").text("CLEAR").on("click",function(){e.getSelectionModel().clear(),e.getSelectionModel().update()})}function d(a){var b=a.selectAll("button.visChoice");b.style("display",function(a){var b=e.getMetaData().fileData,c=VESPER.DWCAParser.findFields(b,a.attList,"filteredFieldIndex"),d=NapVisLib.countNulls(c);return 0==c.length||a.matchAll&&0===d||!a.matchAll&&d<c.length?"block":"none"})}var e,f,g,h,i,j=this;this.set=function(b,c){f=b.identifyingField,g=b.nameField,i=b.visChoiceData,h=NapVisLib.getWidthHeight(d3.select(a).node()),e=c},this.go=function(){var e=d3.select(a);b(i,e),d(e),c()},this.update=function(){},this.updateVals=this.update,this.makeVis=function(a,b){var c=b.name+"view"+(a.multiple?b.getNextSessionModelViewID():"");c=c.replace(/\s+/g,"");var d=a.title+" "+b.name;if(d3.select("#"+c).empty()){var e=d3.select("#allVisDiv").append("div").attr("class","visWrapper").attr("id",c+"container").style("width",a.width?a.width:"50%");e.append("h3").text(d);var f=(e.append("div").attr("class","vis").attr("id",c).style("height",a.height),b.getMetaData().coreRowType),g=b.getMetaData().fileData,h=g[f].filteredFieldIndex,i=a.newVisFunc("#"+c);VESPER.log("newvis",i,i.set);var j=a.setupFunc(h)||{};j.identifyingField=VESPER.DWCAParser.getFilteredIdIndex(b.getMetaData()),i.set(j,b),b.addView(i),i.go(b),DWCAHelper.addKillViewButton(e.select("h3"),e,i),"Map"!=a.title&&$(function(){$("#"+c+"container").draggable()})}},this.destroy=function(){for(var b=e.getSelectionModel().getVis(),c=0;c<b.length;c++)b[c]!==j&&(b[c].destroy&&b[c].destroy(),e.removeView(b[c]));DWCAHelper.recurseClearEvents(d3.select(a)),e.removeView(j),e=null,DWCAHelper.twiceUpRemove(a)}};