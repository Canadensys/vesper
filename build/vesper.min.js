/*! vespertemp 2014-01-10 */
function Model(){Model.prototype={getNodeFromID:function(){},getTaxaData:function(){},getSubTaxa:function(){}}}function DWCAModel(a,b){this.getMetaData=function(){return this.metaData},this.getData=function(){return this.data.records},this.getTaxonomy=function(){return this.data.tree},this.getRoot=function(){return this.data.root};var c=0,d=0,e=new SharedSelection;this.getSelectionModel=function(){return e},this.invertSelection=function(){{var a=this.getData(),b=this.getSelectionModel(),c=[];({fieldType:"acceptedNameUsageID",rowType:this.getMetaData().coreRowType})}for(var d in a)b.contains(d)||c.push(d);b.clear(),b.addAllToMap(c)},this.getExtraData=function(a){return a[VESPER.DWCAParser.EXT]},this.getTaxaData=function(a){return a[VESPER.DWCAParser.TDATA]},this.getSynonyms=function(a){return a[VESPER.DWCAParser.SYN]},this.getRowData=function(a,b){return void 0==b?this.getTaxaData(a):void 0==this.getExtraData(a)?void 0:this.getExtraData(a)[b]},this.getSubTaxa=function(a){return a[VESPER.DWCAParser.TAXA]},this.getSpecimens=function(a){return a[VESPER.DWCAParser.SPECS]},this.getDescendantCount=function(a){return a.dcount},this.getSelectedDescendantCount=function(a){return a.sdcount},this.getLeafValue=function(a){var b=this.getSpecimens(a);return b?b.length:1},this.getNodeFromID=function(a){return this.getData()[a]||this.getTaxonomy()[a]},this.getLabel=function(a){var b=this.getMetaData().vesperAdds.nameLabelField;return this.getDataPoint(a,b)},this.getDataPoint=function(a,b){var c=this.getMetaData().fileData[b.rowType];void 0==c&&VESPER.log("UNDEFINED ROW",b,this.getMetaData());var d=c.filteredFieldIndex,e=d[b.fieldType];if(void 0==e)return void 0;var f=c.extIndex;return void 0==f?this.getTaxaData(a)[e]:this.getExtraData(a)?this.getExtraData(a)[f][0][e]:void 0},this.getIndexedDataPoint=function(a,b){return void 0==b||void 0==b.fieldType?void 0:void 0==b.rowIndex?this.getTaxaData(a)[b.fieldIndex]:this.getExtraData(a)?this.getExtraData(a)[b.rowIndex][0][b.fieldIndex]:void 0},this.getIndexedDataPoints=function(a,b,c){if(void 0!==b&&void 0!==b.fieldType)if(void 0==b.rowIndex)c.push(this.getTaxaData(a)[b.fieldIndex]);else if(this.getExtraData(a))for(var d=this.getExtraData(a)[b.rowIndex],e=0;e<d.length;e++)c.push(d[e])},this.makeIndices=function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this.makeIndex(a[c]));return b},this.makeIndex=function(a){var b=this.getMetaData().fileData;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c].filteredFieldIndex[a];if(void 0!==d)return{rowIndex:b[c].extIndex,rowType:c,fieldIndex:d,fieldType:a}}return null},this.getRowRecords=function(a,b){return void 0==b?this.getTaxaData(a):this.getExtraData(a)?this.getExtraData(a)[b]:void 0},this.addView=function(a){e.addSingleVis(a),c++,d++},this.removeView=function(a){e.removeVis(a),c--},this.getViewCount=function(){return c},this.getNextSessionModelViewID=function(){return d},this.update=function(){e.update()},this.countSelectedDesc=function(a,b){var c=this.getSubTaxa(a),d=this.getSpecimens(a);if(void 0!=c||void 0!=d){if(a.sdcount=0,void 0!=c)for(var e=0,f=c.length;f>e;e++)a.sdcount+=this.countSelectedDesc(c[e],b);if(void 0!=d)for(var e=0,f=d.length;f>e;e++)a.sdcount+=this.getSelectionModel().contains(this.getIndexedDataPoint(d[e],b))?1:0}return(a.sdcount||0)+(this.getSelectionModel().contains(this.getIndexedDataPoint(a,b))?1:0)},this.data=b,this.metaData=a}var VESPER=function(){var a={};return a.alerts=!1,a.logRun=!0,a.log=function(){a.logRun&&Function.prototype.apply.call(console.log,console,arguments)},a.imgbase="../img/",a.log(a),a}();VESPER.DWCAZipParse=new function(){var a,b,c,d,e,f,g,h,i,j,k,l,m="\\".charCodeAt(0),n=[],o=[],p=[],q=0,r=[],s=[],t=0;this.rowReader2=function(a){for(var b,d=0,e=0,f=0,i=j[d],r=[],u=a.length,v=!1,w=!1,x=0;u>x;x++){var y=a[x];if(b=y?y:0,g&&!w&&b==h&&(v=!v),!v&&(b===c||x===u-1)){if(i){if(f=x+(b===c?0:1),g&&(a[e]==h&&e++,a[f-1]==h&&f--),e===f)r.push(n[d]);else{var z=String.fromCharCode.apply(null,a.slice(e,f)),A=o[d],B=p[d];if(A){var C=A[z];C?(z=null,z=C):(A[z]=z,VESPER.log("new entry for field",d,"at lineNo",k,":",z,z.length))}else if(B){var C=s[B][z];C?(z=null,z=C):s[B][z]=z}t+=f-e,r.push(z)}b==c&&x===u-1&&r.push(n[d])}d++,i=j[d]|!1,e=x+1}w=b==m}if(k++,(k%1e4===0||10998===k)&&(l?l(k,r):VESPER.log(k,": ",r)),k%100===0){var D=NapVisLib.makeTime();D-q>1e3&&(q=D,l?l(k,r):VESPER.log(k,": ",r))}return r},this.zipStreamSVParser2=function(b){function c(a,b,c){var g=e==a;if(1==f)return g;if(g){if(c+f<=b.length){for(var h=d.length;--h>=1;)if(d.charCodeAt(h)!=b[c+h])return!1;return j+=d.length-1,!0}y=i-j,j=i,k=void 0}return!1}VESPER.alerts&&alert("start partial parse with charcodes");var i,j,k,l,n=new Array(1024),o=1024,p=[],r=[],u=0,v=!1,w=!1,x=!0,y=0,z=NapVisLib.makeTime();for(q=z;(i=b(n,y,o-y))>0;){i+=y;var A=0;if(y=0,x){var B=String.fromCharCode(n[0])+String.fromCharCode(n[1])+String.fromCharCode(n[2]);VESPER.log("possbom [",B,"]"),"ï»¿"==B&&(VESPER.log("UTF8 bytemark detected"),A=3),x=!1}for(j=A;i>j;j++){if(k=n[j],k>=128)if(k>=194&&224>k)i-1>j?k=((31&k)<<6)+(63&n[++j]):(y=1,j=i,k=void 0);else if(k>=224&&240>k)i-2>j?k=((255&k)<<12)+((63&n[++j])<<6)+(63&n[++j]):(y=i-j,j=i,k=void 0);else if(k>=240&&245>k)if(i-3>j){var C=((7&k)<<18)+((63&n[++j])<<12)+((63&n[++j])<<6)+(63&n[++j]);C-=65536;var D=(1023&C)+56320;k=D.charAt[0],l=D.charAt[1]}else y=i-j,j=i,k=void 0;g&&!v&&k==h?(w=!w,p.push(k)):!w&&c(k,n,j)?(r.push(u>=a.ignoreHeaderLines?VESPER.DWCAZipParse.rowReader2(p):void 0),u++,p.length=0):void 0!==k&&(p.push(k),void 0!==l&&(p.push(l),l=void 0)),v=k==m}if(y)for(var E=0;y>E;E++)n[E]=n[i-y+E]}return p.length>0&&r.push(VESPER.DWCAZipParse.rowReader2(p)),z=NapVisLib.makeTime()-z,VESPER.log("Time: ",z/1e3," secs."),VESPER.log("Shared Maps: "+s.length+", "+NapVisLib.countObjProperties(s[1])),VESPER.log("pulled out "+t+" characters from zip"),s.length=0,r},this.setNotifyFunc=function(a){l=a},this.set=function(l,m){a=l,b=l.fieldsTerminatedBy.replace("\\t","	").replace("\\n","\n"),d=l.linesTerminatedBy.replace("\\t","	").replace("\\n","\n").replace("\\r","\r"),g=l.fieldsEnclosedBy.replace('\\"','"'),j=m,i=j.indexOf(!0),c=b.charCodeAt(0),e=d.charCodeAt(0),h=g?g.charCodeAt(0):-1,f=d.length,k=0,VESPER.log(VESPER.DWCAParser.sharedValuesTerms),s.length=0;for(var q=0;q<l.invFieldIndex.length;q++){var t=l.invFieldIndex[q],u=l.fieldData[t];n[q]=u?u.default:void 0,o[q]=u?u.discreteTermList:void 0,p[q]=VESPER.DWCAParser.sharedValuesTerms[t],p[q]&&(s[p[q]]={})}r.length=0;for(var v=0;256>v;v++)r.push(String.fromCharCode(v));VESPER.log("readFields",j),VESPER.log("Q#",g,"#")}},VESPER.BarChart=function(a){function b(){g=i.chunkInfo(j,j.getData(),o),i.childScale.domain(g.extremes),VESPER.log("bin stuff",g.extremes,g)}function c(a){return Math.round(a/i.toNearest)*i.toNearest}var d,e,f=d3.svg.axis();this.format=void 0,this.barClass="countBin",this.childScale=d3.scale.linear();var g,h,i,j,k=d3.scale.log(),l=(d3.scale.linear(),k),m=[void 0,void 0],n=d3.behavior.zoom();n.scaleExtent([1,4]);var o={},p={left:40,right:20,top:15,bottom:40};this.minBarWidth=5,this.toNearest=1,this.divisions=[1,2,10,100];var q=function(a){var b=e[1]-p.bottom;a.attr("x",function(a){return i.childScale(a.start)}).attr("width",function(a){return i.childScale(a.end)-i.childScale(a.start)}).attr("y",function(a){return l(a.count+1)}).attr("height",function(a){return b-l(a.count+1)}).style("opacity",1)};this.set=function(b,c){o.keyField=c.makeIndices([b.identifyingField])[0],o.dateField=c.makeIndices([b.dateField])[0],o.realField=c.makeIndices([b.realField])[0],e=NapVisLib.getWidthHeight(d3.select(a).node()),j=c},this.go=function(){i=this,d3.select(a).style("overflow","hidden");var f=d3.select(a).selectAll("svg").data([0]);f.enter().append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),f=d3.select(a).select("svg"),d=f.append("svg:g").attr("class","treeSVG");var j=d3.select(a).select(".barChartControl"),k=a.substring(1);if(j.empty()){var l=d3.select(a).append("div").attr("class","visControl").attr("id",k+"Controls");NapVisLib.addHRGrooves(l),NapVisLib.makeSectionedDiv(l,[{header:"Totals",sectionID:"Totals"}],"section");var n={regular:i.uncalcCumulative,cumulative:i.calcCumulative},o=l.select(a+"ControlsTotals").selectAll("span.fieldGroup").data(d3.entries(n),function(a){return a.key});o.enter().append("span").attr("class","fieldGroup"),o.append("input").attr("type","radio").attr("id",function(a){return k+a.key}).attr("name","chartYType").property("checked",function(a){return"regular"==a.key}).on("change",function(a){for(var b=[g.bins,h.bins],c=["unselected","selected"],e=0;e<b.length;e++)a.value(b[e]),i.redraw(d.selectAll("."+i.barClass+"."+c[e]).data(b[e],function(a){return Math.floor(a.start)}),b[e])}),o.append("label").attr("for",k+"count").text(function(a){return a.key}),$(a+"Controls").draggable()}i.childScale.range([p.left,e[0]-p.right]),b();var q=f.select("g.rangeHolder");q.empty()&&f.append("g").attr("class","rangeHolder").attr("transform","translate(0,"+(e[1]-20)+")"),q=f.select("g.rangeHolder");var r=NapVisLib.rangeSlider();r(q),r.scale(i.childScale).dragEndFunc(function(a,d){m=[i.wrapDataType(c(d.invert(a[0]))),i.wrapDataType(c(d.invert(a[1])))],b(),i.update()}).tooltipTemplates({min:function(a,b){return"min: "+i.wrapDataType(c(b.invert(a[0])))},max:function(a,b){return"min: "+i.wrapDataType(c(b.invert(a[1])))},bar:function(){return null}}).update(),i.update()},this.update=function(){h=i.chunkInfo(j,j.getData(),o,function(a){return j.getSelectionModel().contains(a)});var a=g.bins;VESPER.log("SEL BINS",h);var b=d3.max(a,function(a){return a.count+1});VESPER.log("maxh",b);var c=e[1]-p.bottom;l.domain([1,b]).range([c,p.top]).nice();var f=d.select("g.valueAxis");f.empty()&&(f=d.append("g").attr("class","valueAxis vesperAxis").attr("transform","translate (0,"+(e[1]-p.bottom)+")")),f.call(d3.svg.axis().scale(i.childScale).orient("bottom").tickFormat(i.format));for(var k=[a,h.bins],m=["unselected","selected"],n=0;n<k.length;n++){VESPER.log("bins",k[n]);var r=i.barClass,s=d.selectAll("."+r+"."+m[n]).data(k[n],function(a){return Math.floor(a.start)});s.exit().on("click",null).on("mouseout",null).on("mouseover",null).on("contextmenu",null),s.exit().remove(),i.redraw(s,k[n]);var t=s.empty()?0:500;s.enter().append("svg:rect").attr("class",r+" "+m[n]).style("opacity",0).on("click",function(){}).on("contextmenu",function(a){j.getSelectionModel().clear();var b=i.returnMatches(j,o,a.start,a.end);j.getSelectionModel().addAllToMap(b),d3.event.preventDefault()}).on("mouseover",function(a){d3.select(this).classed("highlight",!0);var b=d3.select(this).classed("selected");VESPER.tooltip.updateText(b?"Selected":"All",i.makeTitle(a)),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).classed("highlight",!1),VESPER.tooltip.setToFade()}).transition().delay(t).duration(500).call(q)}},this.redraw=function(a,b){var c=(d3.max(b,function(a){return a.count+1}),e[1]-p.bottom);l.range([c,p.top]).nice();var g=d.select("g.countAxis");g.empty()&&(g=d.append("g").attr("class","countAxis vesperAxis").attr("transform","translate ("+(p.left-1)+",0)")),g.call(f.scale(l).orient("left").ticks(5,d3.format(",d"))),a.transition().duration(500).call(q)},this.makeTitle=function(){},this.updateVals=this.update,this.chunkInfo=function(a,b,c,d){function e(){if(!n||!o)for(var d in b)if(b.hasOwnProperty(d)){var e=j.getVal(a,b,d,c);if(void 0!==e){e=j.wrapDataType(e,d);var f=j.unwrapDataType(e);q++,!n&&(void 0===k||g>f)&&(k=e,g=j.unwrapDataType(k)),!o&&(void 0===l||f>h)&&(l=e,h=j.unwrapDataType(l))}}}function f(){for(var e in b)if(b.hasOwnProperty(e)&&(!d||d(e,b))){var f=j.getVal(a,b,e,c);if(void 0!==f&&(f=j.unwrapDataType(j.wrapDataType(f,e)),!isNaN(f)&&f>=r)){var g=Math.floor((f-x)/v);g>=0&&w>=g&&p[g].count++}}}var g,h,j=i,k=m[0],l=m[1],n=void 0!==k,o=void 0!==l,p=[],q=0;if(e(),void 0!==k&&void 0!==l){var r=j.unwrapDataType(k),s=j.unwrapDataType(l),t=Math.ceil(s/i.toNearest)*i.toNearest-Math.floor(r/i.toNearest)*i.toNearest;VESPER.log("MINS",s,r,k,l,t,i.childScale.range());var u=j.makeBarSizes(i.childScale.range()[1]-i.childScale.range()[0],t),v=u.newBinSize,w=u.newBinCount;VESPER.log("bb",v,w);for(var x=Math.floor(r/v)*v,y=0;w+1>y;y++){var z=x+v*y;p[y]={count:0,start:j.wrapDataType(Math.max(z,r)),end:j.wrapDataType(Math.min(z+v,s+v))}}f()}return{extremes:[k,l],bins:p}},this.returnMatches=function(a,b,c,d){var e=[],f=a.getData();for(var g in f)if(f.hasOwnProperty(g)){var h=i.getVal(a,f,g,b);void 0!==h&&(h=i.wrapDataType(h,g),h>=c&&d>h&&e.push(g))}return VESPER.log("Arr",c,d,e),e},this.calcCumulative=function(a){VESPER.log("Bins",a);for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count+=b,b+=d}},this.makeBarSizes=function(a,b){for(var c,d=b/a*i.minBarWidth,e=0;e<i.divisions.length;e++)if(i.divisions[e]>d||e===i.divisions.length-1){c=i.divisions[e];break}VESPER.log("bdw: ",d,b,a);var f=Math.ceil(b/c);return{newBinSize:c,newBinCount:f}},this.uncalcCumulative=function(a){for(var b=0,c=0;c<a.length;c++){var d=a[c].count;a[c].count-=b,b=d}},this.baseDestroy=function(){DWCAHelper.recurseClearEvents(d3.select(a));var b=d.selectAll(i.barClass);b.remove(),$(a+"Controls").draggable("destroy"),j.removeView(i),j=null,DWCAHelper.twiceUpRemove(a)},this.destroy=function(){this.baseDestroy()}},VESPER.TaxaDistribution=function(a){var b=new VESPER.BarChart(a);return b.makeTitle=function(a){var b=a.end-a.start==1;return"Subtaxa: "+a.start+(b?"":" to "+(a.end-1))+"<br>Count: "+a.count},b.wrapDataType=function(a){return a},b.unwrapDataType=function(a){return a},b.getVal=function(a,b,c,d){var e=a.getIndexedDataPoint(b[c],d.keyField),f=a.getIndexedDataPoint(b[c],d.realField);if(f==e||void 0==f){var g=a.getNodeFromID(c),h=a.getSubTaxa(g);return h?h.length:0}return void 0},b.divisions=[1,2,10,100],b},VESPER.TimeLine=function(a){var b=new VESPER.BarChart(a),c={};b.childScale=d3.time.scale(),b.barClass="timeBin",b.format=d3.time.format("Y%Y"),b.makeTitle=function(a){return a.start.toString()+"<br>to "+a.end.toString()+"<br>Records: "+a.count},b.wrapDataType=function(a,b){var d=void 0===b?void 0:c[b];return void 0===d?new Date(a):d},b.unwrapDataType=function(a){return a.getTime()},b.getVal=function(a,b,d,e){var f=a.getIndexedDataPoint(b[d],e.dateField);return c[d]||void 0===f||(c[d]=new Date(f)),f},b.destroy=function(){b.baseDestroy(),c={}};var d=864e5;return b.toNearest=7*d,b.divisions=[d,7*d,91.3125*d,365.25*d,365.25*d*10],b};var View=function(){};VESPER.demo=function(a,b){function c(){return l}function d(a){DWCAHelper.divDisplay(["#showOnZipLoadDiv"],"none"),DWCAHelper.divDisplay(["#selDiv"],"block"),d3.select("#filenamePlaceholder").html(a.name),d3.select("#filesizePlaceholder").html("..."),d3.select("#dynamicSelectDiv").selectAll("span input").property("checked",!1),d3.select("#loadButton").property("disabled",!0)}function e(a){var c=d3.select(b).select("table");if(c.empty()){c=d3.select(b).append("table");var e=c.append("tr"),f=["Data Set","Description","Originator"],g=e.selectAll("th").data(f);g.enter().append("th").text(function(a){return a})}var h=c.selectAll("tr").data(a,function(a){return void 0==a?void 0:a.name}),i=h.enter().append("tr");i.append("td").append("button").attr("class","choice").attr("type","button").attr("id",function(a){return a.name}).text(function(a){return a.name}).on("click",function(a){NapVisLib.xhr2(a.file,"text/plain; charset=x-user-defined",function(a){var b=NapVisLib.getText(a);NapVisLib.showProps(a),p(b)}),d(a)}),i.append("td").text(function(a){return a.description}),i.append("td").text(function(a){return a.origin}),NapVisLib.makeFileLoadButton(d3.select("#yourData"),"choice","localLoader","Load",function(a,b){d(a),p(b)})}function f(a,b){for(var d=d3.select("#listDiv"),e=d3.select("#dynamicSelectDiv"),f=0;f<a.length;f++){var g=a[f],k=DWCAHelper.addCheckbox(e,g,"fieldGroup"),l=function(a){var b=d3.select(this).property("checked");DWCAHelper.setAllFields(d,b,a.attList,DWCAHelper.isIdWrap,c(),m);var f=d3.select(d3.select(this).node().parentNode).attr("class"),g=e.selectAll("span."+f+" input[type='checkbox']"),h=DWCAHelper.reselectActiveVisChoices(g,d,function(){return c()},m);d3.select("#loadButton").property("disabled",h.empty())};DWCAHelper.configureCheckbox(k,g.attList,l)}for(var n=d3.select("#labelSelectDiv"),f=0;f<b.length;f++){var g={fieldType:b[f],rowType:void 0},o=DWCAHelper.addRadioButton(n,g,"fieldGroup","nameChoice",function(a){return a.fieldType});DWCAHelper.configureRadioButton(o,d,function(a){c().vesperAdds.nameLabelField=$.extend({},a),j()},function(){return c()},m)}var p=function(a){var b=d3.select("#dynamicSelectDiv").selectAll(".fieldGroup input");if(b=b.filter(function(){return"none"!=d3.select(this).style("display")}),b.property("checked",a),!a){var d=d3.select("#labelSelectDiv").selectAll(".fieldGroup input");d=d.filter(function(){return"none"!=d3.select(this).style("display")}),d.property("checked",a),c().vesperAdds.nameLabelField=null}};DWCAHelper.addHelperButton(d3.select("#advancedSelectDiv"),d,"Remove Verbose Fields",VESPER.DWCAParser.flabbyLists.wordyList,!1,null,"selButtonStyle listCon",function(){return c()},m);var q=function(a,b){return 0==b};d3.select("#allButton").on("click",function(){return DWCAHelper.setAllFields(d,!0,void 0,q,c(),m),p(!0),!1}),d3.select("#clearButton").on("click",function(){return DWCAHelper.setAllFields(d,!1,void 0,q,c(),m),p(!1),!1});var r=DWCAHelper.addCheckbox(d3.select("#advancedSelectDiv"),{title:"Search DWCA Extensions",image:null},"fieldGroup");r.select("input").property("checked",m.useExtRows).on("click",function(){m.useExtRows=!m.useExtRows,h(c()),i(c())});var s=DWCAHelper.addCheckbox(d3.select("#advancedSelectDiv"),{title:"Select First Matching Field Only",image:null},"fieldGroup");s.select("input").property("checked",m.selectFirstOnly).on("click",function(){m.selectFirstOnly=!m.selectFirstOnly});var t=function(){var a=d3.select(this).property("checked")?"block":"none";return DWCAHelper.divDisplay(["#advancedSelectDiv","#listDiv"],a),!1},u=DWCAHelper.addCheckbox(d3.select("#advRevealPlaceholder"),{title:"Advanced Options",image:null},"showAdv");u.select("input").on("click",t)}function g(a,b){k=VESPER.DWCAParser.filterReadZipEntriesToMakeModel(a,b),VESPER.log("META",l),VESPER.log("MODEL",k),VESPER.alerts&&alert("mem monitor point X"),DWCAHelper.divDisplay(["#selDiv"],"none"),DWCAHelper.divDisplay(["#allVisDiv"],"block"),k.name=d3.select("#filenamePlaceholder").text().replace(/\W/g,""),(new VESPER.VisLauncher).makeVis(n[0],k),k=null,l=null}function h(a){var b=d3.select("#labelSelectDiv").selectAll("span.fieldGroup");b.style("display",function(b){var c=DWCAHelper.fieldListExistence(a,[b.fieldType],!0,void 0,m.useExtRows);return c.fields.length>0&&(b.rowType=c.fields[0].rowName),c.match?null:"none"})}function i(a){var b=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup");VESPER.log(b),b.property("checked",!1).style("display",function(b){var c=DWCAHelper.fieldListExistence(a,b.attList,b.matchAll,b.matchAtLeast,m.useExtRows);return c.match?null:"none"})}function j(){var a=d3.select("#dynamicSelectDiv").selectAll("span.fieldGroup input");DWCAHelper.reselectActiveVisChoices(a,d3.select("#listDiv"),function(){return c()})}VESPER.tooltip.init();var k,l,m={useExtRows:!0,selectFirstOnly:!0},n=[{title:"VisChoices",multiple:!1,attList:["unachievable"],matchAll:!0,image:VESPER.imgbase+"tree.png",height:"null",width:"200px",newVisFunc:function(a){return new VESPER.VisLauncher(a)},setupFunc:function(){return{visChoiceData:n}}},{title:"Implicit Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.Tree(a)},setupFunc:function(){return{rankField:"taxonRank"}}},{title:"Explicit Taxonomy",multiple:!0,attList:VESPER.DWCAParser.neccLists.expTaxonomy,matchAtLeast:2,matchAll:!1,image:VESPER.imgbase+"tree.png",height:"600px",newVisFunc:function(a){return new VESPER.Tree(a)},setupFunc:function(){return{rankField:"taxonRank"}}},{title:"Map",multiple:!0,attList:VESPER.DWCAParser.neccLists.geo,matchAll:!0,image:VESPER.imgbase+"world.png",height:"400px",newVisFunc:function(a){return new VESPER.DWCAMapLeaflet(a)},setupFunc:function(){return{latitude:"decimalLatitude",longitude:"decimalLongitude"}}},{title:"Timeline",multiple:!0,attList:VESPER.DWCAParser.neccLists.basicTimes,matchAll:!0,image:VESPER.imgbase+"calendar.png",height:"200px",newVisFunc:function(a){return VESPER.TimeLine(a)},setupFunc:function(){return{dateField:"eventDate"}}},{title:"Sanity Check",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"geo.png",height:"400px",newVisFunc:function(a){return new VESPER.Sanity(a)},setupFunc:function(){return void 0}},{title:"Taxa Distribution",multiple:!0,attList:VESPER.DWCAParser.neccLists.impTaxonomy,matchAll:!0,image:VESPER.imgbase+"tree.png",height:"200px",newVisFunc:function(a){return VESPER.TaxaDistribution(a)},setupFunc:function(){return{realField:"acceptedNameUsageID",rankField:"taxonRank"}}},{title:"Search Box",multiple:!0,attList:[],matchAll:!1,image:VESPER.imgbase+"geo.png",height:"150px",width:"200px",newVisFunc:function(a){return new VESPER.FilterView(a)},setupFunc:function(){return{}}}],o=n.slice(0,6),p=function(a){var b=d3.select("#filesizePlaceholder");b.html(null),b.append("img").attr("class","vesperIcon").attr("src",VESPER.imgbase+"zipIcon.gif"),b.append("span").text((a.length|a.byteLength).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+" bytes"),VESPER.alerts&&alert("check memory use in task manager");var c=VESPER.DWCAParser.accessZip(a,"meta.xml"),d=c.meta;if(l=d,l.error)alert(l.error+" Check DWCA meta.xml compliance.");else{var e=c.jszip;DWCAHelper.makeFieldSelectionBoxes(d,d3.select("#listDiv")),d3.select("#loadButton").on("click",null).on("click",function(){return g(e,d),!1}),i(d),h(d);var f=d3.select("#labelSelectDiv").selectAll("span.fieldGroup"),j=!0;f.each(function(){var a=d3.select(this).style("display");if("none"!=a&&j){j=!1;var b=d3.select(this).select("input"),c=document.createEvent("MouseEvent");c.initEvent("click",!0,!0),b.node().dispatchEvent(c)}}),DWCAHelper.divDisplay(["#showOnZipLoadDiv"],"block")}};e(a),f(o,VESPER.DWCAParser.labelChoiceData)};var DWCAHelper=new function(){function a(a){var b=this.checked,c=d3.select(this.parentNode),d=VESPER.DWCAParser.controlledVocabSet[a]?"#999977":"#888888";c.style("background",b?"":d)}function b(a,b){return a.rowType==b.coreRowType}function c(a,b){return a.invFieldIndex[a.idIndex]===b}function d(a,b){return a.selectedItems[b]===!0||c(a,b)}function e(a,b,c){a.selectedItems[b]=c}function f(a){return a.selected===!0}function g(a,b){a.selected=b}function h(b,e,g){VESPER.log("rt",b,e,g);var h=e.fileData[g],i=f(h);b.style("background",i?"":"#888888"),b.selectAll("td").style("background",function(b){return d(h,b)&&i?a(b):"#888888"}),b.selectAll("td input").attr("disabled",function(a){return c(h,a)||!i?"disabled":null}).property("checked",function(a){return d(h,a)}),b.selectAll("th").style("background",function(b){return i?a(b):"#888888"}),b.selectAll("th input").property("checked",function(){return i})}this.getSelectedTickBoxValues=function(a,b){function c(){this.checked&&(f[this.value]=!0)}var d="input[type=checkbox]"+(b?"."+b:""),e=d3.select(a).selectAll(d),f={};return e.each(c),f},this.isIdWrap=function(a,b){return c(a,b)},this.makeFieldSelectionBoxes=function(b,i){function j(f,g){VESPER.log("makerow args",arguments);var i=f;VESPER.log("table",g,f);var j=d3.select(this),k=j.attr("id"),l=f.value.invFieldIndex.filter(function(a){return void 0!==a}),m=j.selectAll("tr.col").data(l);m.exit().selectAll("input").on("click",null),m.exit().remove();var n=m.enter().append("tr").attr("class","col").append("td");n.append("input").attr("type","checkbox").attr("class","CSVField"),n.append("label");var o=m.select("td");o.select("input").property("checked",function(a){return d(i.value,a)}).attr("id",function(a){return k+a}).attr("value",function(a,b){return b}).attr("name",function(a){return a}).attr("disabled",function(a){return c(i.value,a)?"disabled":null}).on("click",null).on("click",function(a){var c=this.checked;return VESPER.log("fdEntry",i,c,this),e(i.value,a,c),h(j,b,i.key),!0}).each(a),o.select("label").attr("for",function(a){return k+a}).text(function(a){return a})}g(b.fileData[b.coreRowType],!0),VESPER.log("meta",b);for(var k=d3.entries(b.fileData),l=0;l<k.length;l++)k[l].value.selectedItems=k[l].value.selectedItems||{};var m=i.selectAll("div.selectBox").data(k,function(a){return a.key});m.exit().selectAll("input").on("click",null),m.exit().remove();var n=Math.floor(100/k.length)-2,o=m.enter().append("div").attr("class","selectBox").append("table");m.style("width",n+"%").select("table").attr("class",function(a){return a.key==b.coreRowType?"coreTable":null}).attr("id",function(a){return a.value.mappedRowType});var p=o.append("tr").append("th");p.append("input").attr("type","checkbox").attr("class","extensionFile").attr("id",function(a){return"cbox"+a.value.mappedRowType}).property("checked",function(a){return f(a.value)}).attr("value",function(a){return a.value.rowType}).attr("name",function(a){return a.value.mappedRowType}).attr("disabled",function(a){return a.key==b.coreRowType?"disabled":null}).on("click",function(a,c){var d=this.checked;return VESPER.log("check",d,this),g(a.value,d),h(d3.select(o[0][c]),b,a.key),!0}).each(a),p.append("label").attr("for",function(a){return"cbox"+a.value.mappedRowType}).text(function(a){return a.value.mappedRowType}),VESPER.log("divs",m),m.selectAll("table").each(j)},this.getAllSelectedFilesAndFields=function(a){var b={},c=a.fileData;for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e.selected){var f=e.selectedItems;VESPER.log("so",f);var g={},h=0;for(var i in f)f.hasOwnProperty(i)&&f[i]&&(g[i]=!0,h++);if(h){var j=e.invFieldIndex[e.idIndex];g[j]=!0,b[d]=g}}}return VESPER.log("Sel Struc",b),b},this.setAllFields=function(a,c,d,e,f,i){for(var j=a.selectAll("table"),k=i?i.useExtRows:!0,l=i?i.selectFirstOnly:!1,m=f.fileData,n=d3.entries(m).sort(function(a,c){return b(a.value,f)?-1:b(c.value,f)?1:0}),o=d?d.slice(0):void 0,p=0;p<n.length;p++){var q=n[p].value,r=q.selectedItems,s=o||q.invFieldIndex;if(void 0!==r){for(var t=0;t<s.length;t++){var u=s[t];q.fieldIndex[u]&&(r[u]=b(q,f)||k?(e?e(q,u):!1)||c:!1,c&&l&&o&&(o[t]=null))}var v=d3.values(r),w=d3.set(v);g(q,w.has("true")),VESPER.log(q.rowType,w.has("true"))}}g(f.fileData[f.coreRowType],!0),j.each(function(a){h(d3.select(this),f,a.key)})},this.fieldListExistence=function(a,c,d,e,f){var g=d3.set(c),h=d3.set(),i=[];for(var j in a.fileData)if(a.fileData.hasOwnProperty(j)){var k=a.fileData[j];if(f||b(k,a))for(var l=0;l<k.invFieldIndex.length;l++){var m=k.invFieldIndex[l];g.has(m)&&(h.add(m),i.push({fieldName:m,rowName:j}))}}VESPER.log("List",c,"Match",i,h.values());var n=h.values().length,o=d?n===c.length:e?n>=e:n>0;return{match:o,fields:i}},this.addHelperButton=function(a,b,d,e,f,g,h,i,j){VESPER.log("IN",d,e,f,a.selectAll("button[type=button]."+h));var k=a.selectAll("button[type=button]."+h).data([{key:d,value:e,add:f}],function(a){return a.key});k.enter().append("button").attr("type","button").attr("class",h).attr("value",function(a){return a.key}).attr("name",function(a){return a.key}).on("click",function(a){DWCAHelper.setAllFields(b,a.add,a.value,c,i(),j)}).html(function(a){return(g?'<img src="'+g+'">':"")+a.key})},this.addCheckbox=function(a,b,c){function d(a){return a.title||a.name}var e=a.selectAll("span").data([b],function(a){return a.title});if(!e.enter().empty()){var f=e.enter().append("span").attr("class",c);f.append("input").attr("type","checkbox").attr("value",d).attr("name",d).attr("id",d).property("checked",!1);var g=f.append("label").attr("for",d);(b.icon||b.image)&&g.append("img").attr("class","vesperIcon").attr("alt",d).attr("src",function(a){return a.image||a.icon}),g.append("span").text(d)}return e},this.configureCheckbox=function(a,b,c){b&&(a.datum().attList=b),a.select("input").on("click",c)},this.reselectActiveVisChoices=function(a,b,d,e){a=a.filter(function(){return d3.select(this).property("checked")});var f=[];return a.each(function(a){f.push.apply(f,a.attList)}),DWCAHelper.setAllFields(b,!0,f,c,d(),e),a},this.addRadioButton=function(a,b,c,d,e){var f=a.selectAll("span").data([b],function(a){return e(a)});if(!f.enter().empty()){var g=f.enter().append("span").attr("class",c);g.append("input").attr("type","radio").attr("value",e).attr("name",d).attr("id",function(a){return e(a)+"RBChoice"}).property("checked",!1),g.append("label").attr("for",function(a){return e(a)+"RBChoice"}).text(e)}return f},this.configureRadioButton=function(a,b,d,e,f){a.select("input").on("click",function(a){var g=d3.select(this).property("checked"),h=d3.select(this).attr("name"),i=d3.selectAll("input[type='radio'][name='"+h+"']"),j=[];i.each(function(a){j.push(a.fieldType)}),DWCAHelper.setAllFields(b,!1,j,c,e(),f),DWCAHelper.setAllFields(b,g,[a.fieldType],c,e(),f),d(a)})},this.divDisplay=function(a,b){for(var c=0;c<a.length;c++)d3.select(a[c]).style("display",b)},this.twiceUpRemove=function(a){var b=d3.select(a).node(),c=b.parentElement;$(function(){$(c).draggable("destroy")}),c.parentElement.removeChild(c)},this.recurseClearEvents=function(a){a.on("mouseout",null).on("mouseover",null).on("mousedown",null).on("mouseup",null).on("click",null).on("contextmenu",null),VESPER.log("REC SEL",a),a.each(function(){var a=d3.select(this),b=a.selectAll("*");b.empty()||DWCAHelper.recurseClearEvents(b)})}};VESPER.DWCAMapLeaflet=function(a){function b(){var a=k._topClusterLevel.getChildCount(),b=Math.log(a+1);r=q/b}function c(a,b,c){var d,e,f,g,h=!1;if(!b.contains(c))return!1;for(f=0,g=a.length;g>f;f++)d=a[f],e=a[(f-1+g)%g],d.lat>c.lat!=e.lat>c.lat&&c.lng<(e.lng-d.lng)*(c.lat-d.lat)/(e.lat-d.lat)+d.lng&&(h=!h);return h}var d,e,f,g,h,i,j,k,l,m,n=this,o=a.substring(1),p={},q=60,r=5,s=L.icon({iconUrl:VESPER.imgbase+"selMarker.png",shadowUrl:"../lib/leafletjs/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41],shadowAnchor:[4,62]}),t=new L.Icon.Default,u=function(a){VESPER.tooltip.updateText(a.latlng,a.layer.getChildCount()+" Records"+(a.layer.getSelectedChildCount()>0?"<br>"+a.layer.getSelectedChildCount()+" Selected":"")),VESPER.tooltip.updatePosition(a.originalEvent)},v=function(a){var b=[],c=[];if(a.layer.getAllChildMarkers(b),b.length>0){for(var d=0;d<b.length;d++)c.push(b[d].extId);h.getSelectionModel().clear(),h.getSelectionModel().addAllToMap(c)}},w=function(a){var b=a.target.extId,c=h.getNodeFromID(b);VESPER.tooltip.updateText(h.getLabel(c),a.latlng+(h.getSelectionModel().contains(b)?"<br>Selected":"")),VESPER.tooltip.updatePosition(a.originalEvent)},x=function(a){h.getSelectionModel().clear(),h.getSelectionModel().addToMap(a.target.extId)},y=function(a){var b=a.layerType,d=a.layer,e=[];if("circle"===b){VESPER.log("circle",a);var f=a.layer._latlng,g=a.layer._mRadius;k.eachLayer(function(a){var b=a.getLatLng();f.distanceTo(b)<=g&&e.push(a.extId)})}else if("rectangle"===b){VESPER.log("rectangle",a);var j=a.layer._latlngs,l=new L.LatLngBounds(j[0],j[2]);k.eachLayer(function(a){var b=a.getLatLng();l.contains(b)&&e.push(a.extId)})}else if("polygon"===b){VESPER.log("polygon",a);var j=a.layer._latlngs,m=new L.LatLngBounds(j);k.eachLayer(function(a){var b=a.getLatLng();c(j,m,b)&&e.push(a.extId)})}VESPER.log(e.length,"specimens within",b),i=d,h.getSelectionModel().clear(),h.getSelectionModel().addAllToMap(e)};this.set=function(b,c){var i=c.makeIndices([b.identifyingField,b.longitude,b.latitude]);e=i[0],f=i[1],g=i[2],d=NapVisLib.getDivDims(a),h=c,VESPER.log("set model for map",h)},this.go=function(){if(VESPER.log("map go"),!m){var c="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",d="Map data � OpenStreetMap contributors",e=new L.TileLayer(c,{minZoom:1,maxZoom:19,attribution:d});d3.select(a).style("overflow","hidden"),m=L.map(o),m.addLayer(e);var i=new L.Control.Draw({draw:{marker:!1,polyline:!1}});
m.addControl(i),m.on("draw:created",y),k=new L.MarkerClusterGroup({iconCreateFunction:function(a){var b=Math.log(a.getChildCount()+1),c=10+b*r,d=c*Math.log(a.getSelectedChildCount()+1)/b,e=c-d;return.5>e&&a.getChildCount()==a.getSelectedChildCount()&&(e=0),new L.DivIcon({html:'<div class="unselected" style="height:'+e+'px">'+a.getChildCount()+'</div><div class="selected" style="height:'+d+'px">'+a.getSelectedChildCount()+"</div>",className:"vesperMapIcon",iconSize:new L.Point(40,c)})}}),k.on("clustermouseover",u),k.on("clustercontextmenu",v)}var n=[],q=[],s=h.getData();if(g&&f){var t=[],z=[];for(var A in s)if(s.hasOwnProperty(A)){t.length=0,z.length=0,h.getIndexedDataPoints(s[A],g,t),h.getIndexedDataPoints(s[A],f,z);for(var B=t.length;--B>=0;){var C=+t[B],D=+z[B];if(!isNaN(C)&&!isNaN(D)){var E=[C,D],F=L.marker(E).on("mouseover",w).on("contextmenu",x);if(F.extId=A,q.push(F),n.push(E),p[A]){var G=p[A];if(G.extId){var H=[G];p[A]=H,G=H}G.push(F)}else p[A]=F}}}k.addLayers(q)}m.addLayer(k),m.fitBounds(new L.LatLngBounds(n).pad(1.05));var I=L.TileLayer.maskCanvas({opacity:.6,radius:5,useAbsoluteRadius:!1,color:"#aaf",noMask:!0});I.setData(n),j=L.TileLayer.maskCanvas({opacity:.8,radius:5,useAbsoluteRadius:!1,color:"#f00",noMask:!0}),j.setData([]),l=L.layerGroup([I,j]),L.control.layers({},{"Marker Group":k,"Direct Plot":l}).addTo(m),L.control.scale().addTo(m),VESPER.log("group ",k),VESPER.log("map ",m),b()},this.update=function(){var a=h.getSelectionModel().values();if(void 0!==k){b(),k.eachLayer(function(a){var b=h.getSelectionModel().contains(a.extId);a.setIcon(b?s:t)});for(var c,d=[],e=0;e<a.length;e++){var f=p[a[e]];if(f)if(f.extId)d.push(f.getLatLng()),c=f;else for(var g=f.length;--g>=0;){var i=f[g];d.push(i.getLatLng()),c=i}}if(k.setAllSelectedChildCounts(h.getSelectionModel()),1==d.length)k.zoomToShowLayer(c,function(){c.openPopup()});else if(d.length>1){var l=new L.LatLngBounds(d);m.fitBounds(l)}j.setData(d)}},this.destroy=function(){m.addLayer(k),m.addLayer(l),h.removeView(n),h=null,k.removeEventListener(),k.eachLayer(function(a){a.removeEventListener()}),k.clearLayers(),j.setData([]);var b=[];m.eachLayer(function(a){b.push(a)}),m.removeEventListener();for(var c=0;c<b.length;c++)m.removeLayer(b[c]);m.remove(),p={},DWCAHelper.twiceUpRemove(a)},this.updateVals=this.update,L.MarkerClusterGroup.include({setAllSelectedChildCounts:function(a){return this._topClusterLevel.setAllSelectedChildCounts(a)}}),L.MarkerCluster.include({_selChildCount:0,setAllSelectedChildCounts:function(a){for(var b=0,c=this._markers.length-1;c>=0;c--)a.contains(this._markers[c].extId)&&b++;for(var d=this._childClusters.length-1;d>=0;d--)b+=this._childClusters[d].setAllSelectedChildCounts(a);return this._selChildCount=b,this._updateIcon(),b},getSelectedChildCount:function(){return this._selChildCount}})},VESPER.DWCAParser=new function(){function a(a){var b=e[a];return void 0===b?a:b}function b(a,b,c){a[b]||(a[b]=[]),a[b].push(c)}function c(a,b){if(VESPER.log("FIIII",a),void 0==a.filteredFieldIndex[b]){var c=a.filteredInvFieldIndex.length;a.filteredInvFieldIndex.push(b),a.filteredFieldIndex[b]=c,c=a.invFieldIndex.length,a.invFieldIndex.push(b),a.fieldIndex[b]=c}VESPER.log("FIIII2",a)}function d(a){var b=a?a.lastIndexOf("/")+1:-1;return b>0?a.substring(b):a}this.TDATA=0,this.TAXA=1,this.EXT=2,this.SYN=3,this.PID=4,this.SPECS="s",this.SUPERROOT="superroot";var e={"class":"classs",DarwinCore:"Occurrence",SimpleDarwinCore:"Occurrence",catalogNumberNumeric:"catalogNumber",collectorNumber:"recordNumber",collector:"recordedBy",nativeness:"establishmentMeans",latestDateCollected:"eventDate",earliestDateCollected:"eventDate",state:"stateProvince",province:"stateProvince",city:"municipality",depth:"verbatimDepth",elevation:"verbatimElevation",latitude:"decimalLatitude",longitude:"decimalLongitude",datum:"geodeticDatum",nameUsageID:"taxonID",nameID:"scientificNameID",acceptedTaxonID:"acceptedNameUsageID",parentTaxonID:"parentNameUsageID",higherTaxonID:"parentNameUsageID",higherNameUsageID:"parentNameUsageID",originalNameID:"originalNameUsageID",originalTaxonID:"originalNameUsageID",basionymID:"originalNameUsageID",taxonAccordingToID:"nameAccordingToID",acceptedTaxon:"acceptedNameUsage",parentTaxon:"parentNameUsage",higherTaxon:"parentNameUsage",higherNameUsage:"parentNameUsage",originalName:"originalNameUsage",originalTaxon:"originalNameUsage",basionym:"originalNameUsage",taxonAccordingTo:"nameAccordingTo",rank:"taxonRank",scientificNameRank:"taxonRank",taxonRemark:"taxonRemarks",EventAttributeType:"measurementType",eventMeasurementType:"measurementType",SamplingAttributeType:"measurementType"};this.flabbyLists={},this.flabbyLists.wordyList=["eventRemarks","taxonRemarks","georeferenceRemarks","identificationRemarks","locationRemarks","measurementRemarks","occurrenceRemarks","relationshipRemarks","verbatimCoordinates","bibliographicCitation","description"],this.explicitRanks=["kingdom","phylum","classs","order","family","genus","subgenus","specificEpithet","infraspecificEpithet"],this.neccLists={},this.neccLists.geo=["decimalLatitude","decimalLongitude","geodeticDatum"],this.neccLists.impTaxonomy=["acceptedNameUsageID","parentNameUsageID","taxonRank"],this.neccLists.expTaxonomy=this.explicitRanks,this.neccLists.times=["eventDate","modified","geodeticDatum","georeferencedDate","dateIdentified","verbatimEventDate"],this.neccLists.basicTimes=["eventDate"],this.labelChoiceData=["acceptedNameUsage","scientificName","originalNameUsage","vernacularName"],this.controlledVocabFields=["continent","country","countryCode","stateProvince","county","island","islandGroup","waterBody","higherGeographyID","geodeticDatum","georeferenceVerificationStatus","verbatimCoordinateSystem","verbatimSRS","taxonomicStatus","language","nomenclaturalCode","nomenclaturalStatus","identificationVerificationStatus","rightsHolder","type","audience","format","taxonRank","verbatimTaxonRank","basisOfRecord","dcterms:type","dcterms:language","measurementUnit","behavior","relationshipOfResource","establishmentMeans","occurrenceStatus","disposition","sex","lifeStage","reproductiveCondition","isPlural","threatStatus","isMarine","isFreshwater","isTerrestrial","isInvasive","isHybrid","isExtinct","typeDesignationType"],this.archiveLimitedFields=["institutionID","collectionID","datasetID","institutionCode","collectionCode","datasetName","ownerInstitutionCode","year","month","day","source","nameAccordingToID","isPreferredName","typeStatus","verbatimTaxonRank","superkingdom","kingdom","superphylum","phylum","subphylum","superclass","classs","order","family"],this.controlledVocabSet={};for(var f=0;f<this.controlledVocabFields.length;f++)this.controlledVocabSet[this.controlledVocabFields[f]]=!0;this.discreteTermList=this.controlledVocabFields.concat(this.archiveLimitedFields),this.discreteTermSet={};for(var f=0;f<this.discreteTermList.length;f++)this.discreteTermSet[this.discreteTermList[f]]=!0;this.sharedValuesTerms={taxonID:1,acceptedNameUsageID:1,parentNameUsageID:1,originalNameUsageID:1},this.recordURIMap={"http://rs.tdwg.org/dwc/xsd/simpledarwincore/SimpleDarwinRecord":"Simple Darwin Record","http://rs.tdwg.org/dwc/terms/Occurrence":"Occurrence","http://rs.tdwg.org/dwc/terms/Event":"Event","http://purl.org/dc/terms/Location":"Location","http://purl.org/dc/terms/GeologicalContext":"GeologicalContext","http://rs.tdwg.org/dwc/terms/Identification":"Identification","http://rs.tdwg.org/dwc/terms/Taxon":"Taxon","http://rs.tdwg.org/dwc/terms/ResourceRelationship":"ResourceRelationship","http://rs.tdwg.org/dwc/terms/MeasurementOrFact":"MeasurementOrFact","http://rs.gbif.org/terms/1.0/Distribution":"Distribution","http://rs.gbif.org/terms/1.0/VernacularName":"VernacularName","http://rs.gbif.org/terms/1.0/SpeciesProfile":"SpeciesProfile","http://rs.gbif.org/terms/1.0/TypesAndSpecimen":"TypesAndSpecimen","http://rs.gbif.org/terms/1.0/Reference":"Reference","http://rs.gbif.org/terms/1.0/Image":"Image","http://rs.gbif.org/terms/1.0/Identifier":"Identifier","http://rs.gbif.org/terms/1.0/Description":"Description","http://rs.nordgen.org/dwc/germplasm/0.1/terms/GermplasmSample":"GermplasmSample","http://purl.org/germplasm/germplasmTerm#GermplasmAccession":"GermplasmAccession","http://purl.org/germplasm/germplasmTerm#MeasurementExperiment":"MeasurementExperiment","http://purl.org/germplasm/germplasmTerm#MeasurementMethod":"MeasurementMethod","http://eol.org/schema/reference/Reference":"EOL Reference","http://eol.org/schema/media/Document":"EOL Document","http://eol.org/schema/agent/Agent":"EOL Agent","http://www.w3.org/ns/oa#Annotationt":"W3 Annotation"},this.rowTypeDefaults={},this.fieldAttrNames={},this.xsd=null,this.loadxsd=function(a){VESPER.log("yp2",a),$.get(a,function(a){VESPER.log("XSD",a,typeof a),VESPER.DWCAParser.xsd="string"==typeof a?$(NapVisLib.parseXML(a)):$(a),VESPER.DWCAParser.makeRowTypeDefaults(VESPER.DWCAParser.xsd),VESPER.DWCAParser.makeFieldAttrNames(VESPER.DWCAParser.xsd)})},this.accessZip=function(a,b){var c=new JSZip(a,{base64:!1,noInflate:!0});c.dwcaFolder="";for(var d,e=0;e<c.zipEntries.files.length;e++){var f=c.zipEntries.files[e].fileName,g=f.indexOf(b);if(g>=0){d=f,c.dwcaFolder=d.slice(0,g);break}}if(console.log("ZIP ENTRIES",c.zipEntries,d),void 0!==d){c.zipEntries.readLocalFile(d),VESPER.log("unzipped ",c,c.files);var h=c.zipEntries.getLocalFile(d),i=VESPER.DWCAParser.parseMeta($.parseXML(h.uncompressedFileData));return{jszip:c,meta:i}}return{jszip:c,meta:{error:"Cannot locate "+b+" within zip."}}},this.filterReadZipEntriesToMakeModel=function(a,b){var c=DWCAHelper.getAllSelectedFilesAndFields(b),d={};return VESPER.log("ZIP:",a),$.each(c,function(c,e){var f=b.fileData[c],g=a.dwcaFolder+f.fileName,h=NapVisLib.newFilledArray(f.invFieldIndex.length,!1);$.each(e,function(a,b){h[f.fieldIndex[a]]=b}),VESPER.log("readFields",h),VESPER.DWCAZipParse.set(f,h),a.zipEntries.readLocalFile(g,VESPER.DWCAZipParse.zipStreamSVParser2),d[f.rowType]=a.zipEntries.getLocalFile(g).uncompressedFileData,VESPER.DWCAParser.updateFilteredLists(f,h)}),$.each(c,function(c){var d=b.fileData[c],e=a.dwcaFolder+d.fileName;a.zipEntries.getLocalFile(e).uncompressedFileData=null}),VESPER.alerts&&alert("mem monitor point 1"),new DWCAModel(b,VESPER.DWCAParser.setupStrucFromRows(d,b))},$.fn.filterNode=function(a){return this.find("*").filter(function(){return VESPER.log(this),this.nodeName?this.nodeName.toUpperCase()==a.toUpperCase():!1})},this.makeRowTypeDefaults=function(a){var b=a.find('xs\\:attributeGroup[name="fileAttributes"], attributeGroup[name="fileAttributes"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("default"),c=a.attr("type");"xs:integer"==c&&(b=+b),VESPER.DWCAParser.rowTypeDefaults[a.attr("name")]=b}),VESPER.log("rtd",VESPER.DWCAParser.rowTypeDefaults)},this.makeFieldAttrNames=function(a){var b=a.find('xs\\:complexType[name="fieldType"], complexType[name="fieldType"]'),c=$(b);$(c[0]).find("xs\\:attribute, attribute").each(function(){var a=$(this),b=a.attr("name"),c=a.attr("type");VESPER.DWCAParser.fieldAttrNames[b]=c}),VESPER.log("fan",VESPER.DWCAParser.fieldAttrNames)},this.occArray2JSONArray=function(a,b){var c={};VESPER.alerts&&alert("mem monitor point 1.4");for(var d=0,e=a.length;e>d;d++){var f=a[d];if(void 0!==f){var g=f[b];c[g]={},c[g][this.TDATA]=f}}return c},this.taxaArray2JSONTree=function(a,c,d){var e=c.filteredFieldIndex,f=c.idIndex,g=this.occArray2JSONArray(a,f);VESPER.alerts&&alert("mem monitor point 1.5");for(var h=e.parentNameUsageID,i=e.acceptedNameUsageID,j=0,k=a.length;k>j;j++){var l=a[j];if(void 0!==l){var m=l[f],n=l[h],o=g[n];n!=m&&void 0!=o&&b(o,VESPER.DWCAParser.TAXA,g[m])}}for(var j=0,k=a.length;k>j;j++){var l=a[j];if(void 0!==l){var m=l[f],n=l[h],o=g[n];if(void 0==o){var p=l[i];if(m!=p&&void 0!==p){var q=g[p];if(void 0!=q){var r=g[m];b(q,VESPER.DWCAParser.SYN,r);var s=r[VESPER.DWCAParser.TAXA];if(s){for(var t=0;t<s.length;t++){var u=s[t],v=u[VESPER.DWCAParser.TDATA],w=v[f],x=v[i];w==x&&void 0!==x&&b(q,VESPER.DWCAParser.TAXA,u)}r[VESPER.DWCAParser.TAXA].length=0}}}}}}var y=this.findRoots(g,f,e);return this.createSuperroot(g,y,c,d,e),VESPER.log("roots",y),VESPER.log("JSON",g[1],g),{records:g,tree:g}},this.taxaArray2ExplicitJSONTree=function(a,d,e,f){c(d,"taxonRank");var g=d.idIndex,h=d.filteredFieldIndex,i=this.occArray2JSONArray(a,g);VESPER.alerts&&alert("mem monitor point 1.5a ex"),VESPER.log("SPECS",VESPER.DWCAParser.SPECS);var j=VESPER.DWCAParser.explicitRanks;console.log("Vesper adds",e.vesperAdds);for(var k=h[e.vesperAdds.nameLabelField.fieldType],l={},m=j.length,n={},o=[],p=[],q=0;m>q;q++){var r=j[q];("specificEpithet"==r||"infraspecificEpithet"==r)&&(o[q]=!0),p[q]=h[r]}for(var s=0,t=a.length;t>s;s++){var u=a[s];if(void 0!==u){for(var v=void 0,w=[],q=0;m>q;q++){var r=j[q],x=p[q];if(x){var y=u[x];if(w[q]=y,y){o[q]&&v&&(y=v[this.TDATA][k]+" "+y);var z=y;if(n[z]&&v){var A=v[this.TDATA][g],B=n[z][this.PID];A!=B&&(z=A+z,n[z]||VESPER.log("Introducing new id",z))}if(!n[z]){var C=[];C[g]=z,C[k]=y,C[h.taxonRank]=r;var D={};D[this.TDATA]=C,n[z]=D,v&&b(v,VESPER.DWCAParser.TAXA,D),D[this.PID]=v?v[this.TDATA][g]:-10}v||(l[z]=!0),v=n[z]}}}v&&f(v,i[u[g]],n,u[k],g,h,k)}}var E=d3.keys(l);return this.createSuperroot(n,E,d,e,h),VESPER.log("roots",E),VESPER.log("json",i,"tree",n),{records:i,tree:n}},this.addOriginalAsSpecimenEntry=function(a,c,d,e,f,g,h){var i=e;if(!d[i]){var j=[];j[f]=i,j[h]=i,j[g.taxonRank]="Species";var k={};k[VESPER.DWCAParser.TDATA]=j,d[i]=k,a&&b(a,VESPER.DWCAParser.TAXA,d[i])}b(d[i],VESPER.DWCAParser.SPECS,c)},this.addOriginalAsLeaf=function(a,c){b(a,VESPER.DWCAParser.TAXA,c)},this.addExtRows2JSON=function(a,c,d){var e=d.idIndex,f=[];if(c&&void 0!=e)for(var g=d.extIndex,h=0,i=c.length;i>h;h++){var j=c[h];if(void 0!==j){var k=j[e];if(void 0!=k){var l=a[k];if(void 0!=l){l[this.EXT]||(l[this.EXT]=[]);var m=l[this.EXT];b(m,g,j)}}else f.push(h)}}return f},this.makeTreeFromAllFileRows=function(a,b){var c,d=b.fileData,e=d[b.coreRowType];NapVisLib.endsWith(b.coreRowType,"Taxon")?c=this.taxaArray2JSONTree(a[e.rowType],e,b):NapVisLib.endsWith(b.coreRowType,"Occurrence")&&(c=this.taxaArray2ExplicitJSONTree(a[e.rowType],e,b,VESPER.DWCAParser.addOriginalAsSpecimenEntry));for(var f in d)if(d.hasOwnProperty(f)){var g=d[f];if(b.coreRowType!==g.rowType&&g.selected){var h=this.addExtRows2JSON(c.records,a[g.rowType],g);VESPER.log("unreconciled in ",f,h)}}return c},this.setupStrucFromRows=function(a,b){var c=this.makeTreeFromAllFileRows(a,b);return VESPER.alerts&&alert("mem monitor point 2"),c.root=c.tree["-1000"],c.root&&this.countDescendants(c.root),VESPER.alerts&&alert("mem monitor point 3"),VESPER.log("root",c.root),c},this.findRoots=function(a,b,c){var d=[],e=c.parentNameUsageID,f=c.acceptedNameUsageID;if(void 0!==f&&void 0!==e)for(var g in a)if(a.hasOwnProperty(g)){var h=a[g],i=h[this.TDATA];if(void 0!==i){var j=i[b],k=i[f],l=i[e];j!=k&&void 0!=k||l!=j&&void 0!=a[l]||d.push(g)}}return d},this.createSuperroot=function(a,b,c,d,e){if(0==b.length)return void 0;if(1==b.length)return a["-1000"]=a[b[0]],a[b[0]];var f=e[d.vesperAdds.nameLabelField.fieldType],g=c.invFieldIndex[e.id],h=c.invFieldIndex[f],i=e.parentNameUsageID,j="-1000",k={acceptedNameUsageID:j,parentNameUsageID:j,acceptedNameUsage:VESPER.DWCAParser.SUPERROOT,taxonRank:VESPER.DWCAParser.SUPERROOT,nameAccordingTo:"dwcaParse.js"};k[h]=VESPER.DWCAParser.SUPERROOT,k[g]=j;var l={};l[this.TAXA]=[];for(var m=0;m<b.length;m++)l[this.TAXA].push(a[b[m]]),a[b[m]][VESPER.DWCAParser.TDATA][i]=j;l[VESPER.DWCAParser.TDATA]=[];for(var n in k)k.hasOwnProperty(n)&&void 0!==e[n]&&(l[VESPER.DWCAParser.TDATA][e[n]]=k[n]);return VESPER.log("superroot",l),a[j]=l,l},this.countDescendants=function(a){if(void 0!=a[this.TAXA]){a.dcount=0;for(var b=0;b<a[this.TAXA].length;b++)a.dcount+=this.countDescendants(a[this.TAXA][b])}return(a.dcount||(a[VESPER.DWCAParser.SPECS]?a[VESPER.DWCAParser.SPECS].length:0))+1},this.parseMeta=function(a){var b={},c=this.getCoreRowType(a);b[c]=this.parseCore(a,c);for(var d=this.getExtensionRowTypes(a),e=0;e<d.length;e++)b[d[e]]=this.parseExtension(a,d[e],e);var f={coreRowType:c,extRowTypes:d,fileData:b,vesperAdds:{}};return void 0==c?f.error="JQuery cannot find element[attribute]: core[rowType] within xml.":b[c].error&&(f.error=b[c].error),f},this.parseCore=function(a,b){return this.parseFrag(a,'archive core[rowType="'+b+'"]',"id",b)},this.parseExtension=function(a,b,c){var d=this.parseFrag(a,'extension[rowType="'+b+'"]',"coreid",b);return d.extIndex=c,d},this.parseFrag=function(b,c,e,f){VESPER.log("thexml",typeof b,b);var g=$(b).find(c);if(void 0!==g[0]){var h=$(g[0]),i={},j=h.find("files location").contents();if(void 0!==j[0]){i.fileName=j[0].data,i.rowType=f,i.mappedRowType=this.recordURIMap[f]||f;for(var k in this.rowTypeDefaults)this.rowTypeDefaults.hasOwnProperty(k)&&(i[k]=void 0!==h.attr(k)?h.attr(k):this.rowTypeDefaults[k],VESPER.log("att",k,"#",i[k],"#"));VESPER.log(h.attr("fieldsEnclosedBy"));var l=+h.find(e).attr("index");i.idIndex=l;var m=h.find("field");VESPER.log("fieldsTerminatedBy",i.fieldsTerminatedBy),i.fieldIndex={},i.invFieldIndex=[],i.fieldData={},i.fieldIndex[e]=l,i.invFieldIndex[l]=e;for(var n=0;n<m.length;n++){var o=$(m[n]),p={};for(var q in VESPER.DWCAParser.fieldAttrNames)if(VESPER.DWCAParser.fieldAttrNames.hasOwnProperty(q)){var r=VESPER.DWCAParser.fieldAttrNames[q],s=o.attr(q);"xs:integer"==r&&(s=+s),p[q]=s}p.shortTerm=a(d(p.term));var t=p.index,u=p.shortTerm;p.discreteTermList=VESPER.DWCAParser.discreteTermSet[u]?{}:void 0,isNaN(t)||(i.fieldIndex[u]=t,i.invFieldIndex[i.fieldIndex[u]]=u),i.fieldData[u]=p}return i.filteredFieldIndex={},i.filteredInvFieldIndex=[],VESPER.log("filenames: ",j),i}return{error:"JQuery cannot find path [files location] within "+c+" section of xml."}}return{error:"JQuery cannot find path ["+c+"] within xml."}},this.updateFilteredLists=function(a,b){var c=0;a.filteredInvFieldIndex.length=0;var d=a.invFieldIndex[a.idIndex];$.each(a.filteredFieldIndex,function(b){b!=d&&(a.filteredFieldIndex[b]=void 0)});for(var e=0;e<b.length;e++)if(b[e]){var f=a.invFieldIndex[e];a.filteredFieldIndex[f]=c,a.filteredInvFieldIndex[c]=f,c++}VESPER.log("fi",a.fieldIndex,a.filteredFieldIndex,a.invFieldIndex,a.filteredInvFieldIndex)},this.getCoreRowType=function(a){var b=$(a).find("core"),c=$(b[0]).attr("rowType");return VESPER.log("core",c),c},this.getExtensionRowTypes=function(a){for(var b=$(a).find("extension"),c=[],d=0;d<b.length;d++){var e=$(b[d]).attr("rowType");c.push(e)}return c},this.getFilteredIdIndex=function(a){var b=a.fileData[a.coreRowType];return b.filteredFieldIndex[b.invFieldIndex[b.idIndex]]},this.selectNodes=function(a,b,c,d){var e=0,f=c.getData();if(void 0!==a&&a.length>0)for(var g in f)if(f.hasOwnProperty(g)){var h=f[g],i=b(c,h,a);i&&(e++,d(g))}return e},this.loadxsd("dwca.xsd")},VESPER.Filters=new function(){this.filter2=function(a,b,c){VESPER.log("regex",c);var d=a.getMetaData(),e=d.vesperAdds.nameLabelField,f=d.fileData[e.rowType],g=f.extIndex,h=f.filteredFieldIndex[e.fieldType],i=[],j=function(a,b,c){var d=a.getRowRecords(b,g);if(void 0==g&&(i[0]=d,d=i),d)for(var e=0;e<d.length;e++){var f=d[e][h];if(f&&null!=f.match(c))return!0}return!1};a.getSelectionModel().setUpdating(!0);var k=VESPER.DWCAParser.selectNodes(c,j,a,function(b){a.getSelectionModel().addToMap(b)});return a.getSelectionModel().setUpdating(!1),k}},VESPER.modelComparisons=new function(){function a(a,b){var c=NapVisLib.countObjProperties(a.getData()),d=NapVisLib.countObjProperties(b.getData());return d>c?a:b}this.modelCoverageToSelection=function(b,c,d,e){var f=a(b,c),g=f==b?c:b,h=f==b?d:e,i=f==b?e:d,j=f.getData(),k=g.getData(),l=f.getSelectionModel(),m=g.getSelectionModel();VESPER.log("lf",d,e),l.clear(),m.clear(),l.setUpdating(!0),m.setUpdating(!0);var n={};for(var o in j)if(j.hasOwnProperty(o)){var p=f.getDataPoint(j[o],h);n[p]=o}for(var o in k)if(k.hasOwnProperty(o)){var p=g.getDataPoint(k[o],i);n[p]&&(l.addToMap(n[p]),m.addToMap(o))}l.setUpdating(!1),m.setUpdating(!1)}},VESPER.Sanity=function(a){var b,c,d=this,e=100;this.set=function(a,c){b=c,VESPER.log("sanity model",b)},this.go=function(){c=this,this.update()};var f=function(){var a=[],c=[],d=b.getData(),e=VESPER.DWCAParser.neccLists;for(var f in e)if(e.hasOwnProperty(f)){var g=b.makeIndices(e[f]),h=NapVisLib.countNulls(g);0===h&&(a.push(g),c.push({listName:f,all:0,some:0}))}var i=0;for(var j in d)if(d.hasOwnProperty(j)){i++;for(var k=0;k<a.length;k++){for(var l=a[k],m=!1,n=!0,o=0;o<l.length;o++){var p=b.getIndexedDataPoint(d[j],l[o]);void 0===p||null===p?m=!0:n=!1}m&&c[k].some++,n&&c[k].all++}}return{outputs:c,dataCount:i}},g=function(){for(var a=d3.entries(b.getMetaData().fileData),c=b.getData(),d={},e=0;e<a.length;e++){var f=a[e].value.filteredInvFieldIndex,g=a[e].value.mappedRowType;d[g]={};for(var h=0;h<f.length;h++)d[g][f[h]]={recordType:g,name:f[h],count:0}}for(var i in c)if(c.hasOwnProperty(i))for(var e=0;e<a.length;e++){var j=a[e].value,k=b.getRowData(c[i],j.extIndex);k&&j.extIndex&&(k=k[0]);for(var f=j.filteredInvFieldIndex,g=j.mappedRowType,h=0;h<f.length;h++){var l=f[h];(void 0===k||void 0===k[h]||null===k[h])&&d[g][l].count++}}var m={};for(var n in d)if(d.hasOwnProperty(n)){var o=d[n];for(var p in o)o.hasOwnProperty(p)&&(m[n+" "+p]=o[p])}return m},h=function(){for(var a=d3.entries(b.getMetaData().fileData),c={},d=0;d<a.length;d++){var e=a[d].value.fieldData;for(var f in e)if(e.hasOwnProperty(f)){var g=d3.values(e[f].discreteTermList);g.length>0&&(c[f]={name:f,count:g.length})}}return c};this.update=function(){function b(a,b){var c=l.select("table."+a);if(c.empty()){var d=l.append("table").attr("class",a).append("tr");d.selectAll("th").data(b).enter().append("th").attr("class","sanityTableHeading").text(function(a){return a})}}function c(a){var b=l.select("table."+a);b.remove()}function d(a,b,c,d){a.exit().remove(),a.enter().append("tr").attr("class","sanityText"),VESPER.log("rows",a,a.enter()),k=c,a.each(b).each(d)}function i(a){function b(a,b){return(t[b]?t[b](a.value):a.value.toString())+(isNaN(a.value)?"":" ("+s(a.value/q)+")")}var c=[];if(k)for(var d=0;d<k.length;d++){var f=k[d];void 0!==a[f]&&c.push({key:f,value:a[f]})}else c=d3.entries(a);{var g=d3.select(this).selectAll("td").data(c);g.enter().append("td")}g.select("img").empty()&&(g.append("img").attr("class","sanityBarFail").attr("src",VESPER.imgbase+"blackpixel.gif"),g.append("img").attr("class","sanityBarOK").attr("src",VESPER.imgbase+"whitepixel.gif"),g.selectAll("img").attr("height",10)),g.select("img.sanityBarFail").attr("width",function(a){return isNaN(a.value)?0:Math.min(e,a.value/q*e)}),g.select("img.sanityBarOK").attr("width",function(a){return isNaN(a.value)?0:Math.min(e,e-a.value/q*e)}),g.select("span").empty()&&g.append("span").attr("class","sanityText"),g.select("span").text(b),g.attr("title",b)}function j(){}var k,l=d3.select(a),m=f(),n=g(),o=h(),p=m.outputs,q=m.dataCount,r=l.select("div.visHeader");r.empty&&d3.select(a).append("div").attr("class","visHeader").append("p"),l.select("div.visHeader").select("p").text("Sanity Check: "+q+" Records.");var s=d3.format(".2%"),t=[];b("visSanityTests",["Vis Type","some fields missing","all fields missing"]);var u=l.select("table.visSanityTests").selectAll("tr.sanityText").data(p);t.length=0,t[3]=s,t[4]=s,d(u,j,["listName","some","all"],i),$.isEmptyObject(n)||(b("fieldSanityTests",["Record Type","Field Type","fields missing"]),u=l.select("table.fieldSanityTests").selectAll("tr.sanityText").data(d3.values(n)),t.length=0,t[3]=s,d(u,j,["recordType","name","count"],i)),$.isEmptyObject(o)?c("vocabSanityTests"):(b("vocabSanityTests",["Field Type","Vocabulary Size"]),u=l.select("table.vocabSanityTests").selectAll("tr.sanityText").data(d3.values(o)),t.length=0,d(u,j,["name","count"],i))},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),b.removeView(d),b=null,DWCAHelper.twiceUpRemove(a)}},VESPER.FilterView=function(a){function b(){var b=d3.select(a).select("span input");b.on("keyup",function(){if(e||13===(d3.event.keyCode|d3.event.charCode)){c.getSelectionModel().clear();{VESPER.Filters.filter2(c,null,d3.select(this).property("value"))}}})}var c,d=this,e=!0;this.set=function(a,b){c=b},this.go=function(){var c=d3.select(a).attr("id")+"Text",d=d3.select(a).append("span");d.append("label").attr("for",c).text("Search"),d.append("input").attr("type","text").attr("id",c);var f=d.append("div");f.append("input").attr("name",c+"TypeAhead").attr("value",e?"checked":"").attr("checked",e).attr("type","checkbox").on("click",function(){e=d3.event.target.checked}),f.append("label").attr("for",c+"TypeAhead").text("Keystroke Search"),b(),this.update()},this.update=function(){},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),c.removeView(d),c=null,DWCAHelper.twiceUpRemove(a)}},VESPER.modelBag=[],VESPER.SelectedView=function(a){function b(a){function b(a){"http://"==a.data.substring(0,7)?d3.select(this).append("a").attr("href",function(a){return a.data}).attr("target","_blank").text(function(a){return a.data}):d3.select(this).text(function(a){return a.data})}a.append("td").attr("class","field").text(function(a){return a.field}),a.append("td").attr("class","value").each(b)}function c(a,b,c,d){var f=e.getMetaData().fileData;VESPER.log("table",d,"#"+b+"Table",c);var g=d3.select(d).select("#"+b+"Table"),h=g.selectAll("tr.hrow"),i=h.data([0]);i.enter().append("tr").attr("class","hrow");var j=f[c].filteredInvFieldIndex;h=g.selectAll("tr.hrow");var k=h.selectAll("th").data(j);k.text(function(a,b){return j[b]}),k.enter().append("th").text(function(a,b){return j[b]})}function d(a,b,c,d){var f=b,g=(e.getMetaData().fileData,d3.select(d).select("#"+b+"Table")),h=g.selectAll("tr.drow"),i=h.data(a[f]);i.exit().remove(),i.enter().append("tr").attr("class","drow").attr("id",function(a,c){return b+c});for(var j=0;j<a[f].length;j++){var k=a[f][j],l=g.select("#"+b+j).selectAll("td"),m=l.data(k);m.exit().text(""),m.text(function(a){return a}),m.enter().append("td").text(function(a){return a})}}var e,f="mappedRowType",g="extDetailTable",h="detailTable",i=this;this.set=function(a,b){e=b},this.go=function(){this.update()},this.update=function(){var i=e.getSelectionModel().values(),j=i[0],k=d3.select(a).selectAll("p.summary").data([i.length]);if(k.enter().append("p").attr("class","summary"),k.text(function(a){return"Selected "+a+" item"+(1===a?"":"s")+"."}),void 0!==j){var l=e.getMetaData(),m=l.fileData,n=e.getNodeFromID(j),o=d3.select(a).select("."+h);o.empty()&&(d3.select(a).append("table").attr("class",h),o=d3.select(a).select("."+h));var p=o.node();p.innerHTML="";var q=document.createElement("tr"),r=document.createElement("th"),s=document.createElement("th");r.innerHTML="Field",s.innerHTML="Value",q.appendChild(r),q.appendChild(s),p.appendChild(q);var t=[],u=m[l.coreRowType].filteredInvFieldIndex;VESPER.log("TAXON",j,n);for(var v=e.getTaxaData(n),w=0;w<v.length;w++)v[w]&&t.push({field:u[w],data:v[w]});var x=o.selectAll("tr.nonHeader").data(t);b(x);var y=x.enter().append("tr").attr("class","nonHeader");b(y);var z=d3.keys(e.getExtraData(n)),A=d3.select(a).selectAll("table."+g),B=A.data(z);B.exit().remove(),B.enter().append("table").attr("class",g).attr("id",function(a){return a+"Table"});for(var C={},D=0;D<l.extRowTypes.length;D++){var E=l.extRowTypes[D];C[m[E][f]]=E}for(var w=0;w<z.length;w++)c(e.getExtraData(n),z[w],C[z[w]],a),d(e.getExtraData(n),z[w],C[z[w]],a)}d3.select(a).selectAll("table").style("visibility",void 0===j?"collapse":"visible")},this.updateVals=this.update,this.destroy=function(){DWCAHelper.recurseClearEvents(d3.select(a)),e.removeView(i),e=null,DWCAHelper.twiceUpRemove(a)}},VESPER.Tree=function(a){function b(a,b){for(var c=b.getSpecimens(a),d=b.getDescendantCount(a),e=b.getSelectedDescendantCount(a),f=b.getSubTaxa(a),g="",h=0;h<w.length;h++)w[h]&&(g+=(h>0?"<br>":"")+w[h].fieldType+": "+b.getIndexedDataPoint(a,w[h]));g+=(void 0===f?c?"<hr>"+c.length+" specimens":"":"<hr>"+d+" descendants")+(e>0?void 0===f?c?"<br>"+e+" selected specimens":"":"<br>"+e+" selected descendants":"");var i=b.getSynonyms(a);if(i){g+="<hr><i>Synonymy</i>";for(var h=0;h<i.length;h++)g+="<br>"+b.getIndexedDataPoint(i[h],z)+": "+b.getLabel(i[h])}return g}function c(a){return void 0!==a&&"*"==a.charAt(0)?"url(#"+H+")":null}function d(){var b=a.substring(1),c=d3.select(a).append("div").attr("class","visControl").attr("id",b+"controls");NapVisLib.addHRGrooves(c),NapVisLib.makeSectionedDiv(c,[{header:"Space Allocation",sectionID:"Space"},{header:"Layout Style",sectionID:"Layout"},{header:"Sort",sectionID:"Sort"}],"section");var d=d3.select(a+"controlsSpace").selectAll("button.allocChoice").data(d3.entries(J),function(a){return a.key}),e=d.enter().append("span").attr("class","fieldGroup");e.append("input").attr("class","allocChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"alloc"}).property("checked",function(a){return r===a.value}).on("change",function(a){return r=a.value,g(q),!1}),e.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key});var f=d3.select(a+"controlsLayout").selectAll("button.layoutChoice").data(d3.entries(M),function(a){return a.key}),h=f.enter().append("span").attr("class","fieldGroup");h.append("input").attr("class","layoutChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"layout"}).property("checked",function(a){return s===a.value}).on("change",function(a){s=a.value;var b=n.selectAll(".treeNode");return i(b),b.remove(),g(q),!1}).html(function(a){return a.key}),h.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key});var j=d3.select(a+"controlsSort").selectAll("button.sortChoice").data(d3.entries(I),function(a){return a.key}),k=j.enter().append("span").attr("class","fieldGroup");k.append("input").attr("class","sortChoice").attr("type","radio").attr("id",function(a){return b+a.key}).attr("name",function(){return b+"sort"}).property("checked",function(a){return t===a.value}).on("change",function(a){return t=a.value,g(q),!1}).html(function(a){return a.key}),k.append("label").attr("for",function(a){return b+a.key}).html(function(a){return a.key}),$("#"+b+"controls").draggable()}function e(a){var b=v.getNodeFromID(a);return void 0==b&&(b=v.getNodeFromID(a.substring(1))),b}function f(a){var b=a.dcount;if(!b){var c=v.getSpecimens(a);c&&(b=c.length)}return b}function g(a){E&&(VESPER.alerts&&alert("about to calc layout"),E=!1),r.size(s.sizeBounds()).cutoff(s.cutoffVal).sort(t),VESPER.log("what alloc reports ",r.size()),VESPER.log("root",a);var b=r.nodes(a);VESPER.log(b.length,b),q=a;var c=n.selectAll(".treeNode").data(b,function(a){return a.id});s.prep(b),s.removeOld(c.exit());var d=c.exit().empty()?0:B;s.redrawExistingNodes(c,d),d+=c.empty()?0:C;var e=s.makeNew(c.enter());NapVisLib.d3fadeInNewGroups([e],D,d)}function h(a){var b=v.getIndexedDataPoint(a,z);if(void 0==a.sdcount||0==a.sdcount||v.getSelectionModel().contains(b))return a;var c=v.getSubTaxa(a);if(c){for(var d,e=0,f=0;f<c.length;f++){var g=c[f],i=v.getIndexedDataPoint(g,z);v.getSelectionModel().contains(i)?e++:g.sdcount>0&&(e++,d=g)}if(e>1)return a;d&&(a=h(d))}return a}function i(a){a.on("click",null).on("mouseover",null).on("mouseout",null).on("contextmenu",null)}function j(a){a.on("click",function(a){var b=e(a.id);g(b==q&&void 0!=b.parent?b.parent:b)}).on("mouseover",function(a){d3.select(this).selectAll("*").classed("highlight",!0);var c=e(a.id),d=b(c,v);VESPER.tooltip.updateText(v.getLabel(c),d),VESPER.tooltip.updatePosition(d3.event)}).on("mouseout",function(){d3.select(this).selectAll("*").classed("highlight",!1)}).on("contextmenu",function(a){k(e(a.id)),d3.event.preventDefault()})}function k(a){v.getSelectionModel().clear();var b=[];l(a,b),v.getSelectionModel().addAllToMap(b)}function l(a,b){var c=v.getIndexedDataPoint(a,z);b.push(c);var d=v.getSubTaxa(a);if(void 0!=d)for(var e=0;e<d.length;e++)l(d[e],b);
var f=v.getSpecimens(a);if(void 0!=f)for(var e=0;e<f.length;e++)l(f[e],b)}var m,n,o,p,q,r,s,t,u,v,w,x=this,y=d3.behavior.zoom();y.scaleExtent([1,4]);var z,A,B=400,C=1e3,D=400,E=!0,F=(d3.scale.category20c(),d3.scale.linear().domain([0,1]).range(["#ffcccc","#ff6666"]),{}),G={},H="hatchPattern",I={Alpha:function(a,b){var c=v.getLabel(a),d=v.getLabel(b);return d>c?-1:c>d?1:0},Descendants:function(a,b){var c=f(a),d=f(b);return c=c||0,d=d||0,c>d?-1:d>c?1:0},Selected:function(a,b){var c=v.getSelectionModel(),d=c.contains(v.getIndexedDataPoint(a,z)),e=c.contains(v.getIndexedDataPoint(b,z));return d===e?0:d===!0?-1:1},"Selected Desc":function(a,b){var c=(v.getSelectionModel(),a.sdcount),d=b.sdcount;return c===d?0:void 0===c?1:void 0===d?-1:c-d}},J={bottomUp:AdaptedD3.bottomUp().sort(null).value(function(a){return v.getLeafValue(a)}).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,z)}),bottomUpLog:AdaptedD3.logPartition().sort(null).value(function(a){return v.getLeafValue(a)}).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,z)}),topDown:AdaptedD3.topDown().sort(null).value(null).children(function(a){return v.getSubTaxa(a)}).nodeId(function(a){return v.getIndexedDataPoint(a,z)})},K={cutoffVal:4,sizeBounds:function(){return[o[1],o[0]]},booleanSelectedAttrs:function(a){a.attr("class",function(a){return v.getSelectionModel().contains(a.id)?"selected":"unselected"}).attr("y",function(a){return a.x}).attr("x",function(a){return a.y}).attr("width",function(a){return a.dy}).attr("height",function(a){return a.dx})},widthLogFunc:function(a){var b=e(a.id),c=f(b),d=b.sdcount>0&&c>0?Math.log(b.sdcount+1)/Math.log(c+1):0;return d*a.dy},xFunc:function(a){var b=e(a.id),c=f(b),d=b.sdcount>0&&c>0?Math.log(b.sdcount+1)/Math.log(c+1):0;return a.y+(1-d)*a.dy},propSharedAttrs:function(a,b,c){a.attr("class","holdsSelected").attr("y",function(a){return a.x}).attr("x",b).attr("height",function(a){return a.dx}).attr("width",c)},sharedTextAttrs:function(a){function b(a,b){return a.dx>a.dy&&d3.select(b).node().getComputedTextLength()<a.dx-4}a.attr("transform",function(a){return"translate ("+a.y+","+(a.x+Math.max((a.dx-14)/2+14,14))+") rotate ("+(b(a,this)?90:0)+" "+a.dy/2+" 0)"}).attr("clip-path",function(a){e(a.id);return b(a,this)?null:"url(#depthclip0)"})},prep:function(a){n.attr("transform","translate(0,0)"),K.makeTextClips(a)},removeOld:function(a){i(a),NapVisLib.d3fadeAndRemoveGroups([a],B,0)},makeNew:function(a){var b=a.append("svg:g").attr("class","treeNode").style("opacity",0).call(j);return b.append("svg:rect").call(K.booleanSelectedAttrs).style("fill",function(a){return c(a.id)}),b.append("svg:rect").style("opacity",.75).call(K.propSharedAttrs,this.xFunc,this.widthLogFunc),b.append("svg:text").text(function(a){var b=e(a.id);return v.getLabel(b)}).style("display",function(a){return a.dx>15&&a.dy>15?null:"none"}).call(K.sharedTextAttrs),b},redrawExistingNodes:function(a,b){a.select("rect:not(.holdsSelected)").transition().delay(b).duration(C).call(K.booleanSelectedAttrs),a.select("rect.holdsSelected").transition().delay(b).duration(C).call(K.propSharedAttrs,this.xFunc,this.widthLogFunc),a.select("text").style("display",function(a){return a.dx>15&&a.dy>15?null:"none"}).transition().delay(b).duration(C).call(K.sharedTextAttrs)},makeTextClips:function(a){for(var b=m.node().getBoundingClientRect().height,c=[],d=0;d<a.length;d++){var f=a[d],g=e(f.id);c[g.depth]||(c[g.depth]={depth:g.depth,x:f.y,y:-20,width:f.dy,height:b+20})}var h=m.select("defs").selectAll(".napierClip").data(c),i=function(a){a.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height})};h.exit().remove(),h.select("rect").call(i),h.enter().append("clipPath").attr("class","napierClip").attr("id",function(a){return"depthclip"+a.depth}).append("rect").call(i)}},L={cutoffVal:.05,sizeBounds:function(){var a=d3.min(o)/2;return VESPER.log("DIMS",o,a),[2*Math.PI,a*a]},booleanSelectedAttrs:function(a){a.attr("class",function(a){return v.getSelectionModel().contains(a.id)?"selected":"unselected"})},propSelectedAttrs:function(a){a.attr("class","holdsSelected")},sharedTextAttrs:function(a){a.attr("transform",function(a){return"translate ("+a.x+","+a.y+")"})},arc:d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),parc:d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){var b=Math.sqrt(a.y+a.dy),c=b-Math.sqrt(a.y),d=e(a.id),g=0,h=f(d);if(h>0&&d.sdcount>0){var g=Math.log(d.sdcount+1)/Math.log(h+1);g*=g}return b-g*c}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)}),cstash:function(a){F[a.id]={x0:a.x,dx0:a.dx,y0:a.y,dy0:a.dy}},pstash:function(a){G[a.id]={x0:a.x,dx0:a.dx,y0:a.y,dy0:a.dy}},arcTween:function(a){var b=F[a.id];if(void 0===b&&VESPER.log("No STORE",a.id,a),b){var c=d3.interpolate({x:b.x0,dx:b.dx0,y:b.y0,dy:b.dy0},a);return function(a){var d=c(a);return b.x0=d.x,b.dx0=d.dx,b.y0=d.y,b.dy0=d.dy,L.arc(d)}}},parcTween:function(a){var b=G[a.id],c=d3.interpolate({x:b.x0,dx:b.dx0,y:b.y0,dy:b.dy0},a);return function(a){var d=c(a);return b.x0=d.x,b.dx0=d.dx,b.y0=d.y,b.dy0=d.dy,L.parc(d)}},prep:function(){n.attr("transform","translate("+o[0]/2+","+.52*o[1]+")")},removeOld:function(a){i(a),a.transition().delay(0).duration(0).each("end",function(){var a=d3.select(this).datum().id;F[a]=void 0,G[a]=void 0}),NapVisLib.d3fadeAndRemoveGroups([a],B,0)},makeNew:function(a){var b=a.append("svg:g").attr("class","treeNode").style("opacity",0).call(j);return b.append("path").attr("d",L.arc).attr("id",function(a){return"arc"+a.id}).call(L.booleanSelectedAttrs).style("fill",function(a){return c(a.id)}).each(L.cstash),b.append("path").attr("d",L.parc).attr("id",function(a){return"parc"+a.id}).style("opacity",.75).call(L.propSelectedAttrs).each(L.pstash),b},redrawExistingNodes:function(a,b){a.select("path:not(.holdsSelected)").call(L.booleanSelectedAttrs).transition().delay(b).duration(C).attrTween("d",L.arcTween).each("end",L.cstash),a.select("path.holdsSelected").call(L.propSelectedAttrs).transition().delay(b).duration(C).attrTween("d",L.parcTween).each("end",L.pstash),a.select("text").style("visibility",function(a){return a.dx>1?"visible":"collapse"})}},M={Icicle:K,Sunburst:L};this.set=function(b,c){w=c.makeIndices([b.identifyingField,b.rankField]),z=w[0],A=w[1],o=NapVisLib.getWidthHeight(d3.select(a).node()),v=c},this.go=function(){u=this,d3.select(a).style("overflow","hidden"),m=d3.select(a).append("svg:svg").attr("class","visContainer").attr("pointer-events","all"),m.append("defs");var b=m.select("defs").append("pattern").attr("id",H);b.attr("x",0).attr("y",0).attr("width",4).attr("height",4).attr("patternUnits","userSpaceOnUse").attr("viewBox","0 0 4 4 ");var c=[0,2];b.selectAll("rect").data(c).enter().append("rect").attr("x",function(a,b){return 2*b}).attr("y",function(a,b){return 2*b}).attr("width",2).attr("height",2).attr("class","indHatch").classed("unselected",!0),n=m.append("svg:g").attr("class","treeSVG");var f=v.getSelectionModel().values(),g=1==f.length?e(f[0]):v.getRoot();if(void 0===g)return VESPER.log("no root defined for tree"),void 0;p=g;for(var h=d3.values(J),i=0;i<h.length;i++){h[i]}r=J.bottomUpLog,t=I.Alpha,s=M.Sunburst,d(),this.update()},this.update=function(){var a=v.getSelectionModel().values(),b=1==a.length?e(a[0]):v.getRoot();VESPER.log("Root",b,a[0]),v.countSelectedDesc(v.getRoot(),z),b=h(v.getRoot()),g(b)},this.updateVals=this.update,this.redraw=function(){var a=n.selectAll(".treeNode");s.redrawExistingNodes(a,0)},this.destroy=function(){i(n.selectAll(".treeNode")),n.selectAll(".treeNode").remove(),$(a+"controls").draggable("destroy"),v.removeView(x),v=null,p=null,q=null,F={},G={},DWCAHelper.twiceUpRemove(a)}},VESPER.tooltip=new function(){this.holdDuration=1e4,this.fadeDuration=200;var a=this;this.init=function(){var a=d3.select("body").selectAll("#vesperTooltip").data([0]).enter().append("div").attr("id","vesperTooltip").attr("class","vesperTooltip").style("visibility","hidden");a.append("h2"),a.append("p")},this.setToFade=function(){var b=d3.select("#vesperTooltip");b.transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})},this.updateText=function(b,c){var d=d3.select("#vesperTooltip");d.select("h2").text(b),d.select("p").html(c),d.style("visibility","visible").style("opacity",null).transition().duration(a.holdDuration).each("end",function(){d3.select(this).transition().duration(a.fadeDuration).style("opacity",0).each("end",function(){d3.select(this).style("visibility","hidden")})})},this.updatePosition=function(a){var b=d3.select("#vesperTooltip");b.style("top",a.pageY+10+"px").style("left",a.pageX+10+"px")}},VESPER.VisLauncher=function(a){function b(b){var c=d3.select(a).append("div").attr("class","encloser");c.append("p").attr("class","controlHeading").text("Launch Visualisation");{var d=c.selectAll("button").data(b);d.enter().append("button").attr("class","visChoice").attr("type","button").attr("id",function(a){return a.title}).text(function(a){return a.title}).on("click",function(a){return l.makeVis(a,h),!1})}}function c(){var b=d3.select(a).append("div").attr("class","encloser");b.append("p").attr("class","controlHeading").text("Current Selections"),window.requestFileSystem?b.append("button").attr("type","button").text("Save").on("click",function(){NapVisLib.prepareForWrite(NapVisLib.writeArray,h.getSelectionModel().values())}):NapVisLib.html5Lacks(b,"[Browser does not support FileWriter]"),b.append("button").attr("type","button").text("Invert Selection").on("click",function(){h.invertSelection()}),b.append("button").attr("type","button").text("Clear").on("click",function(){h.getSelectionModel().clear(),h.getSelectionModel().update()}),b.selectAll("button").style("display","block")}function d(){var b=d3.select(a).append("div").attr("class","encloser");b.append("p").attr("class","controlHeading").text("Cross-Model Comparison"),b.append("button").attr("type","button").text("Compare Model").on("click",function(){VESPER.modelBag.push({model:h}),VESPER.log("ModelBag",VESPER.modelBag),VESPER.modelBag.length>1&&(VESPER.modelComparisons.modelCoverageToSelection(VESPER.modelBag[0].model,VESPER.modelBag[1].model,VESPER.modelBag[0].model.getMetaData().vesperAdds.nameLabelField,VESPER.modelBag[1].model.getMetaData().vesperAdds.nameLabelField),VESPER.modelBag.length=0)}),b.selectAll("button").style("display","block")}function e(a){var b=a.selectAll("button.visChoice");b.style("display",function(a){var b=(h.getMetaData().fileData,h.makeIndices(a.attList)),c=NapVisLib.countNulls(b);return 0==b.length||a.matchAll&&0===c||!a.matchAll&&c<b.length?"block":"none"})}function f(a,b){a.append("button").attr("type","button").on("click",function(){b&&b.destroy&&b.destroy(),d3.select(d3.event.target).on("click",null)}).attr("title","Close this view").append("img").attr("src",VESPER.imgbase+"close.png").attr("alt","Close")}function g(a,b){a.append("button").attr("type","button").on("click",function(){var a=d3.select(b),c=a.style("display");a.style("display","none"==c?null:"none");d3.select(this).select("svg polygon");d3.select(this).select("svg polygon").attr("points","none"==c?"0,12 12,12 6,0":"0,0 12,0 6,12")}).attr("title","Toggle view visibility").append("svg").attr("width",13).attr("height",13).append("polygon").attr("points","0,12 12,12 6,0").attr("class","showHideColours")}var h,i,j,k,l=this;this.set=function(b,c){i=b.identifyingField,k=b.visChoiceData,j=NapVisLib.getWidthHeight(d3.select(a).node()),h=c},this.go=function(){var f=d3.select(a);b(k,f),e(f),c(),d()},this.update=function(){},this.updateVals=this.update,this.makeVis=function(a,b){var c=b.name+"view"+(a.multiple?b.getNextSessionModelViewID():"");c=c.replace(/\s+/g,"");var d=a.title+" "+b.name;if(d3.select("#"+c).empty()){var e=d3.select("#allVisDiv").append("div").attr("class","visWrapper").attr("id",c+"container").style("width",a.width?a.width:"50%"),h=e.append("div").attr("class","dragbar").attr("id",c+"dragBar"),i=h.append("div").attr("class","buttonBank");h.append("div").attr("class","visTitle").text(d);var j=(e.append("div").attr("class","vis").attr("id",c).style("height","null"!=a.height?a.height:"100%"),b.getMetaData().coreRowType),k=b.getMetaData().fileData,l=a.newVisFunc("#"+c);VESPER.log("newvis",l,l.set);var m=a.setupFunc()||{},n=k[j].filteredInvFieldIndex[VESPER.DWCAParser.getFilteredIdIndex(b.getMetaData())];m.identifyingField=n,l.set(m,b),b.addView(l),l.go(b),g(i,"#"+c),f(i,l),$("#"+c+"container").draggable({handle:"div.dragbar"})}},this.destroy=function(){for(var b=h.getSelectionModel().getVis(),c=0;c<b.length;c++)b[c]!==l&&(b[c].destroy&&b[c].destroy(),h.removeView(b[c]));var d=$.inArray(h,VESPER.modelBag);d>=0&&(VESPER.modelBag[d]=void 0,VESPER.modelBag=VESPER.modelBag.splice(d,1),VESPER.modelBag.length=0),DWCAHelper.recurseClearEvents(d3.select(a)),h.removeView(l),h.getSelectionModel().clear(),h=null,DWCAHelper.twiceUpRemove(a)}};